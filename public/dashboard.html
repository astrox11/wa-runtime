<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Whatsaly Dashboard">
  <title>Dashboard - Whatsaly</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'gh-bg': 'var(--gh-bg)',
            'gh-bg-secondary': 'var(--gh-bg-secondary)',
            'gh-bg-tertiary': 'var(--gh-bg-tertiary)',
            'gh-border': 'var(--gh-border)',
            'gh-text': 'var(--gh-text)',
            'gh-text-secondary': 'var(--gh-text-secondary)',
            'gh-text-muted': 'var(--gh-text-muted)',
            'gh-link': 'var(--gh-link)',
            'gh-accent': 'var(--gh-accent)',
            'gh-success': 'var(--gh-success)',
            'gh-success-subtle': 'var(--gh-success-subtle)',
            'gh-warning': 'var(--gh-warning)',
            'gh-warning-subtle': 'var(--gh-warning-subtle)',
            'gh-danger': 'var(--gh-danger)',
            'gh-danger-subtle': 'var(--gh-danger-subtle)',
          },
          borderRadius: { 'gh': '6px' },
          fontFamily: { 'sans': ['Plus Jakarta Sans', 'system-ui', 'sans-serif'] },
        }
      }
    }
  </script>
  <script>
    (function() {
      const storedTheme = localStorage.getItem('theme');
      const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (storedTheme === 'dark' || (!storedTheme && systemDark)) {
        document.documentElement.classList.add('dark');
      }
    })();
  </script>
  <style>
    :root {
      --gh-bg: #ffffff; --gh-bg-secondary: #f6f8fa; --gh-bg-tertiary: #eaeef2;
      --gh-border: #d0d7de; --gh-text: #1f2328; --gh-text-secondary: #656d76;
      --gh-text-muted: #8c959f; --gh-link: #0969da; --gh-accent: #0969da;
      --gh-success: #1a7f37; --gh-success-subtle: #dafbe1;
      --gh-warning: #9a6700; --gh-warning-subtle: #fff8c5;
      --gh-danger: #cf222e; --gh-danger-subtle: #ffebe9;
    }
    .dark {
      --gh-bg: #0d1117; --gh-bg-secondary: #161b22; --gh-bg-tertiary: #21262d;
      --gh-border: #30363d; --gh-text: #e6edf3; --gh-text-secondary: #8b949e;
      --gh-text-muted: #6e7681; --gh-link: #58a6ff; --gh-accent: #58a6ff;
      --gh-success: #3fb950; --gh-success-subtle: #12261e;
      --gh-warning: #d29922; --gh-warning-subtle: #2d2413;
      --gh-danger: #f85149; --gh-danger-subtle: #2d1b1b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; }
    @keyframes ghost-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .animate-ghost-pulse { animation: ghost-pulse 1.5s ease-in-out infinite; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--gh-border); border-radius: 4px; }
    [data-tooltip] { position: relative; }
    .custom-tooltip { position: absolute; z-index: 9999; padding: 6px 10px; font-size: 12px; font-weight: 500; color: #fff; background: #24292f; border-radius: 6px; white-space: nowrap; pointer-events: none; opacity: 0; transform: translateX(-50%) translateY(4px); transition: opacity 0.15s, transform 0.15s; bottom: 100%; left: 50%; margin-bottom: 6px; }
    .custom-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #24292f transparent transparent transparent; }
    .dark .custom-tooltip { background: #f0f0f0; color: #24292f; }
    .dark .custom-tooltip::after { border-color: #f0f0f0 transparent transparent transparent; }
    [data-tooltip]:hover .custom-tooltip { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body class="bg-gh-bg font-sans text-gh-text min-h-screen antialiased">
  <main class="max-w-5xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between mb-4">
      <a href="/" class="inline-flex items-center gap-1 text-sm text-gh-link hover:underline">
        <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor"><path d="M7.78 12.53a.75.75 0 0 1-1.06 0L2.47 8.28a.75.75 0 0 1 0-1.06l4.25-4.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L4.81 7h7.44a.75.75 0 0 1 0 1.5H4.81l2.97 2.97a.75.75 0 0 1 0 1.06Z"></path></svg>
        Sessions
      </a>
      <span id="session-status" class="flex items-center gap-2 px-3 py-1 rounded-gh bg-gh-bg-secondary border border-gh-border text-xs">
        <div class="w-3 h-3 bg-gh-bg-tertiary rounded-full animate-ghost-pulse"></div>
        <span>Loading...</span>
      </span>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <div class="flex items-center gap-2 mb-1">
          <svg class="w-4 h-4 text-gh-text-secondary" viewBox="0 0 16 16" fill="currentColor"><path d="M10.561 8.073a6.005 6.005 0 0 1 3.432 5.142.75.75 0 1 1-1.498.07 4.5 4.5 0 0 0-8.99 0 .75.75 0 0 1-1.498-.07 6.004 6.004 0 0 1 3.431-5.142 3.999 3.999 0 1 1 5.123 0Z"></path></svg>
          <p class="text-xs text-gh-text-secondary">User</p>
        </div>
        <p id="user-name" class="text-base font-semibold text-gh-text truncate">
          <span class="inline-block w-20 h-4 bg-gh-bg-tertiary rounded animate-ghost-pulse"></span>
        </p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <div class="flex items-center gap-2 mb-1">
          <svg class="w-4 h-4 text-gh-text-secondary" viewBox="0 0 16 16" fill="currentColor"><path d="M1.75 1h8.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 10.25 10H7.061l-2.574 2.573A1.458 1.458 0 0 1 2 11.543V10h-.25A1.75 1.75 0 0 1 0 8.25v-5.5C0 1.784.784 1 1.75 1Z"></path></svg>
          <p class="text-xs text-gh-text-secondary">Messages</p>
        </div>
        <p id="messages-count" class="text-base font-semibold text-gh-text">0</p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <div class="flex items-center gap-2 mb-1">
          <svg class="w-4 h-4 text-gh-text-secondary" viewBox="0 0 16 16" fill="currentColor"><path d="M4.75 0h6.5a.75.75 0 0 1 0 1.5h-6.5a.75.75 0 0 1 0-1.5ZM2 4.75A.75.75 0 0 1 2.75 4h10.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 4.75Z"></path></svg>
          <p class="text-xs text-gh-text-secondary">Created</p>
        </div>
        <p id="created-date" class="text-base font-semibold text-gh-text">--</p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <div class="flex items-center gap-2 mb-1">
          <svg class="w-4 h-4 text-gh-text-secondary" viewBox="0 0 16 16" fill="currentColor"><path d="M5.75 7.5a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75Zm4.5 0a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75Z"></path><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0Z"></path></svg>
          <p class="text-xs text-gh-text-secondary">Phone</p>
        </div>
        <p id="phone-number" class="text-base font-semibold text-gh-text truncate">--</p>
      </div>
    </div>

    <!-- Info Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <!-- Health Card -->
      <div class="bg-gh-bg border border-gh-border rounded-gh">
        <div class="p-4 border-b border-gh-border flex items-center gap-2">
          <svg class="w-4 h-4 text-gh-text-secondary" viewBox="0 0 16 16" fill="currentColor"><path d="M9.585.52a2.678 2.678 0 0 0-3.17 0l-.928.68a1.178 1.178 0 0 1-.518.215L3.83 1.59a2.678 2.678 0 0 0-2.24 2.24l-.175 1.14a1.178 1.178 0 0 1-.215.518l-.68.928a2.678 2.678 0 0 0 0 3.17l.68.928c.113.153.186.33.215.518l.175 1.138a2.678 2.678 0 0 0 2.24 2.24l1.138.175c.187.029.365.102.518.215l.928.68a2.678 2.678 0 0 0 3.17 0l.928-.68a1.17 1.17 0 0 1 .518-.215l1.138-.175a2.678 2.678 0 0 0 2.241-2.241l.175-1.138c.029-.187.102-.365.215-.518l.68-.928a2.678 2.678 0 0 0 0-3.17l-.68-.928a1.179 1.179 0 0 1-.215-.518L14.41 3.83a2.678 2.678 0 0 0-2.24-2.24l-1.138-.175a1.179 1.179 0 0 1-.518-.215ZM11.28 6.78l-3.25 3.25a.75.75 0 0 1-1.06 0L4.72 7.78a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l1.47 1.47 2.72-2.72a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042Z"></path></svg>
          <h3 class="text-sm font-semibold text-gh-text">Status</h3>
        </div>
        <div class="p-4">
          <div id="health-indicator" class="flex items-center gap-3 mb-3">
            <div id="health-badge" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gh-success-subtle">
              <svg id="health-icon" class="w-4 h-4 text-gh-success" viewBox="0 0 16 16" fill="currentColor"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path></svg>
              <span id="health-text" class="text-sm font-medium text-gh-success">Connected</span>
            </div>
          </div>
          <div id="health-details" class="space-y-2 text-sm">
            <div class="flex items-center gap-2">
              <svg class="w-3 h-3 text-gh-success" viewBox="0 0 16 16" fill="currentColor"><path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"></path><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"></path></svg>
              <span id="health-ws" class="text-gh-text-secondary">WebSocket: <span class="text-gh-text">Active</span></span>
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-3 h-3 text-gh-success" viewBox="0 0 16 16" fill="currentColor"><path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"></path><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"></path></svg>
              <span id="health-session" class="text-gh-text-secondary">Session: <span class="text-gh-text">Authenticated</span></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Runtime Card -->
      <div class="bg-gh-bg border border-gh-border rounded-gh">
        <div class="p-4 border-b border-gh-border flex items-center gap-2">
          <svg class="w-4 h-4 text-gh-text-secondary" viewBox="0 0 16 16" fill="currentColor"><path d="M2 5.5a3.5 3.5 0 1 1 5.898 2.549 5.508 5.508 0 0 1 3.034 4.084.75.75 0 1 1-1.482.235 4 4 0 0 0-7.9 0 .75.75 0 0 1-1.482-.236A5.507 5.507 0 0 1 3.102 8.05 3.493 3.493 0 0 1 2 5.5Z"></path></svg>
          <h3 class="text-sm font-semibold text-gh-text">Runtime</h3>
        </div>
        <div class="p-4 space-y-2 text-sm">
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Total Sessions</span>
            <span id="total-sessions" class="text-gh-text font-medium">--</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Active Sessions</span>
            <span id="active-sessions" class="text-gh-text font-medium">--</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Total Messages</span>
            <span id="total-messages" class="text-gh-text font-medium">--</span>
          </div>
        </div>
      </div>

      <!-- Session Info Card -->
      <div class="bg-gh-bg border border-gh-border rounded-gh">
        <div class="p-4 border-b border-gh-border flex items-center gap-2">
          <svg class="w-4 h-4 text-gh-text-secondary" viewBox="0 0 16 16" fill="currentColor"><path d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Z"></path></svg>
          <h3 class="text-sm font-semibold text-gh-text">Session Info</h3>
        </div>
        <div class="p-4 space-y-2 text-sm">
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Version</span>
            <span id="runtime-version" class="text-gh-text font-medium">--</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Session ID</span>
            <span id="session-id-display" class="text-gh-text font-mono text-xs bg-gh-bg-secondary px-1.5 py-0.5 rounded cursor-pointer" data-tooltip="session-id">--<span class="custom-tooltip" id="session-id-tooltip">--</span></span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Messages Sent</span>
            <span id="messages-sent" class="text-gh-text font-medium">0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Activity Settings -->
    <div class="bg-gh-bg border border-gh-border rounded-gh mb-6">
      <div class="p-4 border-b border-gh-border">
        <h2 class="text-sm font-semibold text-gh-text flex items-center gap-2">
          <svg class="w-4 h-4 text-gh-text-secondary" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0a8.2 8.2 0 0 1 .701.031C9.444.095 9.99.645 10.16 1.29l.288 1.107c.018.066.079.158.212.224.231.114.454.243.668.386.123.082.233.09.299.071l1.103-.303c.644-.176 1.392.021 1.82.63.27.385.506.792.704 1.218.315.675.111 1.422-.364 1.891l-.814.806c-.049.048-.098.147-.088.294.016.257.016.515 0 .772-.01.147.04.246.088.294l.814.806c.475.469.679 1.216.364 1.891a7.977 7.977 0 0 1-.704 1.217c-.428.61-1.176.807-1.82.63l-1.102-.302c-.067-.019-.177-.011-.3.071a5.909 5.909 0 0 1-.668.386c-.133.066-.194.158-.212.224l-.288 1.107c-.17.645-.715 1.195-1.458 1.26a8.006 8.006 0 0 1-1.402 0c-.743-.065-1.289-.615-1.458-1.26l-.289-1.106c-.018-.066-.079-.158-.212-.225a5.893 5.893 0 0 1-.668-.386c-.123-.082-.233-.09-.299-.071l-1.103.303c-.644.176-1.392-.021-1.82-.63a8.004 8.004 0 0 1-.704-1.217c-.315-.675-.111-1.422.363-1.891l.815-.806c.05-.048.098-.147.088-.294a6.854 6.854 0 0 1 0-.772c.01-.147-.04-.246-.088-.294l-.815-.806C.635 6.045.431 5.298.746 4.623a7.92 7.92 0 0 1 .704-1.217c.428-.61 1.176-.807 1.82-.63l1.102.302c.067.019.177.011.3-.071.214-.143.437-.272.668-.386.133-.066.194-.158.212-.224l.289-1.106C6.009.645 6.556.095 7.299.03 7.53.01 7.764 0 8 0Z"></path></svg>
          Activity Settings
        </h2>
      </div>
      <div class="p-4 space-y-3" id="settings-list">
        <div class="flex items-center justify-between p-3 bg-gh-bg-secondary rounded-gh">
          <span class="text-sm font-medium text-gh-text">Always Online</span>
          <button id="toggle-auto_always_online" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gh-bg-tertiary transition-colors" role="switch" aria-checked="false" data-setting="auto_always_online">
            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow transition translate-x-0"></span>
          </button>
        </div>
        <div class="flex items-center justify-between p-3 bg-gh-bg-secondary rounded-gh">
          <span class="text-sm font-medium text-gh-text">Typing Indicator</span>
          <button id="toggle-auto_typing" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gh-bg-tertiary transition-colors" role="switch" aria-checked="false" data-setting="auto_typing">
            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow transition translate-x-0"></span>
          </button>
        </div>
        <div class="flex items-center justify-between p-3 bg-gh-bg-secondary rounded-gh">
          <span class="text-sm font-medium text-gh-text">Auto Read Messages</span>
          <button id="toggle-auto_read_messages" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gh-bg-tertiary transition-colors" role="switch" aria-checked="false" data-setting="auto_read_messages">
            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow transition translate-x-0"></span>
          </button>
        </div>
        <div class="flex items-center justify-between p-3 bg-gh-bg-secondary rounded-gh">
          <span class="text-sm font-medium text-gh-text">Auto Reject Calls</span>
          <button id="toggle-auto_reject_calls" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gh-bg-tertiary transition-colors" role="switch" aria-checked="false" data-setting="auto_reject_calls">
            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow transition translate-x-0"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Groups Section -->
    <div class="bg-gh-bg border border-gh-border rounded-gh mb-6">
      <div class="p-4 border-b border-gh-border flex items-center justify-between">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-gh-text-secondary" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="5.5" cy="5.5" r="2.5"></circle><circle cx="10.5" cy="5.5" r="2.5"></circle><path d="M8 8c1.66 0 3 1.34 3 3v2H5v-2c0-1.66 1.34-3 3-3z"></path></svg>
          <h2 class="text-sm font-semibold text-gh-text">Groups</h2>
          <span id="groups-count" class="text-xs text-gh-text-muted">(0)</span>
        </div>
        <button id="refresh-groups-btn" class="p-1.5 text-gh-text-secondary hover:text-gh-text rounded-gh hover:bg-gh-bg-tertiary" data-tooltip="Refresh Groups">
          <span class="custom-tooltip">Refresh Groups</span>
          <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1.5 8a6.5 6.5 0 0111.5-4.15M14.5 8A6.5 6.5 0 013 12.15"></path><path d="M1 4v3.5h3.5M15 12v-3.5h-3.5"></path></svg>
        </button>
      </div>
      <div id="groups-list" class="divide-y divide-gh-border max-h-80 overflow-y-auto">
        <div class="p-6 text-center">
          <div class="space-y-2 max-w-[200px] mx-auto">
            <div class="h-4 bg-gh-bg-tertiary rounded animate-ghost-pulse"></div>
            <div class="h-4 bg-gh-bg-tertiary rounded animate-ghost-pulse w-3/4 mx-auto"></div>
          </div>
          <p class="text-xs text-gh-text-muted mt-3">Loading groups...</p>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-end gap-2">
      <button id="refresh-btn" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-gh bg-gh-bg-secondary border border-gh-border text-gh-text hover:bg-gh-bg-tertiary transition-colors">
        <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor"><path d="M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z"></path></svg>
        Refresh
      </button>
      <button id="disconnect-btn" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-gh border border-gh-danger text-gh-danger hover:bg-gh-danger-subtle transition-colors">
        <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor"><path d="M11 1.75V3h2.25a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1 0-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75ZM4.496 6.675l.66 6.6a.25.25 0 0 0 .249.225h5.19a.25.25 0 0 0 .249-.225l.66-6.6a.75.75 0 0 1 1.492.149l-.66 6.6A1.748 1.748 0 0 1 10.595 15h-5.19a1.75 1.75 0 0 1-1.741-1.575l-.66-6.6a.75.75 0 1 1 1.492-.15ZM6.5 1.75V3h3V1.75a.25.25 0 0 0-.25-.25h-2.5a.25.25 0 0 0-.25.25Z"></path></svg>
        Disconnect
      </button>
    </div>
  </main>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('id');
    
    if (!sessionId) {
      window.location.href = '/';
    }

    const sessionStatus = document.getElementById('session-status');
    const userName = document.getElementById('user-name');
    const messagesCount = document.getElementById('messages-count');
    const messagesSent = document.getElementById('messages-sent');
    const createdDate = document.getElementById('created-date');
    const phoneNumber = document.getElementById('phone-number');
    const sessionIdDisplay = document.getElementById('session-id-display');
    const totalSessions = document.getElementById('total-sessions');
    const activeSessions = document.getElementById('active-sessions');
    const totalMessages = document.getElementById('total-messages');
    const runtimeVersion = document.getElementById('runtime-version');
    const healthBadge = document.getElementById('health-badge');
    const healthText = document.getElementById('health-text');
    const healthIcon = document.getElementById('health-icon');

    function hashSessionId(id) {
      if (!id || id.length <= 12) return id;
      return `${id.substring(0, 8)}...${id.substring(id.length - 4)}`;
    }

    if (sessionIdDisplay) {
      sessionIdDisplay.childNodes[0].textContent = hashSessionId(sessionId);
      const tooltipEl = document.getElementById('session-id-tooltip');
      if (tooltipEl) tooltipEl.textContent = sessionId;
    }

    let ws = null;
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}/ws/stats`);
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'stats' && data.data) {
            if (data.data.totalSessions !== undefined && totalSessions) totalSessions.textContent = data.data.totalSessions;
            if (data.data.activeSessions !== undefined && activeSessions) activeSessions.textContent = data.data.activeSessions;
            if (data.data.totalMessages !== undefined && totalMessages) totalMessages.textContent = data.data.totalMessages;
            if (data.data.sessions) {
              const session = data.data.sessions.find(s => s.id === sessionId);
              if (session) updateSessionInfo(session);
            }
          }
        } catch (e) { console.error('WS error:', e); }
      };
      ws.onclose = () => setTimeout(connectWebSocket, 3000);
    }
    connectWebSocket();

    function updateSessionInfo(session) {
      const statusEl = sessionStatus.querySelector('span');
      const dotEl = sessionStatus.querySelector('div');
      
      const isConnected = session.status === 'connected' || session.status === 'active';
      
      if (statusEl) statusEl.textContent = session.status || 'unknown';
      if (dotEl) {
        dotEl.classList.remove('animate-ghost-pulse', 'bg-gh-bg-tertiary');
        dotEl.classList.add(isConnected ? 'bg-gh-success' : session.status === 'paused' ? 'bg-gh-warning' : 'bg-gh-danger');
      }
      
      if (userName) userName.textContent = session.user_info?.name || session.phone_number || 'Unknown';
      if (phoneNumber) phoneNumber.textContent = session.phone_number || '--';
      if (createdDate && session.created_at) {
        const date = new Date(typeof session.created_at === 'number' ? session.created_at : session.created_at);
        createdDate.textContent = date.toLocaleDateString();
      }
      if (session.stats) {
        if (messagesCount) messagesCount.textContent = (session.stats.messagesReceived || 0) + (session.stats.messagesSent || 0);
        if (messagesSent) messagesSent.textContent = session.stats.messagesSent || 0;
      }
      
      updateHealthStatus(isConnected);
    }

    function updateHealthStatus(isConnected) {
      if (healthBadge && healthText && healthIcon) {
        if (isConnected) {
          healthBadge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-gh-success-subtle';
          healthText.className = 'text-sm font-medium text-gh-success';
          healthText.textContent = 'Connected';
          healthIcon.className = 'w-4 h-4 text-gh-success';
        } else {
          healthBadge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-gh-warning-subtle';
          healthText.className = 'text-sm font-medium text-gh-warning';
          healthText.textContent = 'Disconnected';
          healthIcon.className = 'w-4 h-4 text-gh-warning';
        }
      }
    }

    document.getElementById('refresh-btn')?.addEventListener('click', () => {
      location.reload();
    });

    document.getElementById('disconnect-btn')?.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to disconnect this session?')) return;
      try {
        await fetch(`/api/sessions/${sessionId}`, { method: 'DELETE' });
        window.location.href = '/';
      } catch (e) { alert('Failed to disconnect'); }
    });

    let currentSettings = {};
    
    async function loadSettings() {
      try {
        const response = await fetch(`/api/sessions/${sessionId}/settings`);
        const result = await response.json();
        if (result.success && result.data) {
          currentSettings = result.data;
          updateSettingsUI(result.data);
        }
      } catch (e) { console.error('Failed to load settings:', e); }
    }

    function updateSettingsUI(settings) {
      const keys = ['auto_always_online', 'auto_typing', 'auto_read_messages', 'auto_reject_calls'];
      keys.forEach(key => {
        const toggle = document.getElementById(`toggle-${key}`);
        if (toggle) {
          const isEnabled = settings[key];
          toggle.setAttribute('aria-checked', String(isEnabled));
          toggle.classList.toggle('bg-gh-success', isEnabled);
          toggle.classList.toggle('bg-gh-bg-tertiary', !isEnabled);
          const span = toggle.querySelector('span');
          if (span) {
            span.classList.toggle('translate-x-5', isEnabled);
            span.classList.toggle('translate-x-0', !isEnabled);
          }
        }
      });
    }

    document.querySelectorAll('[data-setting]').forEach(toggle => {
      toggle.addEventListener('click', async () => {
        const key = toggle.getAttribute('data-setting');
        const newValue = !currentSettings[key];
        try {
          const response = await fetch(`/api/sessions/${sessionId}/settings`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [key]: newValue })
          });
          const result = await response.json();
          if (result.success && result.data) {
            currentSettings = result.data;
            updateSettingsUI(result.data);
          }
        } catch (e) { console.error('Failed to update setting:', e); }
      });
    });

    loadSettings();

    const groupsList = document.getElementById('groups-list');
    const groupsCount = document.getElementById('groups-count');
    const refreshGroupsBtn = document.getElementById('refresh-groups-btn');

    async function loadGroups() {
      try {
        const response = await fetch(`/api/sessions/${sessionId}/groups`);
        const result = await response.json();
        if (result.success && result.data) {
          renderGroups(result.data.groups || []);
        } else {
          if (groupsList) groupsList.innerHTML = '<div class="p-4 text-center text-sm text-gh-text-muted">Failed to load groups</div>';
        }
      } catch (e) {
        console.error('Failed to load groups:', e);
        if (groupsList) groupsList.innerHTML = '<div class="p-4 text-center text-sm text-gh-text-muted">Failed to load groups</div>';
      }
    }

    function renderGroups(groups) {
      if (groupsCount) groupsCount.textContent = `(${groups.length})`;
      if (!groupsList) return;
      
      if (!groups || groups.length === 0) {
        groupsList.innerHTML = '<div class="p-4 text-center text-sm text-gh-text-muted">No groups found</div>';
        return;
      }

      groupsList.innerHTML = groups.map(g => {
        const name = g.subject || 'Unknown Group';
        const initial = name.charAt(0).toUpperCase();
        const memberCount = g.participantCount || g.size || 0;
        const isCommunity = g.isCommunity || false;
        
        return `
          <div class="p-3 flex items-center justify-between hover:bg-gh-bg-secondary transition-colors">
            <div class="flex items-center gap-3 min-w-0">
              <div class="w-10 h-10 rounded-full bg-gh-bg-tertiary flex items-center justify-center flex-shrink-0">
                <span class="text-sm font-medium text-gh-text">${escapeHtml(initial)}</span>
              </div>
              <div class="min-w-0">
                <p class="text-sm font-medium text-gh-text truncate">${escapeHtml(name)}</p>
                <p class="text-xs text-gh-text-muted">${memberCount} members ${isCommunity ? 'â€¢ Community' : ''}</p>
              </div>
            </div>
            <div class="flex items-center gap-1">
              <button data-group-id="${escapeHtml(g.id)}" data-action="info" class="p-1.5 text-gh-text-secondary hover:text-gh-link hover:bg-gh-bg-tertiary rounded" data-tooltip="Info">
                <span class="custom-tooltip">View Info</span>
                <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><circle cx="8" cy="8" r="6.5"></circle><path d="M8 11V8M8 5.5v0"></path></svg>
              </button>
              <button data-group-id="${escapeHtml(g.id)}" data-action="leave" class="p-1.5 text-gh-text-secondary hover:text-gh-danger hover:bg-gh-bg-tertiary rounded" data-tooltip="Leave">
                <span class="custom-tooltip">Leave Group</span>
                <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M2.5 2.5h4.5v11h-4.5a1 1 0 01-1-1v-9a1 1 0 011-1z"></path><path d="M10 11l4-3-4-3M7 8h7"></path></svg>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showGroupInfo(meta) {
      const subject = meta.subject || 'Unknown';
      const size = meta.size || 0;
      const desc = meta.desc || 'None';
      const isCommunity = meta.isCommunity ? 'Yes' : 'No';
      alert('Group: ' + subject + '\nMembers: ' + size + '\nDescription: ' + desc + '\nCommunity: ' + isCommunity);
    }

    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-group-id]');
      if (!btn) return;
      
      const groupId = btn.dataset.groupId;
      const action = btn.dataset.action;
      
      if (action === 'leave') {
        if (!confirm('Are you sure you want to leave this group?')) return;
        try {
          const res = await fetch(`/api/sessions/${sessionId}/groups/${encodeURIComponent(groupId)}/action`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'leave' })
          });
          const result = await res.json();
          if (result.success) {
            loadGroups();
          } else {
            alert(result.error || 'Failed to leave group');
          }
        } catch (e) {
          alert('Failed to leave group');
        }
      } else if (action === 'info') {
        try {
          const res = await fetch(`/api/sessions/${sessionId}/groups/${encodeURIComponent(groupId)}/metadata`);
          const result = await res.json();
          if (result.success && result.data) {
            showGroupInfo(result.data);
          } else {
            alert(result.error || 'Failed to get group info');
          }
        } catch (e) {
          alert('Failed to get group info');
        }
      }
    });

    refreshGroupsBtn?.addEventListener('click', () => {
      if (groupsList) groupsList.innerHTML = '<div class="p-4 text-center text-sm text-gh-text-muted">Loading...</div>';
      loadGroups();
    });

    loadGroups();
    
    fetch('/api/stats/full').then(r => r.json()).then(res => {
      if (res.success && res.data) {
        if (res.data.totalSessions !== undefined && totalSessions) totalSessions.textContent = res.data.totalSessions;
        if (res.data.activeSessions !== undefined && activeSessions) activeSessions.textContent = res.data.activeSessions;
        if (res.data.totalMessages !== undefined && totalMessages) totalMessages.textContent = res.data.totalMessages;
        if (res.data.sessions) {
          const session = res.data.sessions.find(s => s.id === sessionId);
          if (session) updateSessionInfo(session);
        }
      }
    }).catch(() => {});
  </script>
</body>
</html>
