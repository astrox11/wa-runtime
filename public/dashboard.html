<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Whatsaly Dashboard">
  <title>Dashboard - Whatsaly</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'gh-bg': 'var(--gh-bg)',
            'gh-bg-secondary': 'var(--gh-bg-secondary)',
            'gh-bg-tertiary': 'var(--gh-bg-tertiary)',
            'gh-border': 'var(--gh-border)',
            'gh-text': 'var(--gh-text)',
            'gh-text-secondary': 'var(--gh-text-secondary)',
            'gh-text-muted': 'var(--gh-text-muted)',
            'gh-link': 'var(--gh-link)',
            'gh-accent': 'var(--gh-accent)',
            'gh-success': 'var(--gh-success)',
            'gh-success-subtle': 'var(--gh-success-subtle)',
            'gh-warning': 'var(--gh-warning)',
            'gh-warning-subtle': 'var(--gh-warning-subtle)',
            'gh-danger': 'var(--gh-danger)',
            'gh-danger-subtle': 'var(--gh-danger-subtle)',
          },
          borderRadius: { 'gh': '6px' },
          fontFamily: { 'sans': ['Plus Jakarta Sans', 'system-ui', 'sans-serif'] },
        }
      }
    }
  </script>
  <script>
    (function() {
      const storedTheme = localStorage.getItem('theme');
      const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (storedTheme === 'dark' || (!storedTheme && systemDark)) {
        document.documentElement.classList.add('dark');
      }
    })();
  </script>
  <style>
    :root {
      --gh-bg: #ffffff; --gh-bg-secondary: #f6f8fa; --gh-bg-tertiary: #eaeef2;
      --gh-border: #d0d7de; --gh-text: #1f2328; --gh-text-secondary: #656d76;
      --gh-text-muted: #8c959f; --gh-link: #0969da; --gh-accent: #0969da;
      --gh-success: #1a7f37; --gh-success-subtle: #dafbe1;
      --gh-warning: #9a6700; --gh-warning-subtle: #fff8c5;
      --gh-danger: #cf222e; --gh-danger-subtle: #ffebe9;
    }
    .dark {
      --gh-bg: #0d1117; --gh-bg-secondary: #161b22; --gh-bg-tertiary: #21262d;
      --gh-border: #30363d; --gh-text: #e6edf3; --gh-text-secondary: #8b949e;
      --gh-text-muted: #6e7681; --gh-link: #58a6ff; --gh-accent: #58a6ff;
      --gh-success: #3fb950; --gh-success-subtle: #12261e;
      --gh-warning: #d29922; --gh-warning-subtle: #2d2413;
      --gh-danger: #f85149; --gh-danger-subtle: #2d1b1b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; }
    @keyframes ghost-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .animate-ghost-pulse { animation: ghost-pulse 1.5s ease-in-out infinite; }
  </style>
</head>
<body class="bg-gh-bg font-sans text-gh-text min-h-screen antialiased">
  <main class="max-w-5xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between mb-4">
      <a href="/" class="inline-flex items-center gap-1 text-sm text-gh-link hover:underline">
        <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor"><path d="M7.78 12.53a.75.75 0 0 1-1.06 0L2.47 8.28a.75.75 0 0 1 0-1.06l4.25-4.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L4.81 7h7.44a.75.75 0 0 1 0 1.5H4.81l2.97 2.97a.75.75 0 0 1 0 1.06Z"></path></svg>
        Sessions
      </a>
      <span id="session-status" class="flex items-center gap-2 px-3 py-1 rounded-gh bg-gh-bg-secondary border border-gh-border text-xs">
        <div class="w-3 h-3 bg-gh-bg-tertiary rounded-full animate-ghost-pulse"></div>
        <span>Loading...</span>
      </span>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <div class="flex items-center gap-2 mb-1">
          <svg class="w-4 h-4 text-gh-text-secondary" viewBox="0 0 16 16" fill="currentColor"><path d="M10.561 8.073a6.005 6.005 0 0 1 3.432 5.142.75.75 0 1 1-1.498.07 4.5 4.5 0 0 0-8.99 0 .75.75 0 0 1-1.498-.07 6.004 6.004 0 0 1 3.431-5.142 3.999 3.999 0 1 1 5.123 0Z"></path></svg>
          <p class="text-xs text-gh-text-secondary">User</p>
        </div>
        <p id="user-name" class="text-base font-semibold text-gh-text truncate">
          <span class="inline-block w-20 h-4 bg-gh-bg-tertiary rounded animate-ghost-pulse"></span>
        </p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <div class="flex items-center gap-2 mb-1">
          <svg class="w-4 h-4 text-gh-text-secondary" viewBox="0 0 16 16" fill="currentColor"><path d="M1.75 1h8.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 10.25 10H7.061l-2.574 2.573A1.458 1.458 0 0 1 2 11.543V10h-.25A1.75 1.75 0 0 1 0 8.25v-5.5C0 1.784.784 1 1.75 1Z"></path></svg>
          <p class="text-xs text-gh-text-secondary">Messages</p>
        </div>
        <p id="messages-count" class="text-base font-semibold text-gh-text">0</p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <div class="flex items-center gap-2 mb-1">
          <svg class="w-4 h-4 text-gh-text-secondary" viewBox="0 0 16 16" fill="currentColor"><path d="M4.75 0h6.5a.75.75 0 0 1 0 1.5h-6.5a.75.75 0 0 1 0-1.5ZM2 4.75A.75.75 0 0 1 2.75 4h10.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 4.75Z"></path></svg>
          <p class="text-xs text-gh-text-secondary">Created</p>
        </div>
        <p id="created-date" class="text-base font-semibold text-gh-text">--</p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <div class="flex items-center gap-2 mb-1">
          <svg class="w-4 h-4 text-gh-text-secondary" viewBox="0 0 16 16" fill="currentColor"><path d="M5.75 7.5a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75Zm4.5 0a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75Z"></path><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0Z"></path></svg>
          <p class="text-xs text-gh-text-secondary">Phone</p>
        </div>
        <p id="phone-number" class="text-base font-semibold text-gh-text truncate">--</p>
      </div>
    </div>

    <!-- Actions -->
    <div class="bg-gh-bg border border-gh-border rounded-gh mb-6">
      <div class="p-4 border-b border-gh-border">
        <h2 class="text-sm font-semibold text-gh-text">Session Actions</h2>
      </div>
      <div class="p-4 flex flex-wrap gap-3">
        <button id="refresh-btn" class="px-4 py-2 text-sm font-medium text-gh-text bg-gh-bg-secondary border border-gh-border rounded-gh hover:bg-gh-bg-tertiary transition-colors">
          Refresh
        </button>
        <button id="logout-btn" class="px-4 py-2 text-sm font-medium text-gh-danger bg-gh-danger-subtle border border-gh-danger rounded-gh hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors">
          Logout Session
        </button>
        <button id="delete-btn" class="px-4 py-2 text-sm font-medium text-white bg-gh-danger rounded-gh hover:bg-red-700 transition-colors">
          Delete Session
        </button>
      </div>
    </div>

    <!-- Activity Settings -->
    <div class="bg-gh-bg border border-gh-border rounded-gh">
      <div class="p-4 border-b border-gh-border">
        <h2 class="text-sm font-semibold text-gh-text">Activity Settings</h2>
      </div>
      <div class="p-4 space-y-3" id="settings-list">
        <div class="flex items-center justify-between p-3 bg-gh-bg-secondary rounded-gh">
          <span class="text-sm font-medium text-gh-text">Always Online</span>
          <button id="toggle-auto_always_online" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gh-bg-tertiary transition-colors" role="switch" aria-checked="false" data-setting="auto_always_online">
            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow transition translate-x-0"></span>
          </button>
        </div>
        <div class="flex items-center justify-between p-3 bg-gh-bg-secondary rounded-gh">
          <span class="text-sm font-medium text-gh-text">Typing Indicator</span>
          <button id="toggle-auto_typing" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gh-bg-tertiary transition-colors" role="switch" aria-checked="false" data-setting="auto_typing">
            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow transition translate-x-0"></span>
          </button>
        </div>
        <div class="flex items-center justify-between p-3 bg-gh-bg-secondary rounded-gh">
          <span class="text-sm font-medium text-gh-text">Auto Read Messages</span>
          <button id="toggle-auto_read_messages" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gh-bg-tertiary transition-colors" role="switch" aria-checked="false" data-setting="auto_read_messages">
            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow transition translate-x-0"></span>
          </button>
        </div>
        <div class="flex items-center justify-between p-3 bg-gh-bg-secondary rounded-gh">
          <span class="text-sm font-medium text-gh-text">Auto Reject Calls</span>
          <button id="toggle-auto_reject_calls" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gh-bg-tertiary transition-colors" role="switch" aria-checked="false" data-setting="auto_reject_calls">
            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow transition translate-x-0"></span>
          </button>
        </div>
      </div>
    </div>
  </main>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('id');
    
    if (!sessionId) {
      window.location.href = '/';
    }

    const sessionStatus = document.getElementById('session-status');
    const userName = document.getElementById('user-name');
    const messagesCount = document.getElementById('messages-count');
    const createdDate = document.getElementById('created-date');
    const phoneNumber = document.getElementById('phone-number');

    let ws = null;
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}/ws/stats`);
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'stats' && data.data?.sessions) {
            const session = data.data.sessions.find(s => s.id === sessionId);
            if (session) updateSessionInfo(session);
          }
        } catch (e) { console.error('WS error:', e); }
      };
      ws.onclose = () => setTimeout(connectWebSocket, 3000);
    }
    connectWebSocket();

    function updateSessionInfo(session) {
      const statusEl = sessionStatus.querySelector('span');
      const dotEl = sessionStatus.querySelector('div');
      
      if (statusEl) statusEl.textContent = session.status || 'unknown';
      if (dotEl) {
        dotEl.classList.remove('animate-ghost-pulse', 'bg-gh-bg-tertiary');
        dotEl.classList.add(session.status === 'connected' ? 'bg-gh-success' : 'bg-gh-warning');
      }
      
      if (userName) userName.textContent = session.user_info?.name || session.phone_number || 'Unknown';
      if (messagesCount) messagesCount.textContent = session.messages_received || 0;
      if (phoneNumber) phoneNumber.textContent = session.phone_number || '--';
      if (createdDate && session.created_at) {
        createdDate.textContent = new Date(session.created_at).toLocaleDateString();
      }
    }

    // Action buttons
    document.getElementById('refresh-btn')?.addEventListener('click', () => {
      location.reload();
    });

    document.getElementById('logout-btn')?.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to logout this session?')) return;
      try {
        await fetch(`/api/sessions/${sessionId}/logout`, { method: 'POST' });
        alert('Session logged out');
      } catch (e) { alert('Failed to logout'); }
    });

    document.getElementById('delete-btn')?.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to DELETE this session? This cannot be undone.')) return;
      try {
        await fetch(`/api/sessions/${sessionId}`, { method: 'DELETE' });
        window.location.href = '/';
      } catch (e) { alert('Failed to delete'); }
    });

    // Toggle settings
    let currentSettings = {};
    
    async function loadSettings() {
      try {
        const response = await fetch(`/api/sessions/${sessionId}/settings`);
        const result = await response.json();
        if (result.success && result.data) {
          currentSettings = result.data;
          updateSettingsUI(result.data);
        }
      } catch (e) { console.error('Failed to load settings:', e); }
    }

    function updateSettingsUI(settings) {
      const keys = ['auto_always_online', 'auto_typing', 'auto_read_messages', 'auto_reject_calls'];
      keys.forEach(key => {
        const toggle = document.getElementById(`toggle-${key}`);
        if (toggle) {
          const isEnabled = settings[key];
          toggle.setAttribute('aria-checked', String(isEnabled));
          toggle.classList.toggle('bg-gh-success', isEnabled);
          toggle.classList.toggle('bg-gh-bg-tertiary', !isEnabled);
          const span = toggle.querySelector('span');
          if (span) {
            span.classList.toggle('translate-x-5', isEnabled);
            span.classList.toggle('translate-x-0', !isEnabled);
          }
        }
      });
    }

    document.querySelectorAll('[data-setting]').forEach(toggle => {
      toggle.addEventListener('click', async () => {
        const key = toggle.getAttribute('data-setting');
        const newValue = !currentSettings[key];
        try {
          const response = await fetch(`/api/sessions/${sessionId}/settings`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [key]: newValue })
          });
          const result = await response.json();
          if (result.success && result.data) {
            currentSettings = result.data;
            updateSettingsUI(result.data);
          }
        } catch (e) { console.error('Failed to update setting:', e); }
      });
    });

    loadSettings();
  </script>
</body>
</html>
