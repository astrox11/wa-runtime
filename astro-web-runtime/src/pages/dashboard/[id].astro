---
import Layout from '../../layouts/Layout.astro';
import AppBar from '../../components/AppBar.astro';

const { id } = Astro.params;
---

<Layout title="Dashboard">
  <AppBar title="Dashboard">
    <span slot="actions" id="session-status" class="flex items-center gap-2 px-3 py-1 rounded-gh bg-gh-bg-secondary border border-gh-border text-xs">
      <span class="w-2 h-2 rounded-full bg-gh-text-muted"></span>
      <span class="text-gh-text-secondary">Loading...</span>
    </span>
  </AppBar>
  
  <main class="max-w-5xl mx-auto px-4 py-6">
    <div class="mb-4">
      <a href="/" class="inline-flex items-center gap-1 text-sm text-gh-link hover:underline">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
          <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
        Back to Sessions
      </a>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <p class="text-xs text-gh-text-secondary mb-1">Phone Number</p>
        <p id="phone-number" class="text-lg font-semibold text-gh-text">---</p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <p class="text-xs text-gh-text-secondary mb-1">Messages</p>
        <p id="messages-count" class="text-lg font-semibold text-gh-text">0</p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <p class="text-xs text-gh-text-secondary mb-1">Uptime</p>
        <p id="uptime" class="text-lg font-semibold text-gh-text">0m</p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <p class="text-xs text-gh-text-secondary mb-1">Avg/Hour</p>
        <p id="avg-messages" class="text-lg font-semibold text-gh-text">0</p>
      </div>
    </div>

    <!-- Activity Chart -->
    <div class="bg-gh-bg border border-gh-border rounded-gh mb-6">
      <div class="p-4 border-b border-gh-border">
        <h2 class="text-sm font-semibold text-gh-text">Activity</h2>
        <p class="text-xs text-gh-text-secondary">Messages per hour (today)</p>
      </div>
      <div id="activity-chart" class="p-4 h-40 flex items-end justify-between gap-0.5">
        <div class="flex-1 flex items-center justify-center">
          <div class="w-5 h-5 border-2 border-gh-accent border-t-transparent rounded-full animate-spin"></div>
        </div>
      </div>
    </div>

    <!-- Info Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-gh-bg border border-gh-border rounded-gh">
        <div class="p-4 border-b border-gh-border">
          <h3 class="text-sm font-semibold text-gh-text">Runtime Stats</h3>
        </div>
        <div class="p-4 space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gh-text-secondary">Total Sessions</span>
            <span id="total-sessions" class="text-gh-text font-medium">0</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gh-text-secondary">Active Sessions</span>
            <span id="active-sessions" class="text-gh-text font-medium">0</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gh-text-secondary">Total Messages</span>
            <span id="total-messages" class="text-gh-text font-medium">0</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gh-text-secondary">Server Uptime</span>
            <span id="server-uptime" class="text-gh-text font-medium">0m</span>
          </div>
        </div>
      </div>

      <div class="bg-gh-bg border border-gh-border rounded-gh">
        <div class="p-4 border-b border-gh-border">
          <h3 class="text-sm font-semibold text-gh-text">Health</h3>
        </div>
        <div class="p-4 flex flex-col items-center">
          <div id="health-ring" class="relative w-20 h-20 mb-2">
            <svg class="w-full h-full -rotate-90" viewBox="0 0 36 36">
              <path
                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                fill="none"
                stroke-width="3"
                class="stroke-gh-bg-tertiary"
              />
              <path
                id="health-progress"
                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                fill="none"
                stroke-width="3"
                stroke-dasharray="100, 100"
                class="stroke-gh-success"
              />
            </svg>
            <span id="health-value" class="absolute inset-0 flex items-center justify-center text-lg font-semibold text-gh-success">100%</span>
          </div>
          <p id="health-status" class="text-xs text-gh-text-secondary">Session is healthy</p>
        </div>
      </div>

      <div class="bg-gh-bg border border-gh-border rounded-gh">
        <div class="p-4 border-b border-gh-border">
          <h3 class="text-sm font-semibold text-gh-text">Info</h3>
        </div>
        <div class="p-4 space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gh-text-secondary">Version</span>
            <span id="runtime-version" class="text-gh-text font-medium">---</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gh-text-secondary">Session ID</span>
            <span class="text-gh-text font-mono text-xs truncate max-w-[120px]">{id}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gh-text-secondary">Created</span>
            <span id="session-created" class="text-gh-text font-medium">---</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-end gap-3">
      <button id="refresh-btn" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-gh bg-gh-bg-secondary border border-gh-border text-gh-text hover:bg-gh-bg-tertiary transition-colors">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
          <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
        </svg>
        Refresh
      </button>
      <button id="disconnect-btn" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-gh border border-gh-danger text-gh-danger hover:bg-gh-danger-subtle transition-colors">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
          <path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
        </svg>
        Disconnect
      </button>
    </div>
  </main>
</Layout>

<script define:vars={{ sessionId: id }}>
  async function init() {
    await Promise.all([
      loadSessionStats(),
      loadOverallStats(),
      loadConfig(),
    ]);

    setInterval(() => {
      loadSessionStats();
      loadOverallStats();
    }, 30000);
  }

  async function loadSessionStats() {
    try {
      const response = await fetch(`/api/stats/${sessionId}`);
      const result = await response.json();

      if (result.success && result.data) {
        const data = result.data;

        document.getElementById('phone-number').textContent = `+${data.session.phone_number}`;
        document.getElementById('messages-count').textContent = data.messages.toLocaleString();
        document.getElementById('uptime').textContent = data.uptimeFormatted;
        document.getElementById('avg-messages').textContent = data.avgMessagesPerHour.toFixed(1);

        const statusEl = document.getElementById('session-status');
        const statusColors = {
          active: 'bg-gh-success',
          pairing: 'bg-gh-warning',
          inactive: 'bg-gh-text-muted'
        };
        statusEl.innerHTML = `
          <span class="w-2 h-2 rounded-full ${statusColors[data.session.status] || 'bg-gh-text-muted'}"></span>
          <span class="text-gh-text-secondary capitalize">${data.session.status}</span>
        `;

        const createdDate = new Date(data.session.createdAt);
        document.getElementById('session-created').textContent = createdDate.toLocaleDateString();

        const healthPercent = data.session.status === 'active' ? 100 : data.session.status === 'pairing' ? 50 : 0;
        document.getElementById('health-progress').style.strokeDasharray = `${healthPercent}, 100`;
        document.getElementById('health-value').textContent = `${healthPercent}%`;
        document.getElementById('health-status').textContent = 
          healthPercent === 100 ? 'Session is healthy' : 
          healthPercent === 50 ? 'Pairing in progress' : 'Session disconnected';

        renderBarChart(data.hourlyActivity);
      }
    } catch (error) {
      console.error('Failed to load session stats:', error);
    }
  }

  async function loadOverallStats() {
    try {
      const response = await fetch('/api/stats');
      const result = await response.json();

      if (result.success && result.data) {
        document.getElementById('total-sessions').textContent = result.data.totalSessions;
        document.getElementById('active-sessions').textContent = result.data.activeSessions;
        document.getElementById('total-messages').textContent = result.data.totalMessages.toLocaleString();
        document.getElementById('server-uptime').textContent = result.data.serverUptimeFormatted;
      }
    } catch (error) {
      console.error('Failed to load overall stats:', error);
    }
  }

  async function loadConfig() {
    try {
      const response = await fetch('/api/config');
      const result = await response.json();

      if (result.success && result.data) {
        document.getElementById('runtime-version').textContent = `v${result.data.version}`;
      }
    } catch (error) {
      console.error('Failed to load config:', error);
    }
  }

  function renderBarChart(hourlyData) {
    const container = document.getElementById('activity-chart');
    const maxValue = Math.max(...hourlyData, 1);

    let html = '';
    for (let i = 0; i < 24; i++) {
      const value = hourlyData[i] || 0;
      const height = Math.max((value / maxValue) * 100, 4);
      
      html += `
        <div class="flex-1 h-full flex items-end">
          <div class="w-full rounded-t bg-gh-accent" style="height: ${height}%"></div>
        </div>
      `;
    }
    
    container.innerHTML = html;
  }

  document.getElementById('refresh-btn').addEventListener('click', async () => {
    const btn = document.getElementById('refresh-btn');
    btn.disabled = true;
    btn.innerHTML = `
      <div class="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"></div>
      Refreshing...
    `;
    
    await Promise.all([loadSessionStats(), loadOverallStats()]);
    
    btn.disabled = false;
    btn.innerHTML = `
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
        <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
      </svg>
      Refresh
    `;
  });

  document.getElementById('disconnect-btn').addEventListener('click', async () => {
    if (!confirm('Are you sure you want to disconnect this session?')) {
      return;
    }

    try {
      const response = await fetch(`/api/sessions/${sessionId}`, {
        method: 'DELETE',
      });
      const result = await response.json();

      if (result.success) {
        window.location.href = '/';
      } else {
        alert(result.error || 'Failed to disconnect session');
      }
    } catch (error) {
      alert('Failed to disconnect session');
    }
  });

  init();
</script>
