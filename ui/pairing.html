<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Whatsaly - Pair Device" />
    <title>Pair Device - Whatsaly</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "gh-bg": "var(--gh-bg)",
              "gh-bg-secondary": "var(--gh-bg-secondary)",
              "gh-bg-tertiary": "var(--gh-bg-tertiary)",
              "gh-border": "var(--gh-border)",
              "gh-text": "var(--gh-text)",
              "gh-text-secondary": "var(--gh-text-secondary)",
              "gh-text-muted": "var(--gh-text-muted)",
              "gh-link": "var(--gh-link)",
              "gh-success": "var(--gh-success)",
              "gh-warning": "var(--gh-warning)",
              "gh-danger": "var(--gh-danger)",
              "gh-danger-subtle": "var(--gh-danger-subtle)",
            },
            borderRadius: { gh: "6px" },
            fontFamily: {
              sans: ["Plus Jakarta Sans", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>
    <script>
      (function () {
        const storedTheme = localStorage.getItem("theme");
        const systemDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;
        if (storedTheme === "dark" || (!storedTheme && systemDark)) {
          document.documentElement.classList.add("dark");
        }
      })();
    </script>
    <style>
      :root {
        --gh-bg: #ffffff;
        --gh-bg-secondary: #f6f8fa;
        --gh-bg-tertiary: #eaeef2;
        --gh-border: #d0d7de;
        --gh-text: #1f2328;
        --gh-text-secondary: #656d76;
        --gh-text-muted: #8c959f;
        --gh-link: #0969da;
        --gh-success: #1a7f37;
        --gh-warning: #9a6700;
        --gh-danger: #cf222e;
        --gh-danger-subtle: #ffebe9;
      }
      .dark {
        --gh-bg: #0d1117;
        --gh-bg-secondary: #161b22;
        --gh-bg-tertiary: #21262d;
        --gh-border: #30363d;
        --gh-text: #e6edf3;
        --gh-text-secondary: #8b949e;
        --gh-text-muted: #6e7681;
        --gh-link: #58a6ff;
        --gh-success: #3fb950;
        --gh-warning: #d29922;
        --gh-danger: #f85149;
        --gh-danger-subtle: #2d1b1b;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family:
          "Plus Jakarta Sans",
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          sans-serif;
      }
      /* Fallback styles when Tailwind CDN fails */
      body {
        background-color: var(--gh-bg);
        color: var(--gh-text);
        min-height: 100vh;
        line-height: 1.5;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      main {
        max-width: 28rem;
        width: 100%;
        text-align: center;
      }
      button {
        cursor: pointer;
        border: none;
        background: var(--gh-bg-secondary);
        color: var(--gh-text);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        width: 100%;
      }
      button:hover {
        background: var(--gh-bg-tertiary);
      }
      a {
        color: var(--gh-link);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      .card {
        background: var(--gh-bg);
        border: 1px solid var(--gh-border);
        border-radius: 8px;
        padding: 2rem;
        margin-bottom: 1rem;
      }
      @keyframes ghost-pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }
      .animate-ghost-pulse {
        animation: ghost-pulse 1.5s ease-in-out infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      [data-tooltip] {
        position: relative;
      }
      .custom-tooltip {
        position: absolute;
        z-index: 9999;
        padding: 6px 10px;
        font-size: 12px;
        font-weight: 500;
        color: #fff;
        background: #24292f;
        border-radius: 6px;
        white-space: nowrap;
        pointer-events: none;
        opacity: 0;
        transform: translateX(-50%) translateY(4px);
        transition:
          opacity 0.15s,
          transform 0.15s;
        bottom: 100%;
        left: 50%;
        margin-bottom: 6px;
      }
      .custom-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #24292f transparent transparent transparent;
      }
      .dark .custom-tooltip {
        background: #f0f0f0;
        color: #24292f;
      }
      .dark .custom-tooltip::after {
        border-color: #f0f0f0 transparent transparent transparent;
      }
      [data-tooltip]:hover .custom-tooltip {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    </style>
  </head>
  <body class="bg-gh-bg font-sans text-gh-text min-h-screen antialiased">
    <main class="max-w-lg mx-auto px-4 py-8">
      <div class="bg-gh-bg border border-gh-border rounded-gh">
        <div class="p-4 border-b border-gh-border">
          <a
            href="/"
            class="inline-flex items-center gap-1 text-sm text-gh-link hover:underline mb-2"
          >
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"
              ></path>
            </svg>
            Back
          </a>
          <h1 class="text-lg font-semibold text-gh-text">Link with WhatsApp</h1>
        </div>

        <div id="pairing-content" class="p-6">
          <div class="flex flex-col items-center">
            <div class="space-y-3 w-full max-w-xs">
              <div
                class="h-8 bg-gh-bg-tertiary rounded-gh animate-ghost-pulse mx-auto w-32"
              ></div>
              <div
                class="h-4 bg-gh-bg-tertiary rounded-gh animate-ghost-pulse w-3/4 mx-auto"
              ></div>
            </div>
            <p class="text-sm text-gh-text-secondary mt-4">
              Loading pairing code...
            </p>
          </div>
        </div>

        <div id="error-content" class="p-6 hidden">
          <div class="flex flex-col items-center">
            <div
              class="w-12 h-12 rounded-full bg-gh-danger-subtle flex items-center justify-center mb-3"
            >
              <svg
                class="w-6 h-6 text-gh-danger"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                ></path>
              </svg>
            </div>
            <h2 class="text-lg font-semibold text-gh-text mb-1">
              Pairing Failed
            </h2>
            <p
              id="error-message"
              class="text-sm text-gh-text-secondary mb-2 text-center"
            ></p>
            <p id="countdown-text" class="text-xs text-gh-warning mb-4 hidden">
              Session will be deleted in
              <span id="countdown-seconds">10</span>s...
            </p>
            <a
              href="/"
              class="px-4 py-1.5 text-sm font-medium rounded-gh bg-gh-bg-secondary border border-gh-border text-gh-text hover:bg-gh-bg-tertiary"
              >Try Again</a
            >
          </div>
        </div>
      </div>
    </main>

    <script>
      const pairingContent = document.getElementById("pairing-content");
      const errorContent = document.getElementById("error-content");
      const errorMessage = document.getElementById("error-message");
      const countdownText = document.getElementById("countdown-text");
      const countdownSeconds = document.getElementById("countdown-seconds");

      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get("id");
      const pairingCode = urlParams.get("code");

      let ws = null;
      let pairingTimeout = null;
      let countdownInterval = null;
      let pairingComplete = false;

      if (pairingCode && sessionId) {
        showPairingCode(pairingCode);
      } else {
        showError("No pairing code provided", false);
      }

      function showPairingCode(code) {
        const formattedCode = `${code.slice(0, 4)}-${code.slice(4)}`;
        pairingContent.innerHTML = `
        <div class="flex flex-col items-center">
          <div class="mb-4">
            <div class="px-6 py-4 rounded-gh bg-gh-bg-secondary border border-gh-border">
              <span class="text-2xl font-mono font-bold tracking-widest text-gh-text">${formattedCode}</span>
            </div>
          </div>
          <div class="w-full p-4 rounded-gh bg-gh-bg-secondary border border-gh-border mb-4">
            <h3 class="text-sm font-semibold text-gh-text mb-2">How to link:</h3>
            <ol class="space-y-1 pl-4 list-decimal text-sm text-gh-text-secondary">
              <li>Open WhatsApp on your phone</li>
              <li>Go to <strong class="text-gh-text">Settings</strong> â†’ <strong class="text-gh-text">Linked Devices</strong></li>
              <li>Tap <strong class="text-gh-text">Link a Device</strong></li>
              <li>Select <strong class="text-gh-text">Link with phone number instead</strong></li>
              <li>Enter the code shown above</li>
            </ol>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-gh-warning animate-pulse"></span>
            <span class="text-sm text-gh-text-secondary">Waiting for pairing...</span>
          </div>
        </div>
      `;

        connectAndWatchPairing();

        pairingTimeout = setTimeout(() => {
          if (!pairingComplete) {
            showError("Pairing timed out. Please try again.", true);
          }
        }, 120000);
      }

      function connectAndWatchPairing() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        ws = new WebSocket(`${protocol}//${window.location.host}/ws/stats`);

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.type === "stats" && data.data?.sessions) {
              const session = data.data.sessions.find(
                (s) => s.id === sessionId,
              );
              if (session) {
                if (
                  session.status === "connected" ||
                  session.status === "active"
                ) {
                  pairingComplete = true;
                  if (pairingTimeout) clearTimeout(pairingTimeout);
                  window.location.href = `/dashboard.html?id=${sessionId}`;
                } else if (
                  session.status === "inactive" ||
                  session.status === "disconnected"
                ) {
                  showError("Session was disconnected or timed out", true);
                }
              }
            }
          } catch (e) {
            console.error("WS error:", e);
          }
        };

        ws.onclose = () => {
          if (!pairingComplete && errorContent.classList.contains("hidden")) {
            setTimeout(connectAndWatchPairing, 3000);
          }
        };

        ws.onerror = () => {
          console.error("WebSocket connection error");
        };
      }

      async function deleteSession() {
        if (!sessionId) return;
        try {
          await fetch(`/api/sessions/${sessionId}`, { method: "DELETE" });
          console.log("Session deleted successfully");
        } catch (e) {
          console.error("Failed to delete session:", e);
        }
      }

      function showError(msg, shouldDeleteSession = false) {
        if (pairingTimeout) clearTimeout(pairingTimeout);
        if (ws) ws.close();

        pairingContent.classList.add("hidden");
        errorContent.classList.remove("hidden");
        errorMessage.textContent = msg;

        if (shouldDeleteSession && sessionId) {
          countdownText.classList.remove("hidden");
          let seconds = 10;
          countdownSeconds.textContent = seconds;

          countdownInterval = setInterval(() => {
            seconds--;
            countdownSeconds.textContent = seconds;
            if (seconds <= 0) {
              clearInterval(countdownInterval);
              deleteSession();
              countdownText.textContent = "Session deleted.";
            }
          }, 1000);
        }
      }
    </script>
  </body>
</html>
