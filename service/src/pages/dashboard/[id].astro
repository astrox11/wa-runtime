---
import Layout from "../../layouts/Layout.astro";

const { id } = Astro.params;

// Hash the session ID for display (first 4 and last 4 characters)
function hashSessionId(sessionId: string): string {
  if (!sessionId || sessionId.length <= 12) return sessionId;
  return `${sessionId.substring(0, 8)}...${sessionId.substring(sessionId.length - 4)}`;
}

const hashedId = hashSessionId(id || "");
---

<Layout title="Dashboard">
  <main class="max-w-5xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between mb-4">
      <a
        href="/"
        class="inline-flex items-center gap-1 text-sm text-gh-link hover:underline"
      >
        <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M7.78 12.53a.75.75 0 0 1-1.06 0L2.47 8.28a.75.75 0 0 1 0-1.06l4.25-4.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L4.81 7h7.44a.75.75 0 0 1 0 1.5H4.81l2.97 2.97a.75.75 0 0 1 0 1.06Z"
          ></path>
        </svg>
        Sessions
      </a>
      <span
        id="session-status"
        class="flex items-center gap-2 px-3 py-1 rounded-gh bg-gh-bg-secondary border border-gh-border text-xs"
      >
        <div class="w-3 h-3 bg-gh-bg-tertiary rounded-full animate-pulse"></div>
        <div class="w-16 h-3 bg-gh-bg-tertiary rounded animate-pulse"></div>
      </span>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <div class="flex items-center gap-2 mb-1">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M10.561 8.073a6.005 6.005 0 0 1 3.432 5.142.75.75 0 1 1-1.498.07 4.5 4.5 0 0 0-8.99 0 .75.75 0 0 1-1.498-.07 6.004 6.004 0 0 1 3.431-5.142 3.999 3.999 0 1 1 5.123 0ZM10.5 5a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"
            ></path>
          </svg>
          <p class="text-xs text-gh-text-secondary">User</p>
        </div>
        <p id="user-name" class="text-base font-semibold text-gh-text truncate">
          <span
            class="inline-block w-20 h-4 bg-gh-bg-tertiary rounded animate-pulse"
          ></span>
        </p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <div class="flex items-center gap-2 mb-1">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M1.75 1h8.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 10.25 10H7.061l-2.574 2.573A1.458 1.458 0 0 1 2 11.543V10h-.25A1.75 1.75 0 0 1 0 8.25v-5.5C0 1.784.784 1 1.75 1ZM1.5 2.75v5.5c0 .138.112.25.25.25h1a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h3.5a.25.25 0 0 0 .25-.25v-5.5a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25Zm13 2a.25.25 0 0 0-.25-.25h-.5a.75.75 0 0 1 0-1.5h.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 14.25 12H14v1.543a1.458 1.458 0 0 1-2.487 1.03L9.22 12.28a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215l2.22 2.22v-2.19a.75.75 0 0 1 .75-.75h1a.25.25 0 0 0 .25-.25Z"
            ></path>
          </svg>
          <p class="text-xs text-gh-text-secondary">Messages</p>
        </div>
        <p id="messages-count" class="text-base font-semibold text-gh-text">
          <span
            class="inline-block w-10 h-4 bg-gh-bg-tertiary rounded animate-pulse"
          ></span>
        </p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <div class="flex items-center gap-2 mb-1">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M4.75 0h6.5a.75.75 0 0 1 0 1.5h-6.5a.75.75 0 0 1 0-1.5ZM2 4.75A.75.75 0 0 1 2.75 4h10.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 4.75Zm-.5 3a1.75 1.75 0 0 1 1.75-1.75h9.5a1.75 1.75 0 0 1 1.75 1.75v7.5A1.75 1.75 0 0 1 12.75 17h-9.5A1.75 1.75 0 0 1 1.5 15.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"
              transform="translate(0, -1)"></path>
          </svg>
          <p class="text-xs text-gh-text-secondary">Created</p>
        </div>
        <p id="created-date" class="text-base font-semibold text-gh-text">
          <span
            class="inline-block w-16 h-4 bg-gh-bg-tertiary rounded animate-pulse"
          ></span>
        </p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <div class="flex items-center gap-2 mb-1">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M11.93 8.5a4.002 4.002 0 0 1-7.86 0H.75a.75.75 0 0 1 0-1.5h3.32a4.002 4.002 0 0 1 7.86 0h3.32a.75.75 0 0 1 0 1.5Zm-1.43-.75a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"
            ></path>
          </svg>
          <p class="text-xs text-gh-text-secondary">Messages Sent</p>
        </div>
        <p id="messages-sent" class="text-base font-semibold text-gh-text">
          <span
            class="inline-block w-10 h-4 bg-gh-bg-tertiary rounded animate-pulse"
          ></span>
        </p>
      </div>
    </div>

    <!-- Activity Chart -->
    <div class="bg-gh-bg border border-gh-border rounded-gh mb-6">
      <div
        class="p-4 border-b border-gh-border flex items-center justify-between"
      >
        <div class="flex items-center gap-2">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M1.5 1.75V13.5h13.75a.75.75 0 0 1 0 1.5H.75a.75.75 0 0 1-.75-.75V1.75a.75.75 0 0 1 1.5 0Zm14.28 2.53-5.25 5.25a.75.75 0 0 1-1.06 0L7 7.06 4.28 9.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.25-3.25a.75.75 0 0 1 1.06 0L10 7.94l4.72-4.72a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042Z"
            ></path>
          </svg>
          <h2 class="text-sm font-semibold text-gh-text">Activity</h2>
          <span class="text-xs text-gh-text-muted">Messages per hour (24h)</span
          >
        </div>
        <div id="chart-stats" class="flex items-center gap-4 text-xs">
          <span class="text-gh-text-secondary"
            >Peak: <span id="peak-hour" class="text-gh-text font-medium"
              >--</span
            ></span
          >
          <span class="text-gh-text-secondary"
            >Avg: <span id="avg-hour" class="text-gh-text font-medium">--</span
            >/hr</span
          >
        </div>
      </div>
      <div class="p-4">
        <div
          id="activity-chart"
          class="h-32 flex items-end justify-between gap-0.5"
        >
          <!-- Skeleton loaders for chart bars -->
          <div class="flex-1 h-1/4 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-2/5 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/3 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/2 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-2/3 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/4 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-3/5 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/2 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/3 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-2/5 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/4 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/2 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-2/3 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/3 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-2/5 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/2 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/4 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-3/5 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-2/5 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/3 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/2 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-2/3 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/4 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-2/5 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
        </div>
        <div class="flex justify-between text-xs text-gh-text-muted mt-2 px-1">
          <span>12am</span>
          <span>6am</span>
          <span>12pm</span>
          <span>6pm</span>
          <span>Now</span>
        </div>
      </div>
    </div>

    <!-- Info Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <!-- Health Card -->
      <div class="bg-gh-bg border border-gh-border rounded-gh">
        <div class="p-4 border-b border-gh-border flex items-center gap-2">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M9.585.52a2.678 2.678 0 0 0-3.17 0l-.928.68a1.178 1.178 0 0 1-.518.215L3.83 1.59a2.678 2.678 0 0 0-2.24 2.24l-.175 1.14a1.178 1.178 0 0 1-.215.518l-.68.928a2.678 2.678 0 0 0 0 3.17l.68.928c.113.153.186.33.215.518l.175 1.138a2.678 2.678 0 0 0 2.24 2.24l1.138.175c.187.029.365.102.518.215l.928.68a2.678 2.678 0 0 0 3.17 0l.928-.68a1.17 1.17 0 0 1 .518-.215l1.138-.175a2.678 2.678 0 0 0 2.241-2.241l.175-1.138c.029-.187.102-.365.215-.518l.68-.928a2.678 2.678 0 0 0 0-3.17l-.68-.928a1.179 1.179 0 0 1-.215-.518L14.41 3.83a2.678 2.678 0 0 0-2.24-2.24l-1.138-.175a1.179 1.179 0 0 1-.518-.215ZM7.303 1.728l.928-.68a1.178 1.178 0 0 1 1.395 0l.928.68c.348.256.752.423 1.18.489l1.136.174a1.178 1.178 0 0 1 .987.987l.174 1.137c.066.427.233.831.489 1.18l.68.927a1.178 1.178 0 0 1 0 1.394l-.68.928a2.677 2.677 0 0 0-.489 1.18l-.174 1.136a1.178 1.178 0 0 1-.987.987l-1.137.175a2.677 2.677 0 0 0-1.18.488l-.927.68a1.178 1.178 0 0 1-1.394 0l-.928-.68a2.677 2.677 0 0 0-1.18-.488l-1.136-.175a1.178 1.178 0 0 1-.987-.987l-.175-1.136a2.677 2.677 0 0 0-.488-1.18l-.68-.928a1.178 1.178 0 0 1 0-1.394l.68-.927a2.68 2.68 0 0 0 .488-1.18l.175-1.137a1.178 1.178 0 0 1 .987-.987l1.136-.174a2.68 2.68 0 0 0 1.18-.489Z"
            ></path>
            <path
              d="m11.28 6.78-3.25 3.25a.75.75 0 0 1-1.06 0L4.72 7.78a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l1.47 1.47 2.72-2.72a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-.75.75Z"
            ></path>
          </svg>
          <h3 class="text-sm font-semibold text-gh-text">Status</h3>
        </div>
        <div class="p-4">
          <div id="health-indicator" class="flex items-center gap-3 mb-3">
            <div
              id="health-badge"
              class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gh-success-subtle"
            >
              <svg
                id="health-icon"
                class="w-4 h-4 text-gh-success"
                viewBox="0 0 16 16"
                fill="currentColor"
              >
                <path
                  d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"
                ></path>
              </svg>
              <span id="health-text" class="text-sm font-medium text-gh-success"
                >Connected</span
              >
            </div>
          </div>
          <div id="health-details" class="space-y-2 text-sm">
            <div class="flex items-center gap-2">
              <svg
                class="w-3 h-3 text-gh-success"
                viewBox="0 0 16 16"
                fill="currentColor"
              >
                <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"></path>
                <path
                  d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"
                ></path>
              </svg>
              <span id="health-ws" class="text-gh-text-secondary"
                >WebSocket: <span class="text-gh-text">Active</span></span
              >
            </div>
            <div class="flex items-center gap-2">
              <svg
                class="w-3 h-3 text-gh-success"
                viewBox="0 0 16 16"
                fill="currentColor"
              >
                <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"></path>
                <path
                  d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"
                ></path>
              </svg>
              <span id="health-session" class="text-gh-text-secondary"
                >Session: <span class="text-gh-text">Authenticated</span></span
              >
            </div>
          </div>
        </div>
      </div>

      <div class="bg-gh-bg border border-gh-border rounded-gh">
        <div class="p-4 border-b border-gh-border flex items-center gap-2">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M2 5.5a3.5 3.5 0 1 1 5.898 2.549 5.508 5.508 0 0 1 3.034 4.084.75.75 0 1 1-1.482.235 4 4 0 0 0-7.9 0 .75.75 0 0 1-1.482-.236A5.507 5.507 0 0 1 3.102 8.05 3.493 3.493 0 0 1 2 5.5ZM11 4a3.001 3.001 0 0 1 2.22 5.018 5.01 5.01 0 0 1 2.56 3.012.749.749 0 0 1-.885.954.752.752 0 0 1-.549-.514 3.507 3.507 0 0 0-2.522-2.372.75.75 0 0 1-.574-.73v-.352a.75.75 0 0 1 .416-.672A1.5 1.5 0 0 0 11 5.5.75.75 0 0 1 11 4Zm-5.5-.5a2 2 0 1 0-.001 3.999A2 2 0 0 0 5.5 3.5Z"
            ></path>
          </svg>
          <h3 class="text-sm font-semibold text-gh-text">Runtime</h3>
        </div>
        <div class="p-4 space-y-2 text-sm">
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Total Sessions</span>
            <span id="total-sessions" class="text-gh-text font-medium"
              ><span
                class="inline-block w-6 h-3 bg-gh-bg-tertiary rounded animate-pulse"
              ></span></span
            >
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Active Sessions</span>
            <span id="active-sessions" class="text-gh-text font-medium"
              ><span
                class="inline-block w-6 h-3 bg-gh-bg-tertiary rounded animate-pulse"
              ></span></span
            >
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Total Messages</span>
            <span id="total-messages" class="text-gh-text font-medium"
              ><span
                class="inline-block w-10 h-3 bg-gh-bg-tertiary rounded animate-pulse"
              ></span></span
            >
          </div>
        </div>
      </div>

      <div class="bg-gh-bg border border-gh-border rounded-gh">
        <div class="p-4 border-b border-gh-border flex items-center gap-2">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Zm7.251 10.324.004-5.073-.002-2.253A2.25 2.25 0 0 0 5.003 2.5H1.5v9h3.757a3.75 3.75 0 0 1 1.994.574ZM8.755 4.75l-.004 7.322a3.752 3.752 0 0 1 1.992-.572H14.5v-9h-3.495a2.25 2.25 0 0 0-2.25 2.25Z"
            ></path>
          </svg>
          <h3 class="text-sm font-semibold text-gh-text">Session Info</h3>
        </div>
        <div class="p-4 space-y-2 text-sm">
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Version</span>
            <span id="runtime-version" class="text-gh-text font-medium"
              ><span
                class="inline-block w-10 h-3 bg-gh-bg-tertiary rounded animate-pulse"
              ></span></span
            >
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Session ID</span>
            <span
              id="session-id-display"
              class="text-gh-text font-mono text-xs bg-gh-bg-secondary px-1.5 py-0.5 rounded"
              title={id}>{hashedId}</span
            >
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Phone</span>
            <span id="phone-number" class="text-gh-text font-mono text-xs"
              ><span
                class="inline-block w-16 h-3 bg-gh-bg-tertiary rounded animate-pulse"
              ></span></span
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Groups Section -->
    <div class="bg-gh-bg border border-gh-border rounded-gh mb-6">
      <div
        class="p-4 border-b border-gh-border flex items-center justify-between"
      >
        <div class="flex items-center gap-2">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M5.5 3.5A2 2 0 0 1 7.5 1.5h1A2 2 0 0 1 10.5 3.5v1A2 2 0 0 1 8.5 6.5h-1A2 2 0 0 1 5.5 4.5ZM7.5 3a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5ZM2 10.5A2 2 0 0 1 4 8.5h1a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2Zm2-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5Zm5.5 0a2 2 0 0 1 2-2h1a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2Zm2-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5Z"
            ></path>
          </svg>
          <h2 class="text-sm font-semibold text-gh-text">Groups</h2>
          <span id="groups-count" class="text-xs text-gh-text-muted"
            >Loading...</span
          >
        </div>
      </div>
      <div
        id="groups-list"
        class="divide-y divide-gh-border max-h-64 overflow-y-auto"
      >
        <div class="p-4 text-center">
          <div
            class="inline-block w-40 h-4 bg-gh-bg-tertiary rounded animate-pulse"
          >
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-end gap-2">
      <button
        id="refresh-btn"
        class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-gh bg-gh-bg-secondary border border-gh-border text-gh-text hover:bg-gh-bg-tertiary transition-colors"
        title="Refresh"
      >
        <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z"
          ></path>
        </svg>
      </button>
      <button
        id="disconnect-btn"
        class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-gh border border-gh-danger text-gh-danger hover:bg-gh-danger-subtle transition-colors"
        title="Disconnect"
      >
        <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M11 1.75V3h2.25a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1 0-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75ZM4.496 6.675l.66 6.6a.25.25 0 0 0 .249.225h5.19a.25.25 0 0 0 .249-.225l.66-6.6a.75.75 0 0 1 1.492.149l-.66 6.6A1.748 1.748 0 0 1 10.595 15h-5.19a1.75 1.75 0 0 1-1.741-1.575l-.66-6.6a.75.75 0 1 1 1.492-.15ZM6.5 1.75V3h3V1.75a.25.25 0 0 0-.25-.25h-2.5a.25.25 0 0 0-.25.25Z"
          ></path>
        </svg>
      </button>
    </div>
  </main>
</Layout>

<script>
  import { date } from "astro:schema";
  import { api } from "../../lib/api";

  const sessionId = window.location.pathname.split("/").pop() || "";

  interface SessionStats {
    messagesReceived: number;
    messagesSent: number;
  }

  interface HourlyActivity {
    hourlyData: number[];
    peakHour: string;
    average: number;
  }

  interface SessionData {
    id: string;
    phone_number: string;
    created_at: number;
    status: "active" | "inactive" | "pairing" | "paused_user";
    user_info: {
      id: string;
      lid: string;
      name: string;
    };
    stats: SessionStats;
    hourlyActivity?: HourlyActivity;
  }

  function formatRelativeTime(timestamp: number): string {
    const now = Date.now();
    const diff = now - timestamp;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

    if (days > 0) {
      return `${days}d ${hours}h ago`;
    } else if (hours > 0) {
      const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      return `${hours}h ${mins}m ago`;
    } else {
      const mins = Math.floor(diff / (1000 * 60));
      return mins > 0 ? `${mins}m ago` : "Just now";
    }
  }

  function updateSessionDisplay(
    sessionData: SessionData & {
      stats: SessionStats;
      hourlyActivity?: HourlyActivity;
    }
  ) {
    const displayName =
      sessionData.user_info.name || `+${sessionData.phone_number}`;
    const userNameEl = document.getElementById("user-name");
    if (userNameEl) userNameEl.textContent = displayName;

    const phoneEl = document.getElementById("phone-number");
    if (phoneEl) phoneEl.textContent = `+${sessionData.phone_number}`;

    if (sessionData.stats) {
      const messagesCountEl = document.getElementById("messages-count");
      const messagesSentEl = document.getElementById("messages-sent");

      if (messagesCountEl) {
        messagesCountEl.textContent =
          sessionData.stats.messagesReceived.toLocaleString();
      }
      if (messagesSentEl) {
        messagesSentEl.textContent =
          sessionData.stats.messagesSent.toLocaleString();
      }
    }

    if (sessionData.created_at) {
      const createdEl = document.getElementById("created-date");
      if (createdEl)
        createdEl.textContent = formatRelativeTime(sessionData.created_at);
    }

    if (sessionData.hourlyActivity) {
      updateActivityChart(sessionData.hourlyActivity);
    }

    updateHealthStatus(sessionData.status);
  }

  function updateHealthStatus(status: string) {
    const statusEl = document.getElementById("session-status");
    const healthBadge = document.getElementById("health-badge");
    const healthIcon = document.getElementById("health-icon");
    const healthText = document.getElementById("health-text");
    const healthWs = document.getElementById("health-ws");
    const healthSession = document.getElementById("health-session");

    if (!statusEl || !healthBadge || !healthIcon || !healthText) return;

    if (status === "active") {
      statusEl.innerHTML = `
        <svg class="w-4 h-4 text-gh-success" viewBox="0 0 16 16" fill="currentColor">
          <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/>
        </svg>
        <span class="text-gh-success font-medium">Active</span>
      `;
      healthBadge.className =
        "flex items-center gap-2 px-3 py-1.5 rounded-full bg-gh-success-subtle";
      healthIcon.setAttribute("class", "w-4 h-4 text-gh-success");
      healthText.textContent = "Connected";
      healthText.className = "text-sm font-medium text-gh-success";

      if (healthWs)
        healthWs.innerHTML =
          'WebSocket: <span class="text-gh-text">Active</span>';
      if (healthSession)
        healthSession.innerHTML =
          'Session: <span class="text-gh-text">Authenticated</span>';
    } else if (status === "pairing") {
      statusEl.innerHTML = `
        <svg class="w-4 h-4 text-gh-warning animate-pulse" viewBox="0 0 16 16" fill="currentColor">
          <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"/>
          <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"/>
        </svg>
        <span class="text-gh-warning font-medium">Pairing</span>
      `;
      healthBadge.className =
        "flex items-center gap-2 px-3 py-1.5 rounded-full bg-gh-warning-subtle";
      healthIcon.setAttribute("class", "w-4 h-4 text-gh-warning");
      healthText.textContent = "Pairing";
      healthText.className = "text-sm font-medium text-gh-warning";

      if (healthWs)
        healthWs.innerHTML =
          'WebSocket: <span class="text-gh-text">Active</span>';
      if (healthSession)
        healthSession.innerHTML =
          'Session: <span class="text-gh-warning">Awaiting scan</span>';
    } else {
      statusEl.innerHTML = `
        <svg class="w-4 h-4 text-gh-text-muted" viewBox="0 0 16 16" fill="currentColor">
          <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"/>
          <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"/>
        </svg>
        <span class="text-gh-text-muted font-medium">Offline</span>
      `;
      healthBadge.className =
        "flex items-center gap-2 px-3 py-1.5 rounded-full bg-gh-bg-secondary";
      healthIcon.setAttribute("class", "w-4 h-4 text-gh-text-muted");
      healthText.textContent = "Disconnected";
      healthText.className = "text-sm font-medium text-gh-text-muted";

      if (healthWs)
        healthWs.innerHTML =
          'WebSocket: <span class="text-gh-text-muted">Inactive</span>';
      if (healthSession)
        healthSession.innerHTML =
          'Session: <span class="text-gh-text-muted">Disconnected</span>';
    }
  }

  function escapeHtml(text: string): string {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  function updateActivityChart(hourlyActivity: HourlyActivity) {
    const chartEl = document.getElementById("activity-chart");
    const peakHourEl = document.getElementById("peak-hour");
    const avgHourEl = document.getElementById("avg-hour");

    if (!chartEl) return;

    // Update stats
    if (peakHourEl) peakHourEl.textContent = hourlyActivity.peakHour;
    if (avgHourEl) avgHourEl.textContent = hourlyActivity.average.toString();

    // Find max value for scaling
    const maxValue = Math.max(...hourlyActivity.hourlyData, 1);

    // Generate chart bars
    const bars = hourlyActivity.hourlyData.map((count, index) => {
      const heightPercent = (count / maxValue) * 100;
      const minHeight = count > 0 ? 4 : 2; // Minimum height for visibility
      const height = Math.max(heightPercent, minHeight);

      // Color intensity based on value
      const intensity = count / maxValue;
      let bgClass = "bg-gh-bg-tertiary";
      if (count > 0) {
        if (intensity > 0.7) {
          bgClass = "bg-gh-success";
        } else if (intensity > 0.4) {
          bgClass = "bg-gh-success/70";
        } else {
          bgClass = "bg-gh-success/40";
        }
      }

      return `<div 
        class="flex-1 ${bgClass} rounded-t transition-all duration-300" 
        style="height: ${height}%"
        title="${count} message${count !== 1 ? 's' : ''}"
      ></div>`;
    }).join("");

    chartEl.innerHTML = bars;
  }

  api.onStats((data) => {
    if (data.type === "stats") {
      if (data.data?.overall) {
        const totalSessionsEl = document.getElementById("total-sessions");
        const activeSessionsEl = document.getElementById("active-sessions");
        const totalMessagesEl = document.getElementById("total-messages");

        if (totalSessionsEl)
          totalSessionsEl.textContent =
            data.data.overall.totalSessions?.toString() ?? "0";
        if (activeSessionsEl)
          activeSessionsEl.textContent =
            data.data.overall.activeSessions?.toString() ?? "0";
        if (totalMessagesEl)
          totalMessagesEl.textContent =
            data.data.overall.totalMessages?.toLocaleString() ?? "0";
      }

      if (data.data?.sessions) {
        const sessionData = data.data.sessions.find(
          (s: { id: string }) => s.id === sessionId
        );
        if (sessionData) {
          const data = sessionData;
          updateSessionDisplay(data);
        }
      }
    }
  });

  api.getConfig().then((result) => {
    if (result.success && result.data) {
      const versionEl = document.getElementById("runtime-version");
      if (versionEl) versionEl.textContent = `v${result.data.version}`;
    }
  });

  function loadGroups() {
    api.sendAction("getGroups", { sessionId }).then((result) => {
      const groupsList = document.getElementById("groups-list");
      const groupsCount = document.getElementById("groups-count");

      if (!groupsList || !groupsCount) return;

      if (result.success && result.data) {
        const groups = result?.data?.groups || [];
        groupsCount.textContent = `${groups.length} group${groups.length !== 1 ? "s" : ""}`;

        if (groups.length === 0) {
          groupsList.innerHTML = `
            <div class="p-6 text-center">
              <svg class="w-8 h-8 mx-auto mb-2 text-gh-text-muted" viewBox="0 0 16 16" fill="currentColor">
                <path d="M5.5 3.5A2 2 0 0 1 7.5 1.5h1A2 2 0 0 1 10.5 3.5v1A2 2 0 0 1 8.5 6.5h-1A2 2 0 0 1 5.5 4.5ZM7.5 3a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5ZM2 10.5A2 2 0 0 1 4 8.5h1a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2Zm2-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5Zm5.5 0a2 2 0 0 1 2-2h1a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2Zm2-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5Z"/>
              </svg>
              <p class="text-xs text-gh-text-muted">No groups found</p>
            </div>
          `;
        } else {
          groupsList.innerHTML = groups
            .map(
              (group: {
                id: string;
                subject: string;
                participantCount: number;
              }) => `
            <div class="flex items-center justify-between p-3 hover:bg-gh-bg-secondary transition-colors">
              <div class="flex items-center gap-3 flex-1 min-w-0">
                <svg class="w-4 h-4 text-gh-text-secondary flex-shrink-0" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M5.5 3.5A2 2 0 0 1 7.5 1.5h1A2 2 0 0 1 10.5 3.5v1A2 2 0 0 1 8.5 6.5h-1A2 2 0 0 1 5.5 4.5ZM7.5 3a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5ZM2 10.5A2 2 0 0 1 4 8.5h1a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2Zm2-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5Zm5.5 0a2 2 0 0 1 2-2h1a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2Zm2-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5Z"/>
                </svg>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gh-text truncate">${escapeHtml(group.subject)}</p>
                  <p class="text-xs text-gh-text-muted">${group.participantCount} member${group.participantCount !== 1 ? "s" : ""}</p>
                </div>
              </div>
            </div>
          `
            )
            .join("");
        }
      } else {
        groupsCount.textContent = "Error";
        groupsList.innerHTML = `
          <div class="p-4 text-center">
            <p class="text-sm text-gh-danger">Failed to load groups</p>
          </div>
        `;
      }
    });
  }

  loadGroups();

  const refreshBtn = document.getElementById(
    "refresh-btn"
  ) as HTMLButtonElement | null;
  if (refreshBtn) {
    refreshBtn.addEventListener("click", async () => {
      refreshBtn.disabled = true;
      setTimeout(() => {
        refreshBtn.disabled = false;
      }, 1000);
    });
  }

  const disconnectBtn = document.getElementById("disconnect-btn");
  if (disconnectBtn) {
    disconnectBtn.addEventListener("click", async () => {
      if (!confirm("Disconnect this session?")) {
        return;
      }

      const result = await api.deleteSession(sessionId);
      if (result.success) {
        window.location.href = "/";
      } else {
        alert(result.error || "Failed to disconnect session");
      }
    });
  }
</script>
