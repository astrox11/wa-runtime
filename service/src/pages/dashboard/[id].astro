---
import Layout from "../../layouts/Layout.astro";

const { id } = Astro.params;

// Hash the session ID for display (first 4 and last 4 characters)
function hashSessionId(sessionId: string): string {
  if (!sessionId || sessionId.length <= 12) return sessionId;
  return `${sessionId.substring(0, 8)}...${sessionId.substring(sessionId.length - 4)}`;
}

const hashedId = hashSessionId(id || "");
---

<Layout title="Dashboard">
  <main class="max-w-5xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between mb-4">
      <a
        href="/"
        class="inline-flex items-center gap-1 text-sm text-gh-link hover:underline"
      >
        <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M7.78 12.53a.75.75 0 0 1-1.06 0L2.47 8.28a.75.75 0 0 1 0-1.06l4.25-4.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L4.81 7h7.44a.75.75 0 0 1 0 1.5H4.81l2.97 2.97a.75.75 0 0 1 0 1.06Z"
          ></path>
        </svg>
        Sessions
      </a>
      <span
        id="session-status"
        class="flex items-center gap-2 px-3 py-1 rounded-gh bg-gh-bg-secondary border border-gh-border text-xs"
      >
        <div class="w-3 h-3 bg-gh-bg-tertiary rounded-full animate-pulse"></div>
        <div class="w-16 h-3 bg-gh-bg-tertiary rounded animate-pulse"></div>
      </span>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <div class="flex items-center gap-2 mb-1">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M10.561 8.073a6.005 6.005 0 0 1 3.432 5.142.75.75 0 1 1-1.498.07 4.5 4.5 0 0 0-8.99 0 .75.75 0 0 1-1.498-.07 6.004 6.004 0 0 1 3.431-5.142 3.999 3.999 0 1 1 5.123 0ZM10.5 5a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"
            ></path>
          </svg>
          <p class="text-xs text-gh-text-secondary">User</p>
        </div>
        <p id="user-name" class="text-base font-semibold text-gh-text truncate">
          <span
            class="inline-block w-20 h-4 bg-gh-bg-tertiary rounded animate-pulse"
          ></span>
        </p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <div class="flex items-center gap-2 mb-1">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M1.75 1h8.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 10.25 10H7.061l-2.574 2.573A1.458 1.458 0 0 1 2 11.543V10h-.25A1.75 1.75 0 0 1 0 8.25v-5.5C0 1.784.784 1 1.75 1ZM1.5 2.75v5.5c0 .138.112.25.25.25h1a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h3.5a.25.25 0 0 0 .25-.25v-5.5a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25Zm13 2a.25.25 0 0 0-.25-.25h-.5a.75.75 0 0 1 0-1.5h.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 14.25 12H14v1.543a1.458 1.458 0 0 1-2.487 1.03L9.22 12.28a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215l2.22 2.22v-2.19a.75.75 0 0 1 .75-.75h1a.25.25 0 0 0 .25-.25Z"
            ></path>
          </svg>
          <p class="text-xs text-gh-text-secondary">Messages</p>
        </div>
        <p id="messages-count" class="text-base font-semibold text-gh-text">
          <span
            class="inline-block w-10 h-4 bg-gh-bg-tertiary rounded animate-pulse"
          ></span>
        </p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <div class="flex items-center gap-2 mb-1">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M4.75 0h6.5a.75.75 0 0 1 0 1.5h-6.5a.75.75 0 0 1 0-1.5ZM2 4.75A.75.75 0 0 1 2.75 4h10.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 4.75Zm-.5 3a1.75 1.75 0 0 1 1.75-1.75h9.5a1.75 1.75 0 0 1 1.75 1.75v7.5A1.75 1.75 0 0 1 12.75 17h-9.5A1.75 1.75 0 0 1 1.5 15.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"
              transform="translate(0, -1)"></path>
          </svg>
          <p class="text-xs text-gh-text-secondary">Created</p>
        </div>
        <p id="created-date" class="text-base font-semibold text-gh-text">
          <span
            class="inline-block w-16 h-4 bg-gh-bg-tertiary rounded animate-pulse"
          ></span>
        </p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4">
        <div class="flex items-center gap-2 mb-1">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M11.93 8.5a4.002 4.002 0 0 1-7.86 0H.75a.75.75 0 0 1 0-1.5h3.32a4.002 4.002 0 0 1 7.86 0h3.32a.75.75 0 0 1 0 1.5Zm-1.43-.75a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"
            ></path>
          </svg>
          <p class="text-xs text-gh-text-secondary">Messages Sent</p>
        </div>
        <p id="messages-sent" class="text-base font-semibold text-gh-text">
          <span
            class="inline-block w-10 h-4 bg-gh-bg-tertiary rounded animate-pulse"
          ></span>
        </p>
      </div>
    </div>

    <!-- Activity Chart -->
    <div class="bg-gh-bg border border-gh-border rounded-gh mb-6">
      <div
        class="p-4 border-b border-gh-border flex items-center justify-between"
      >
        <div class="flex items-center gap-2">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M1.5 1.75V13.5h13.75a.75.75 0 0 1 0 1.5H.75a.75.75 0 0 1-.75-.75V1.75a.75.75 0 0 1 1.5 0Zm14.28 2.53-5.25 5.25a.75.75 0 0 1-1.06 0L7 7.06 4.28 9.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.25-3.25a.75.75 0 0 1 1.06 0L10 7.94l4.72-4.72a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042Z"
            ></path>
          </svg>
          <h2 class="text-sm font-semibold text-gh-text">Activity</h2>
          <span class="text-xs text-gh-text-muted">Messages per hour (24h)</span
          >
        </div>
        <div id="chart-stats" class="flex items-center gap-4 text-xs">
          <span class="text-gh-text-secondary"
            >Peak: <span id="peak-hour" class="text-gh-text font-medium"
              >--</span
            ></span
          >
          <span class="text-gh-text-secondary"
            >Avg: <span id="avg-hour" class="text-gh-text font-medium">--</span
            >/hr</span
          >
        </div>
      </div>
      <div class="p-4 relative">
        <!-- Custom tooltip for chart bars -->
        <div
          id="chart-tooltip"
          class="absolute z-10 px-2 py-1 text-xs font-medium text-gh-text bg-gh-bg-secondary border border-gh-border rounded-gh shadow-lg pointer-events-none opacity-0 transition-opacity duration-150"
          style="transform: translateX(-50%);"
        >
        </div>
        <div
          id="activity-chart"
          class="h-32 flex items-end justify-between gap-0.5"
        >
          <!-- Skeleton loaders for chart bars -->
          <div class="flex-1 h-1/4 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-2/5 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/3 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/2 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-2/3 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/4 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-3/5 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/2 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/3 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-2/5 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/4 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/2 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-2/3 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/3 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-2/5 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/2 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/4 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-3/5 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-2/5 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/3 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/2 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-2/3 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-1/4 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
          <div class="flex-1 h-2/5 bg-gh-bg-tertiary rounded-t animate-pulse">
          </div>
        </div>
        <div class="flex justify-between text-xs text-gh-text-muted mt-2 px-1">
          <span>12am</span>
          <span>6am</span>
          <span>12pm</span>
          <span>6pm</span>
          <span>Now</span>
        </div>
      </div>
    </div>

    <!-- Info Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <!-- Health Card -->
      <div class="bg-gh-bg border border-gh-border rounded-gh">
        <div class="p-4 border-b border-gh-border flex items-center gap-2">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M9.585.52a2.678 2.678 0 0 0-3.17 0l-.928.68a1.178 1.178 0 0 1-.518.215L3.83 1.59a2.678 2.678 0 0 0-2.24 2.24l-.175 1.14a1.178 1.178 0 0 1-.215.518l-.68.928a2.678 2.678 0 0 0 0 3.17l.68.928c.113.153.186.33.215.518l.175 1.138a2.678 2.678 0 0 0 2.24 2.24l1.138.175c.187.029.365.102.518.215l.928.68a2.678 2.678 0 0 0 3.17 0l.928-.68a1.17 1.17 0 0 1 .518-.215l1.138-.175a2.678 2.678 0 0 0 2.241-2.241l.175-1.138c.029-.187.102-.365.215-.518l.68-.928a2.678 2.678 0 0 0 0-3.17l-.68-.928a1.179 1.179 0 0 1-.215-.518L14.41 3.83a2.678 2.678 0 0 0-2.24-2.24l-1.138-.175a1.179 1.179 0 0 1-.518-.215ZM7.303 1.728l.928-.68a1.178 1.178 0 0 1 1.395 0l.928.68c.348.256.752.423 1.18.489l1.136.174a1.178 1.178 0 0 1 .987.987l.174 1.137c.066.427.233.831.489 1.18l.68.927a1.178 1.178 0 0 1 0 1.394l-.68.928a2.677 2.677 0 0 0-.489 1.18l-.174 1.136a1.178 1.178 0 0 1-.987.987l-1.137.175a2.677 2.677 0 0 0-1.18.488l-.927.68a1.178 1.178 0 0 1-1.394 0l-.928-.68a2.677 2.677 0 0 0-1.18-.488l-1.136-.175a1.178 1.178 0 0 1-.987-.987l-.175-1.136a2.677 2.677 0 0 0-.488-1.18l-.68-.928a1.178 1.178 0 0 1 0-1.394l.68-.927a2.68 2.68 0 0 0 .488-1.18l.175-1.137a1.178 1.178 0 0 1 .987-.987l1.136-.174a2.68 2.68 0 0 0 1.18-.489Z"
            ></path>
            <path
              d="m11.28 6.78-3.25 3.25a.75.75 0 0 1-1.06 0L4.72 7.78a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l1.47 1.47 2.72-2.72a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-.75.75Z"
            ></path>
          </svg>
          <h3 class="text-sm font-semibold text-gh-text">Status</h3>
        </div>
        <div class="p-4">
          <div id="health-indicator" class="flex items-center gap-3 mb-3">
            <div
              id="health-badge"
              class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gh-success-subtle"
            >
              <svg
                id="health-icon"
                class="w-4 h-4 text-gh-success"
                viewBox="0 0 16 16"
                fill="currentColor"
              >
                <path
                  d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"
                ></path>
              </svg>
              <span id="health-text" class="text-sm font-medium text-gh-success"
                >Connected</span
              >
            </div>
          </div>
          <div id="health-details" class="space-y-2 text-sm">
            <div class="flex items-center gap-2">
              <svg
                class="w-3 h-3 text-gh-success"
                viewBox="0 0 16 16"
                fill="currentColor"
              >
                <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"></path>
                <path
                  d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"
                ></path>
              </svg>
              <span id="health-ws" class="text-gh-text-secondary"
                >WebSocket: <span class="text-gh-text">Active</span></span
              >
            </div>
            <div class="flex items-center gap-2">
              <svg
                class="w-3 h-3 text-gh-success"
                viewBox="0 0 16 16"
                fill="currentColor"
              >
                <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"></path>
                <path
                  d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"
                ></path>
              </svg>
              <span id="health-session" class="text-gh-text-secondary"
                >Session: <span class="text-gh-text">Authenticated</span></span
              >
            </div>
          </div>
        </div>
      </div>

      <div class="bg-gh-bg border border-gh-border rounded-gh">
        <div class="p-4 border-b border-gh-border flex items-center gap-2">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M2 5.5a3.5 3.5 0 1 1 5.898 2.549 5.508 5.508 0 0 1 3.034 4.084.75.75 0 1 1-1.482.235 4 4 0 0 0-7.9 0 .75.75 0 0 1-1.482-.236A5.507 5.507 0 0 1 3.102 8.05 3.493 3.493 0 0 1 2 5.5ZM11 4a3.001 3.001 0 0 1 2.22 5.018 5.01 5.01 0 0 1 2.56 3.012.749.749 0 0 1-.885.954.752.752 0 0 1-.549-.514 3.507 3.507 0 0 0-2.522-2.372.75.75 0 0 1-.574-.73v-.352a.75.75 0 0 1 .416-.672A1.5 1.5 0 0 0 11 5.5.75.75 0 0 1 11 4Zm-5.5-.5a2 2 0 1 0-.001 3.999A2 2 0 0 0 5.5 3.5Z"
            ></path>
          </svg>
          <h3 class="text-sm font-semibold text-gh-text">Runtime</h3>
        </div>
        <div class="p-4 space-y-2 text-sm">
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Total Sessions</span>
            <span id="total-sessions" class="text-gh-text font-medium"
              ><span
                class="inline-block w-6 h-3 bg-gh-bg-tertiary rounded animate-pulse"
              ></span></span
            >
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Active Sessions</span>
            <span id="active-sessions" class="text-gh-text font-medium"
              ><span
                class="inline-block w-6 h-3 bg-gh-bg-tertiary rounded animate-pulse"
              ></span></span
            >
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Total Messages</span>
            <span id="total-messages" class="text-gh-text font-medium"
              ><span
                class="inline-block w-10 h-3 bg-gh-bg-tertiary rounded animate-pulse"
              ></span></span
            >
          </div>
        </div>
      </div>

      <div class="bg-gh-bg border border-gh-border rounded-gh">
        <div class="p-4 border-b border-gh-border flex items-center gap-2">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Zm7.251 10.324.004-5.073-.002-2.253A2.25 2.25 0 0 0 5.003 2.5H1.5v9h3.757a3.75 3.75 0 0 1 1.994.574ZM8.755 4.75l-.004 7.322a3.752 3.752 0 0 1 1.992-.572H14.5v-9h-3.495a2.25 2.25 0 0 0-2.25 2.25Z"
            ></path>
          </svg>
          <h3 class="text-sm font-semibold text-gh-text">Session Info</h3>
        </div>
        <div class="p-4 space-y-2 text-sm">
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Version</span>
            <span id="runtime-version" class="text-gh-text font-medium"
              ><span
                class="inline-block w-10 h-3 bg-gh-bg-tertiary rounded animate-pulse"
              ></span></span
            >
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Session ID</span>
            <span
              id="session-id-display"
              class="text-gh-text font-mono text-xs bg-gh-bg-secondary px-1.5 py-0.5 rounded"
              title={id}>{hashedId}</span
            >
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gh-text-secondary">Phone</span>
            <span id="phone-number" class="text-gh-text font-mono text-xs"
              ><span
                class="inline-block w-16 h-3 bg-gh-bg-tertiary rounded animate-pulse"
              ></span></span
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Groups Section -->
    <div class="bg-gh-bg border border-gh-border rounded-gh mb-6">
      <div
        class="p-4 border-b border-gh-border flex items-center justify-between"
      >
        <div class="flex items-center gap-2">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M5.5 3.5A2 2 0 0 1 7.5 1.5h1A2 2 0 0 1 10.5 3.5v1A2 2 0 0 1 8.5 6.5h-1A2 2 0 0 1 5.5 4.5ZM7.5 3a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5ZM2 10.5A2 2 0 0 1 4 8.5h1a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2Zm2-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5Zm5.5 0a2 2 0 0 1 2-2h1a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2Zm2-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5Z"
            ></path>
          </svg>
          <h2 class="text-sm font-semibold text-gh-text">Groups</h2>
          <span id="groups-count" class="text-xs text-gh-text-muted"
            >Loading...</span
          >
        </div>
        <button
          id="refresh-groups-btn"
          class="p-1.5 text-gh-text-secondary hover:text-gh-text hover:bg-gh-bg-tertiary rounded-gh transition-colors"
          data-tooltip="Refresh Groups"
        >
          <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
            <path
              d="M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z"
            ></path>
          </svg>
        </button>
      </div>
      <div
        id="groups-list"
        class="divide-y divide-gh-border max-h-64 overflow-y-auto"
      >
        <div class="p-4 text-center">
          <div
            class="inline-block w-40 h-4 bg-gh-bg-tertiary rounded animate-pulse"
          >
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-end gap-2">
      <button
        id="refresh-btn"
        class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-gh bg-gh-bg-secondary border border-gh-border text-gh-text hover:bg-gh-bg-tertiary transition-colors"
        data-tooltip="Refresh"
      >
        <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z"
          ></path>
        </svg>
      </button>
      <button
        id="disconnect-btn"
        class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-gh border border-gh-danger text-gh-danger hover:bg-gh-danger-subtle transition-colors"
        data-tooltip="Disconnect"
      >
        <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M11 1.75V3h2.25a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1 0-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75ZM4.496 6.675l.66 6.6a.25.25 0 0 0 .249.225h5.19a.25.25 0 0 0 .249-.225l.66-6.6a.75.75 0 0 1 1.492.149l-.66 6.6A1.748 1.748 0 0 1 10.595 15h-5.19a1.75 1.75 0 0 1-1.741-1.575l-.66-6.6a.75.75 0 1 1 1.492-.15ZM6.5 1.75V3h3V1.75a.25.25 0 0 0-.25-.25h-2.5a.25.25 0 0 0-.25.25Z"
          ></path>
        </svg>
      </button>
    </div>
  </main>

  <!-- Custom Tooltip -->
  <div id="custom-tooltip" class="fixed z-[100] px-2 py-1 text-xs font-medium text-black bg-white border border-gh-border rounded-md shadow-lg pointer-events-none opacity-0 transition-opacity duration-150 whitespace-nowrap" style="max-width: 250px;">
    <span id="custom-tooltip-text"></span>
  </div>

  <!-- Group Info Modal -->
  <div id="group-info-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" id="group-info-modal-backdrop"></div>
    <div
      class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg bg-gh-bg border border-gh-border rounded-gh shadow-xl max-h-[90vh] flex flex-col"
    >
      <div
        class="p-4 border-b border-gh-border flex items-center justify-between"
      >
        <div class="flex items-center gap-2">
          <svg
            class="w-4 h-4 text-gh-accent"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"
            ></path>
          </svg>
          <h2 id="group-info-title" class="text-sm font-semibold text-gh-text">Group Information</h2>
        </div>
        <button
          id="close-group-info-modal"
          class="p-1 text-gh-text-secondary hover:text-gh-text transition-colors"
        >
          <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor">
            <path
              d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"
            ></path>
          </svg>
        </button>
      </div>
      <div id="group-info-content" class="p-4 overflow-y-auto flex-1 space-y-4">
        <!-- Loading State -->
        <div id="group-info-loading" class="text-center py-8">
          <svg
            class="w-8 h-8 mx-auto text-gh-text-muted animate-spin"
            viewBox="0 0 16 16"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <circle
              cx="8"
              cy="8"
              r="6"
              stroke-dasharray="28"
              stroke-dashoffset="7"></circle>
          </svg>
          <p class="text-sm text-gh-text-muted mt-2">Loading group info...</p>
        </div>
        <!-- Info Sections (populated dynamically) -->
        <div id="group-info-data" class="hidden space-y-4"></div>
      </div>
    </div>
  </div>

  <!-- Group Actions Modal -->
  <div id="group-actions-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" id="group-actions-modal-backdrop"></div>
    <div
      class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg bg-gh-bg border border-gh-border rounded-gh shadow-xl max-h-[90vh] flex flex-col"
    >
      <div
        class="p-4 border-b border-gh-border flex items-center justify-between"
      >
        <div class="flex items-center gap-2">
          <svg
            class="w-4 h-4 text-gh-accent"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M8 0a8.2 8.2 0 0 1 .701.031C9.444.095 9.99.645 10.16 1.29l.288 1.107c.018.066.079.158.212.224.231.114.454.243.668.386.123.082.233.09.299.071l1.103-.303c.644-.176 1.392.021 1.82.63.27.385.506.792.704 1.218.315.675.111 1.422-.364 1.891l-.814.806c-.049.048-.098.147-.088.294.016.257.016.515 0 .772-.01.147.04.246.088.294l.814.806c.475.469.679 1.216.364 1.891a7.977 7.977 0 0 1-.704 1.217c-.428.61-1.176.807-1.82.63l-1.102-.302c-.067-.019-.177-.011-.3.071a5.909 5.909 0 0 1-.668.386c-.133.066-.194.158-.212.224l-.288 1.107c-.17.645-.715 1.195-1.458 1.26a8.006 8.006 0 0 1-1.402 0c-.743-.065-1.289-.615-1.458-1.26l-.289-1.106c-.018-.066-.079-.158-.212-.225a5.893 5.893 0 0 1-.668-.386c-.123-.082-.233-.09-.299-.071l-1.103.303c-.644.176-1.392-.021-1.82-.63a8.004 8.004 0 0 1-.704-1.217c-.315-.675-.111-1.422.363-1.891l.815-.806c.05-.048.098-.147.088-.294a6.854 6.854 0 0 1 0-.772c.01-.147-.04-.246-.088-.294l-.815-.806C.635 6.045.431 5.298.746 4.623a7.92 7.92 0 0 1 .704-1.217c.428-.61 1.176-.807 1.82-.63l1.102.302c.067.019.177.011.3-.071.214-.143.437-.272.668-.386.133-.066.194-.158.212-.224l.289-1.106C6.009.645 6.556.095 7.299.03 7.53.01 7.764 0 8 0Zm-.571 1.525c-.036.003-.108.036-.137.146l-.289 1.106c-.1.386-.396.71-.771.9-.31.157-.6.346-.87.562-.262.211-.597.3-.912.214l-1.103-.303c-.109-.03-.175.016-.195.045-.22.312-.412.644-.573.99-.014.031-.021.11.059.19l.815.806c.278.275.41.657.397 1.036-.007.21-.007.42 0 .628.013.379-.119.762-.397 1.037l-.814.806c-.08.08-.073.159-.059.19.161.347.353.678.573.99.02.029.086.074.195.045l1.103-.303c.315-.086.65.003.912.214.27.216.56.405.87.562.375.19.671.514.77.9l.29 1.106c.028.11.1.143.136.146a6.66 6.66 0 0 0 1.142 0c.036-.003.108-.036.137-.146l.289-1.106c.1-.386.396-.71.771-.9.31-.157.6-.346.87-.562.262-.211.597-.3.912-.214l1.103.303c.109.029.175-.016.194-.045.22-.312.413-.644.573-.99.015-.031.022-.11-.058-.19l-.815-.806a1.337 1.337 0 0 1-.397-1.037c.007-.21.007-.42 0-.628-.013-.379.119-.762.397-1.036l.814-.806c.08-.08.073-.159.059-.19a6.964 6.964 0 0 0-.574-.99c-.02-.029-.085-.074-.194-.045l-1.103.303c-.315.086-.65-.003-.912-.214a5.421 5.421 0 0 0-.87-.562c-.375-.19-.67-.514-.77-.9l-.29-1.106c-.028-.11-.1-.143-.136-.146a6.66 6.66 0 0 0-1.142 0ZM11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm-1.5 0a1.5 1.5 0 1 0-3.001.001A1.5 1.5 0 0 0 9.5 8Z"
            ></path>
          </svg>
          <h2 id="group-actions-title" class="text-sm font-semibold text-gh-text">Group Actions</h2>
        </div>
        <button
          id="close-group-actions-modal"
          class="p-1 text-gh-text-secondary hover:text-gh-text transition-colors"
        >
          <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor">
            <path
              d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"
            ></path>
          </svg>
        </button>
      </div>
      <div id="group-actions-content" class="p-4 overflow-y-auto flex-1">
        <!-- Loading State -->
        <div id="group-actions-loading" class="text-center py-8 hidden">
          <svg
            class="w-8 h-8 mx-auto text-gh-text-muted animate-spin"
            viewBox="0 0 16 16"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <circle
              cx="8"
              cy="8"
              r="6"
              stroke-dasharray="28"
              stroke-dashoffset="7"></circle>
          </svg>
          <p class="text-sm text-gh-text-muted mt-2">Executing action...</p>
        </div>
        <!-- Actions List -->
        <div id="group-actions-list" class="space-y-3">
          <!-- Toggle Actions (hidden for communities) -->
          <div id="group-settings-section" class="bg-gh-bg-secondary rounded-gh p-3">
            <h3 class="text-xs font-semibold text-gh-text-muted uppercase tracking-wider mb-3">Settings</h3>
            <div class="space-y-2">
              <!-- Mute/Unmute Toggle -->
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <svg class="w-4 h-4 text-gh-text-secondary" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 2.75a.75.75 0 0 0-1.238-.57L3.472 5H1.75A1.75 1.75 0 0 0 0 6.75v2.5C0 10.216.784 11 1.75 11h1.723l3.289 2.82A.75.75 0 0 0 8 13.25ZM4.238 6.32 6.5 4.38v7.24L4.238 9.68a.75.75 0 0 0-.488-.18H1.75a.25.25 0 0 1-.25-.25v-2.5a.25.25 0 0 1 .25-.25h1.999a.75.75 0 0 0 .489-.18Z"/>
                  </svg>
                  <span class="text-sm text-gh-text">Mute Group</span>
                </div>
                <button
                  id="toggle-mute"
                  class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none bg-gh-bg-tertiary"
                  role="switch"
                  aria-checked="false"
                  data-action="mute"
                >
                  <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0"></span>
                </button>
              </div>
              <!-- Lock/Unlock Toggle -->
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <svg class="w-4 h-4 text-gh-text-secondary" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M4 4a4 4 0 0 1 8 0v2h.25c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 12.25 15h-8.5A1.75 1.75 0 0 1 2 13.25v-5.5C2 6.784 2.784 6 3.75 6H4Zm8.25 3.5h-8.5a.25.25 0 0 0-.25.25v5.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-5.5a.25.25 0 0 0-.25-.25ZM10.5 6V4a2.5 2.5 0 1 0-5 0v2Z"/>
                  </svg>
                  <span class="text-sm text-gh-text">Lock Settings</span>
                </div>
                <button
                  id="toggle-lock"
                  class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none bg-gh-bg-tertiary"
                  role="switch"
                  aria-checked="false"
                  data-action="lock"
                >
                  <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0"></span>
                </button>
              </div>
            </div>
          </div>

          <!-- Community Actions (only for communities) -->
          <div id="community-actions-section" class="bg-gh-bg-secondary rounded-gh p-3 hidden">
            <h3 class="text-xs font-semibold text-gh-text-muted uppercase tracking-wider mb-3">Community</h3>
            <div class="space-y-2">
              <button data-param-action="linkGroup" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gh-text hover:bg-gh-bg-tertiary rounded-gh transition-colors text-left">
                <svg class="w-4 h-4 text-gh-success flex-shrink-0" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"/>
                  <path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"/>
                </svg>
                <span>Link Group</span>
              </button>
              <button data-param-action="unlinkGroup" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gh-text hover:bg-gh-bg-tertiary rounded-gh transition-colors text-left">
                <svg class="w-4 h-4 text-gh-danger flex-shrink-0" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"/>
                  <path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"/>
                </svg>
                <span>Unlink Group</span>
              </button>
            </div>
          </div>

          <!-- Parameter Actions -->
          <div class="bg-gh-bg-secondary rounded-gh p-3">
            <h3 id="edit-section-title" class="text-xs font-semibold text-gh-text-muted uppercase tracking-wider mb-3">Edit Group</h3>
            <div class="space-y-2">
              <button data-param-action="name" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gh-text hover:bg-gh-bg-tertiary rounded-gh transition-colors text-left">
                <svg class="w-4 h-4 text-gh-text-secondary flex-shrink-0" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M11.013 1.427a1.75 1.75 0 0 1 2.474 0l1.086 1.086a1.75 1.75 0 0 1 0 2.474l-8.61 8.61c-.21.21-.47.364-.756.445l-3.251.93a.75.75 0 0 1-.927-.928l.929-3.25c.081-.286.235-.547.445-.758l8.61-8.61Zm.176 4.823L9.75 4.81l-6.286 6.287a.253.253 0 0 0-.064.108l-.558 1.953 1.953-.558a.253.253 0 0 0 .108-.064Zm1.238-3.763a.25.25 0 0 0-.354 0L10.811 3.75l1.439 1.44 1.263-1.263a.25.25 0 0 0 0-.354Z"/>
                </svg>
                <span>Change Name</span>
              </button>
              <button data-param-action="description" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gh-text hover:bg-gh-bg-tertiary rounded-gh transition-colors text-left">
                <svg class="w-4 h-4 text-gh-text-secondary flex-shrink-0" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Z"/>
                </svg>
                <span>Change Description</span>
              </button>
              <button data-param-action="ephemeral" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gh-text hover:bg-gh-bg-tertiary rounded-gh transition-colors text-left">
                <svg class="w-4 h-4 text-gh-text-secondary flex-shrink-0" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M5.75.75A.75.75 0 0 1 6.5 0h3a.75.75 0 0 1 0 1.5h-.75v1l3.497 5.636a3.003 3.003 0 0 1-5.077 3.206L3.998 8.527a.75.75 0 0 1 .253-1.03l.003-.002a.75.75 0 0 1 1.03.254L7 10.564a1.5 1.5 0 0 0 2.536-1.6L5.75 2.5v-1a.75.75 0 0 1 0-1.5ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0ZM8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Z"/>
                </svg>
                <span>Disappearing Messages</span>
              </button>
            </div>
          </div>

          <!-- Participant Actions -->
          <div class="bg-gh-bg-secondary rounded-gh p-3">
            <h3 class="text-xs font-semibold text-gh-text-muted uppercase tracking-wider mb-3">Participants</h3>
            <div class="space-y-2">
              <button data-param-action="add" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gh-text hover:bg-gh-bg-tertiary rounded-gh transition-colors text-left">
                <svg class="w-4 h-4 text-gh-success flex-shrink-0" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M7.75 2a.75.75 0 0 1 .75.75V7h4.25a.75.75 0 0 1 0 1.5H8.5v4.25a.75.75 0 0 1-1.5 0V8.5H2.75a.75.75 0 0 1 0-1.5H7V2.75A.75.75 0 0 1 7.75 2Z"/>
                </svg>
                <span>Add Participant</span>
              </button>
              <button data-param-action="remove" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gh-text hover:bg-gh-bg-tertiary rounded-gh transition-colors text-left">
                <svg class="w-4 h-4 text-gh-danger flex-shrink-0" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M11 1.75V3h2.25a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1 0-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75ZM4.496 6.675l.66 6.6a.25.25 0 0 0 .249.225h5.19a.25.25 0 0 0 .249-.225l.66-6.6a.75.75 0 0 1 1.492.149l-.66 6.6A1.748 1.748 0 0 1 10.595 15h-5.19a1.75 1.75 0 0 1-1.741-1.575l-.66-6.6a.75.75 0 1 1 1.492-.15ZM6.5 1.75V3h3V1.75a.25.25 0 0 0-.25-.25h-2.5a.25.25 0 0 0-.25.25Z"/>
                </svg>
                <span>Remove Participant</span>
              </button>
              <button data-param-action="promote" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gh-text hover:bg-gh-bg-tertiary rounded-gh transition-colors text-left">
                <svg class="w-4 h-4 text-gh-warning flex-shrink-0" viewBox="0 0 16 16" fill="currentColor">
                  <path d="m4.427.879 1.164-.377a.695.695 0 0 1 .883.586l.108 1.209a.695.695 0 0 0 .587.587l1.21.108a.695.695 0 0 1 .585.883l-.377 1.164a.695.695 0 0 0 .183.81l.861.875a.695.695 0 0 1 0 1.047l-.86.876a.695.695 0 0 0-.184.81l.377 1.164a.695.695 0 0 1-.585.883l-1.21.108a.695.695 0 0 0-.587.587l-.108 1.21a.695.695 0 0 1-.883.585l-1.164-.377a.695.695 0 0 0-.81.183l-.875.861a.695.695 0 0 1-1.047 0l-.875-.86a.695.695 0 0 0-.81-.184l-1.164.377a.695.695 0 0 1-.883-.585l-.108-1.21a.695.695 0 0 0-.587-.587L.879 11.57a.695.695 0 0 1-.585-.883l.377-1.164a.695.695 0 0 0-.183-.81L.08 7.74a.695.695 0 0 1 0-1.047l.408-.415a.695.695 0 0 0 .183-.81L.294 4.305a.695.695 0 0 1 .585-.883l1.21-.108a.695.695 0 0 0 .587-.587l.108-1.21a.695.695 0 0 1 .883-.585l1.164.377a.695.695 0 0 0 .81-.183l.875-.86a.695.695 0 0 1 1.047 0l.875.86a.695.695 0 0 0 .81.183Z"/>
                </svg>
                <span>Promote to Admin</span>
              </button>
              <button data-param-action="demote" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gh-text hover:bg-gh-bg-tertiary rounded-gh transition-colors text-left">
                <svg class="w-4 h-4 text-gh-text-secondary flex-shrink-0" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M3.47 7.78a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0l4.25 4.25a.751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018L8.5 4.31v7.94a.75.75 0 0 1-1.5 0V4.31L3.53 7.78a.75.75 0 0 1-1.06 0Z"/>
                </svg>
                <span>Demote from Admin</span>
              </button>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="bg-gh-bg-secondary rounded-gh p-3">
            <h3 class="text-xs font-semibold text-gh-text-muted uppercase tracking-wider mb-3">Links</h3>
            <div class="space-y-2">
              <button data-action="inviteCode" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gh-text hover:bg-gh-bg-tertiary rounded-gh transition-colors text-left">
                <svg class="w-4 h-4 text-gh-link flex-shrink-0" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"/>
                  <path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"/>
                </svg>
                <span>Get Invite Link</span>
              </button>
              <button data-action="revokeInvite" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gh-text hover:bg-gh-bg-tertiary rounded-gh transition-colors text-left">
                <svg class="w-4 h-4 text-gh-warning flex-shrink-0" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z"/>
                </svg>
                <span>Revoke Invite Link</span>
              </button>
            </div>
          </div>

          <!-- Danger Zone -->
          <div class="bg-gh-danger-subtle rounded-gh p-3 border border-gh-danger/20">
            <h3 class="text-xs font-semibold text-gh-danger uppercase tracking-wider mb-3">Danger Zone</h3>
            <div class="space-y-2">
              <button data-action="kickAll" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gh-danger hover:bg-gh-danger/10 rounded-gh transition-colors text-left">
                <svg class="w-4 h-4 flex-shrink-0" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M11 1.75V3h2.25a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1 0-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75Z"/>
                </svg>
                <span>Kick All Members</span>
              </button>
              <button data-action="leave" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-white bg-gh-danger hover:bg-red-700 rounded-gh transition-colors text-left">
                <svg class="w-4 h-4 flex-shrink-0" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M2 2.75C2 1.784 2.784 1 3.75 1h2.5a.75.75 0 0 1 0 1.5h-2.5a.25.25 0 0 0-.25.25v10.5c0 .138.112.25.25.25h2.5a.75.75 0 0 1 0 1.5h-2.5A1.75 1.75 0 0 1 2 13.25Zm10.44 4.5-1.97-1.97a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215l3.25 3.25a.75.75 0 0 1 0 1.06l-3.25 3.25a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734l1.97-1.97H6.75a.75.75 0 0 1 0-1.5Z"/>
                </svg>
                <span>Leave Group</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Parameter Input Modal -->
  <div id="param-input-modal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/50" id="param-input-modal-backdrop"></div>
    <div
      class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm bg-gh-bg border border-gh-border rounded-gh shadow-xl"
    >
      <div class="p-4 border-b border-gh-border">
        <h2 id="param-input-title" class="text-sm font-semibold text-gh-text">Enter Value</h2>
      </div>
      <div class="p-4">
        <div id="param-input-field" class="mb-4">
          <!-- Input field will be dynamically inserted here -->
        </div>
        <div id="param-input-error" class="p-3 rounded-gh bg-gh-danger-subtle border border-gh-danger text-gh-danger text-sm hidden mb-4"></div>
        <div class="flex gap-2">
          <button
            id="param-input-cancel"
            class="flex-1 py-1.5 px-4 text-sm font-medium rounded-gh bg-gh-bg-secondary border border-gh-border text-gh-text hover:bg-gh-bg-tertiary transition-colors"
          >
            Cancel
          </button>
          <button
            id="param-input-execute"
            class="flex-1 py-1.5 px-4 text-sm font-medium rounded-gh bg-gh-success text-white hover:bg-green-700 transition-colors"
          >
            Execute
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Result Modal -->
  <div id="action-result-modal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/50" id="action-result-modal-backdrop"></div>
    <div
      class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm bg-gh-bg border border-gh-border rounded-gh shadow-xl"
    >
      <div class="p-4 border-b border-gh-border">
        <h2 id="action-result-title" class="text-sm font-semibold text-gh-text">Result</h2>
      </div>
      <div class="p-4">
        <div id="action-result-content" class="text-sm text-gh-text-secondary mb-4"></div>
        <button
          id="action-result-close"
          class="w-full py-1.5 px-4 text-sm font-medium rounded-gh bg-gh-bg-secondary border border-gh-border text-gh-text hover:bg-gh-bg-tertiary transition-colors"
        >
          Close
        </button>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { date } from "astro:schema";
  import { api } from "../../lib/api";

  const sessionId = window.location.pathname.split("/").pop() || "";

  interface SessionStats {
    messagesReceived: number;
    messagesSent: number;
  }

  interface HourlyActivity {
    hourlyData: number[];
    peakHour: string;
    average: number;
  }

  interface SessionData {
    id: string;
    phone_number: string;
    created_at: number;
    status: "active" | "inactive" | "pairing" | "paused_user";
    user_info: {
      id: string;
      lid: string;
      name: string;
    };
    stats: SessionStats;
    hourlyActivity?: HourlyActivity;
  }

  function formatRelativeTime(timestamp: number): string {
    const now = Date.now();
    const diff = now - timestamp;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

    if (days > 0) {
      return `${days}d ${hours}h ago`;
    } else if (hours > 0) {
      const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      return `${hours}h ${mins}m ago`;
    } else {
      const mins = Math.floor(diff / (1000 * 60));
      return mins > 0 ? `${mins}m ago` : "Just now";
    }
  }

  function updateSessionDisplay(
    sessionData: SessionData & {
      stats: SessionStats;
      hourlyActivity?: HourlyActivity;
    }
  ) {
    const displayName =
      sessionData.user_info.name || `+${sessionData.phone_number}`;
    const userNameEl = document.getElementById("user-name");
    if (userNameEl) userNameEl.textContent = displayName;

    const phoneEl = document.getElementById("phone-number");
    if (phoneEl) phoneEl.textContent = `+${sessionData.phone_number}`;

    if (sessionData.stats) {
      const messagesCountEl = document.getElementById("messages-count");
      const messagesSentEl = document.getElementById("messages-sent");

      if (messagesCountEl) {
        messagesCountEl.textContent = (
          sessionData.stats.messagesReceived + sessionData.stats.messagesSent
        ).toLocaleString();
      }
      if (messagesSentEl) {
        messagesSentEl.textContent =
          sessionData.stats.messagesSent.toLocaleString();
      }
    }

    if (sessionData.created_at) {
      const createdEl = document.getElementById("created-date");
      if (createdEl)
        createdEl.textContent = formatRelativeTime(sessionData.created_at);
    }

    if (sessionData.hourlyActivity) {
      updateActivityChart(sessionData.hourlyActivity);
    }

    updateHealthStatus(sessionData.status);
  }

  function updateHealthStatus(status: string) {
    const statusEl = document.getElementById("session-status");
    const healthBadge = document.getElementById("health-badge");
    const healthIcon = document.getElementById("health-icon");
    const healthText = document.getElementById("health-text");
    const healthWs = document.getElementById("health-ws");
    const healthSession = document.getElementById("health-session");

    if (!statusEl || !healthBadge || !healthIcon || !healthText) return;

    if (status === "active") {
      statusEl.innerHTML = `
        <svg class="w-4 h-4 text-gh-success" viewBox="0 0 16 16" fill="currentColor">
          <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/>
        </svg>
        <span class="text-gh-success font-medium">Active</span>
      `;
      healthBadge.className =
        "flex items-center gap-2 px-3 py-1.5 rounded-full bg-gh-success-subtle";
      healthIcon.setAttribute("class", "w-4 h-4 text-gh-success");
      healthText.textContent = "Connected";
      healthText.className = "text-sm font-medium text-gh-success";

      if (healthWs)
        healthWs.innerHTML =
          'WebSocket: <span class="text-gh-text">Active</span>';
      if (healthSession)
        healthSession.innerHTML =
          'Session: <span class="text-gh-text">Authenticated</span>';
    } else if (status === "pairing") {
      statusEl.innerHTML = `
        <svg class="w-4 h-4 text-gh-warning animate-pulse" viewBox="0 0 16 16" fill="currentColor">
          <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"/>
          <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"/>
        </svg>
        <span class="text-gh-warning font-medium">Pairing</span>
      `;
      healthBadge.className =
        "flex items-center gap-2 px-3 py-1.5 rounded-full bg-gh-warning-subtle";
      healthIcon.setAttribute("class", "w-4 h-4 text-gh-warning");
      healthText.textContent = "Pairing";
      healthText.className = "text-sm font-medium text-gh-warning";

      if (healthWs)
        healthWs.innerHTML =
          'WebSocket: <span class="text-gh-text">Active</span>';
      if (healthSession)
        healthSession.innerHTML =
          'Session: <span class="text-gh-warning">Awaiting scan</span>';
    } else {
      statusEl.innerHTML = `
        <svg class="w-4 h-4 text-gh-text-muted" viewBox="0 0 16 16" fill="currentColor">
          <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"/>
          <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"/>
        </svg>
        <span class="text-gh-text-muted font-medium">Offline</span>
      `;
      healthBadge.className =
        "flex items-center gap-2 px-3 py-1.5 rounded-full bg-gh-bg-secondary";
      healthIcon.setAttribute("class", "w-4 h-4 text-gh-text-muted");
      healthText.textContent = "Disconnected";
      healthText.className = "text-sm font-medium text-gh-text-muted";

      if (healthWs)
        healthWs.innerHTML =
          'WebSocket: <span class="text-gh-text-muted">Inactive</span>';
      if (healthSession)
        healthSession.innerHTML =
          'Session: <span class="text-gh-text-muted">Disconnected</span>';
    }
  }

  function escapeHtml(text: string): string {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  function formatChartHour(index: number): string {
    const currentHour = new Date().getHours();
    // Index 0 = 23 hours ago, index 23 = current hour
    const hour = (currentHour - (23 - index) + 24) % 24;
    const h = hour % 12 || 12;
    const ampm = hour < 12 ? "am" : "pm";
    return `${h}${ampm}`;
  }

  function updateActivityChart(hourlyActivity: HourlyActivity) {
    const chartEl = document.getElementById("activity-chart");
    const peakHourEl = document.getElementById("peak-hour");
    const avgHourEl = document.getElementById("avg-hour");
    const tooltipEl = document.getElementById("chart-tooltip");

    if (!chartEl) return;

    // Update stats
    if (peakHourEl) peakHourEl.textContent = hourlyActivity.peakHour;
    if (avgHourEl) avgHourEl.textContent = hourlyActivity.average.toString();

    // Find max value for scaling
    const maxValue = Math.max(...hourlyActivity.hourlyData, 1);

    // Generate chart bars
    const bars = hourlyActivity.hourlyData
      .map((count, index) => {
        const heightPercent = (count / maxValue) * 100;
        const minHeight = count > 0 ? 4 : 8; // Taller minimum for empty bars to show placeholder
        const height = Math.max(heightPercent, minHeight);

        // Color intensity based on value - faded gray for no data
        const intensity = count / maxValue;
        let bgClass = "bg-gh-bg-tertiary/50"; // Faded gray placeholder for no data
        if (count > 0) {
          if (intensity > 0.7) {
            bgClass = "bg-gh-success";
          } else if (intensity > 0.4) {
            bgClass = "bg-gh-success/70";
          } else {
            bgClass = "bg-gh-success/40";
          }
        }

        return `<div 
        class="flex-1 ${bgClass} rounded-t transition-all duration-300 cursor-pointer hover:opacity-80 chart-bar" 
        style="height: ${height}%"
        data-count="${count}"
        data-hour="${formatChartHour(index)}"
      ></div>`;
      })
      .join("");

    chartEl.innerHTML = bars;

    // Use event delegation for tooltip - single listener on chart container
    // Clear existing listeners by cloning the element
    const newChartEl = chartEl.cloneNode(true) as HTMLElement;
    chartEl.parentNode?.replaceChild(newChartEl, chartEl);

    if (tooltipEl) {
      newChartEl.addEventListener("mouseover", (e) => {
        const target = (e.target as HTMLElement).closest(
          ".chart-bar"
        ) as HTMLElement | null;
        if (!target) return;

        const count = target.dataset.count || "0";
        const hour = target.dataset.hour || "";
        const countNum = parseInt(count, 10);

        tooltipEl.textContent = `${hour}: ${count} message${countNum !== 1 ? "s" : ""}`;
        tooltipEl.style.opacity = "1";

        // Position tooltip above the bar using top positioning
        const rect = target.getBoundingClientRect();
        const containerRect = newChartEl.parentElement?.getBoundingClientRect();
        if (containerRect) {
          const left = rect.left - containerRect.left + rect.width / 2;
          const top = rect.top - containerRect.top - 28; // Position above bar

          tooltipEl.style.left = `${left}px`;
          tooltipEl.style.top = `${top}px`;
          tooltipEl.style.bottom = "auto";
        }
      });

      newChartEl.addEventListener("mouseout", (e) => {
        const target = (e.target as HTMLElement).closest(".chart-bar");
        const relatedTarget = (e as MouseEvent)
          .relatedTarget as HTMLElement | null;
        if (
          target &&
          (!relatedTarget || !relatedTarget.closest(".chart-bar"))
        ) {
          tooltipEl.style.opacity = "0";
        }
      });
    }
  }

  api.onStats((data) => {
    if (data.type === "stats") {
      if (data.data?.overall) {
        const totalSessionsEl = document.getElementById("total-sessions");
        const activeSessionsEl = document.getElementById("active-sessions");
        const totalMessagesEl = document.getElementById("total-messages");

        if (totalSessionsEl)
          totalSessionsEl.textContent =
            data.data.overall.totalSessions?.toString() ?? "0";
        if (activeSessionsEl)
          activeSessionsEl.textContent =
            data.data.overall.activeSessions?.toString() ?? "0";
        if (totalMessagesEl)
          totalMessagesEl.textContent =
            data.data.overall.totalMessages?.toLocaleString() ?? "0";
      }

      if (data.data?.sessions) {
        const sessionData = data.data.sessions.find(
          (s: { id: string }) => s.id === sessionId
        );
        if (sessionData) {
          const data = sessionData;
          updateSessionDisplay(data);
        }
      }
    }
  });

  api.getConfig().then((result) => {
    if (result.success && result.data) {
      const versionEl = document.getElementById("runtime-version");
      if (versionEl) versionEl.textContent = `v${result.data.version}`;
    }
  });

  function loadGroups() {
    api.sendAction("getGroups", { sessionId }).then((result) => {
      const groupsList = document.getElementById("groups-list");
      const groupsCount = document.getElementById("groups-count");

      if (!groupsList || !groupsCount) return;

      if (result.success && result.data) {
        const groups = result?.data?.groups || [];
        groupsCount.textContent = `${groups.length} group${groups.length !== 1 ? "s" : ""}`;

        if (groups.length === 0) {
          groupsList.innerHTML = `
            <div class="p-6 text-center">
              <svg class="w-8 h-8 mx-auto mb-2 text-gh-text-muted" viewBox="0 0 16 16" fill="currentColor">
                <path d="M5.5 3.5A2 2 0 0 1 7.5 1.5h1A2 2 0 0 1 10.5 3.5v1A2 2 0 0 1 8.5 6.5h-1A2 2 0 0 1 5.5 4.5ZM7.5 3a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5ZM2 10.5A2 2 0 0 1 4 8.5h1a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2Zm2-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5Zm5.5 0a2 2 0 0 1 2-2h1a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2Zm2-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5Z"/>
              </svg>
              <p class="text-xs text-gh-text-muted">No groups found</p>
            </div>
          `;
        } else {
          groupsList.innerHTML = groups
            .map(
              (group: {
                id: string;
                subject: string;
                participantCount: number;
              }) => `
            <div class="flex items-center justify-between p-3 hover:bg-gh-bg-secondary transition-colors" data-group-id="${escapeHtml(group.id)}">
              <div class="flex items-center gap-3 flex-1 min-w-0">
                <svg class="w-4 h-4 text-gh-text-secondary flex-shrink-0" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M5.5 3.5A2 2 0 0 1 7.5 1.5h1A2 2 0 0 1 10.5 3.5v1A2 2 0 0 1 8.5 6.5h-1A2 2 0 0 1 5.5 4.5ZM7.5 3a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5ZM2 10.5A2 2 0 0 1 4 8.5h1a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2Zm2-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5Zm5.5 0a2 2 0 0 1 2-2h1a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2Zm2-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5Z"/>
                </svg>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gh-text truncate">${escapeHtml(group.subject)}</p>
                  <p class="text-xs text-gh-text-muted">${group.participantCount} member${group.participantCount !== 1 ? "s" : ""}</p>
                </div>
              </div>
              <div class="flex items-center gap-1">
                <button 
                  class="p-1.5 text-gh-text-secondary hover:text-gh-accent hover:bg-gh-bg-tertiary rounded-gh transition-colors"
                  data-group-info="${escapeHtml(group.id)}"
                  data-tooltip="View Info"
                >
                  <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/>
                  </svg>
                </button>
                <button 
                  class="p-1.5 text-gh-text-secondary hover:text-gh-success hover:bg-gh-bg-tertiary rounded-gh transition-colors"
                  data-group-actions="${escapeHtml(group.id)}"
                  data-tooltip="Actions"
                >
                  <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 0a8.2 8.2 0 0 1 .701.031C9.444.095 9.99.645 10.16 1.29l.288 1.107c.018.066.079.158.212.224.231.114.454.243.668.386.123.082.233.09.299.071l1.103-.303c.644-.176 1.392.021 1.82.63.27.385.506.792.704 1.218.315.675.111 1.422-.364 1.891l-.814.806c-.049.048-.098.147-.088.294.016.257.016.515 0 .772-.01.147.04.246.088.294l.814.806c.475.469.679 1.216.364 1.891a7.977 7.977 0 0 1-.704 1.217c-.428.61-1.176.807-1.82.63l-1.102-.302c-.067-.019-.177-.011-.3.071a5.909 5.909 0 0 1-.668.386c-.133.066-.194.158-.212.224l-.288 1.107c-.17.645-.715 1.195-1.458 1.26a8.006 8.006 0 0 1-1.402 0c-.743-.065-1.289-.615-1.458-1.26l-.289-1.106c-.018-.066-.079-.158-.212-.225a5.893 5.893 0 0 1-.668-.386c-.123-.082-.233-.09-.299-.071l-1.103.303c-.644.176-1.392-.021-1.82-.63a8.004 8.004 0 0 1-.704-1.217c-.315-.675-.111-1.422.363-1.891l.815-.806c.05-.048.098-.147.088-.294a6.854 6.854 0 0 1 0-.772c.01-.147-.04-.246-.088-.294l-.815-.806C.635 6.045.431 5.298.746 4.623a7.92 7.92 0 0 1 .704-1.217c.428-.61 1.176-.807 1.82-.63l1.102.302c.067.019.177.011.3-.071.214-.143.437-.272.668-.386.133-.066.194-.158.212-.224l.289-1.106C6.009.645 6.556.095 7.299.03 7.53.01 7.764 0 8 0Zm-.571 1.525c-.036.003-.108.036-.137.146l-.289 1.106c-.1.386-.396.71-.771.9-.31.157-.6.346-.87.562-.262.211-.597.3-.912.214l-1.103-.303c-.109-.03-.175.016-.195.045-.22.312-.412.644-.573.99-.014.031-.021.11.059.19l.815.806c.278.275.41.657.397 1.036-.007.21-.007.42 0 .628.013.379-.119.762-.397 1.037l-.814.806c-.08.08-.073.159-.059.19.161.347.353.678.573.99.02.029.086.074.195.045l1.103-.303c.315-.086.65.003.912.214.27.216.56.405.87.562.375.19.671.514.77.9l.29 1.106c.028.11.1.143.136.146a6.66 6.66 0 0 0 1.142 0c.036-.003.108-.036.137-.146l.289-1.106c.1-.386.396-.71.771-.9.31-.157.6-.346.87-.562.262-.211.597-.3.912-.214l1.103.303c.109.029.175-.016.194-.045.22-.312.413-.644.573-.99.015-.031.022-.11-.058-.19l-.815-.806a1.337 1.337 0 0 1-.397-1.037c.007-.21.007-.42 0-.628-.013-.379.119-.762.397-1.036l.814-.806c.08-.08.073-.159.059-.19a6.964 6.964 0 0 0-.574-.99c-.02-.029-.085-.074-.194-.045l-1.103.303c-.315.086-.65-.003-.912-.214a5.421 5.421 0 0 0-.87-.562c-.375-.19-.67-.514-.77-.9l-.29-1.106c-.028-.11-.1-.143-.136-.146a6.66 6.66 0 0 0-1.142 0ZM11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm-1.5 0a1.5 1.5 0 1 0-3.001.001A1.5 1.5 0 0 0 9.5 8Z"/>
                  </svg>
                </button>
              </div>
            </div>
          `
            )
            .join("");

          // Add click handlers for group info and actions buttons
          groupsList.addEventListener("click", handleGroupListClick);
        }
      } else {
        groupsCount.textContent = "Error";
        groupsList.innerHTML = `
          <div class="p-4 text-center">
            <p class="text-sm text-gh-danger">Failed to load groups</p>
          </div>
        `;
      }
    });
  }

  // Handle clicks on group info and actions buttons
  function handleGroupListClick(e: Event) {
    const target = e.target as HTMLElement;
    const infoBtn = target.closest("[data-group-info]") as HTMLElement | null;
    const actionsBtn = target.closest("[data-group-actions]") as HTMLElement | null;

    if (infoBtn) {
      const groupId = infoBtn.getAttribute("data-group-info");
      if (groupId) openGroupInfoModal(groupId);
    }

    if (actionsBtn) {
      const groupId = actionsBtn.getAttribute("data-group-actions");
      if (groupId) openGroupActionsModal(groupId);
    }
  }

  // Current group being operated on
  let currentGroupId: string | null = null;
  let currentGroupMetadata: any = null;

  // Group Info Modal
  const groupInfoModal = document.getElementById("group-info-modal");
  const groupInfoModalBackdrop = document.getElementById("group-info-modal-backdrop");
  const closeGroupInfoModal = document.getElementById("close-group-info-modal");
  const groupInfoTitle = document.getElementById("group-info-title");
  const groupInfoLoading = document.getElementById("group-info-loading");
  const groupInfoData = document.getElementById("group-info-data");

  function openGroupInfoModal(groupId: string) {
    currentGroupId = groupId;
    groupInfoModal?.classList.remove("hidden");
    groupInfoLoading?.classList.remove("hidden");
    groupInfoData?.classList.add("hidden");

    api.sendAction("getGroupMetadata", { sessionId, groupId }).then((result) => {
      groupInfoLoading?.classList.add("hidden");

      if (result.success && result.data) {
        const metadata = result.data as any;
        currentGroupMetadata = metadata;

        if (groupInfoTitle) {
          groupInfoTitle.textContent = metadata.subject || "Group Information";
        }

        if (groupInfoData) {
          const creationDate = metadata.creation
            ? new Date(metadata.creation * 1000).toLocaleDateString()
            : "Unknown";

          const adminCount = (metadata.participants || []).filter(
            (p: any) => p.isAdmin || p.admin === "admin" || p.admin === "superadmin"
          ).length;

          groupInfoData.innerHTML = `
            <!-- Basic Info -->
            <div class="bg-gh-bg-secondary rounded-gh p-3">
              <h3 class="text-xs font-semibold text-gh-text-muted uppercase tracking-wider mb-2">Basic Info</h3>
              <div class="space-y-2">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gh-text-secondary">Name</span>
                  <span class="text-sm font-medium text-gh-text">${escapeHtml(metadata.subject || "Unknown")}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gh-text-secondary">Created</span>
                  <span class="text-sm font-medium text-gh-text">${creationDate}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gh-text-secondary">Members</span>
                  <span class="text-sm font-medium text-gh-text">${metadata.size || metadata.participants?.length || 0}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gh-text-secondary">Admins</span>
                  <span class="text-sm font-medium text-gh-text">${adminCount}</span>
                </div>
              </div>
            </div>

            <!-- Description -->
            ${metadata.desc ? `
            <div class="bg-gh-bg-secondary rounded-gh p-3">
              <h3 class="text-xs font-semibold text-gh-text-muted uppercase tracking-wider mb-2">Description</h3>
              <p class="text-sm text-gh-text whitespace-pre-wrap">${escapeHtml(metadata.desc)}</p>
            </div>
            ` : ""}

            <!-- Settings -->
            <div class="bg-gh-bg-secondary rounded-gh p-3">
              <h3 class="text-xs font-semibold text-gh-text-muted uppercase tracking-wider mb-2">Settings</h3>
              <div class="space-y-2">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gh-text-secondary">Muted</span>
                  <span class="text-sm font-medium ${metadata.announce ? "text-gh-warning" : "text-gh-text"}">${metadata.announce ? "Yes (Admins only)" : "No"}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gh-text-secondary">Locked</span>
                  <span class="text-sm font-medium ${metadata.restrict ? "text-gh-warning" : "text-gh-text"}">${metadata.restrict ? "Yes (Admins only)" : "No"}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gh-text-secondary">Join Approval</span>
                  <span class="text-sm font-medium ${metadata.joinApprovalMode ? "text-gh-success" : "text-gh-text"}">${metadata.joinApprovalMode ? "Required" : "Open"}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gh-text-secondary">Who Can Add</span>
                  <span class="text-sm font-medium text-gh-text">${metadata.memberAddMode ? "All Members" : "Admins Only"}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gh-text-secondary">Disappearing</span>
                  <span class="text-sm font-medium text-gh-text">${formatEphemeral(metadata.ephemeralDuration)}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gh-text-secondary">Community</span>
                  <span class="text-sm font-medium ${metadata.isCommunity ? "text-gh-success" : "text-gh-text"}">${metadata.isCommunity ? "Yes" : "No"}</span>
                </div>
              </div>
            </div>

            <!-- ID -->
            <div class="bg-gh-bg-secondary rounded-gh p-3">
              <h3 class="text-xs font-semibold text-gh-text-muted uppercase tracking-wider mb-2">Group ID</h3>
              <p class="text-xs font-mono text-gh-text-secondary break-all">${escapeHtml(metadata.id)}</p>
            </div>
          `;
          groupInfoData.classList.remove("hidden");
        }
      } else {
        if (groupInfoData) {
          groupInfoData.innerHTML = `
            <div class="p-4 text-center">
              <p class="text-sm text-gh-danger">Failed to load group info: ${result.error || "Unknown error"}</p>
            </div>
          `;
          groupInfoData.classList.remove("hidden");
        }
      }
    });
  }

  function formatEphemeral(duration: number | undefined): string {
    if (!duration || duration === 0) return "Off";
    if (duration === 86400) return "24 hours";
    if (duration === 604800) return "7 days";
    if (duration === 7776000) return "90 days";
    return `${duration} seconds`;
  }

  closeGroupInfoModal?.addEventListener("click", () => {
    groupInfoModal?.classList.add("hidden");
  });

  groupInfoModalBackdrop?.addEventListener("click", () => {
    groupInfoModal?.classList.add("hidden");
  });

  // Group Actions Modal
  const groupActionsModal = document.getElementById("group-actions-modal");
  const groupActionsModalBackdrop = document.getElementById("group-actions-modal-backdrop");
  const closeGroupActionsModal = document.getElementById("close-group-actions-modal");
  const groupActionsTitle = document.getElementById("group-actions-title");
  const groupActionsLoading = document.getElementById("group-actions-loading");
  const groupActionsList = document.getElementById("group-actions-list");
  const groupSettingsSection = document.getElementById("group-settings-section");
  const communityActionsSection = document.getElementById("community-actions-section");
  const editSectionTitle = document.getElementById("edit-section-title");

  // Store all groups for the session (used for linking)
  let allSessionGroups: any[] = [];

  function openGroupActionsModal(groupId: string) {
    currentGroupId = groupId;
    groupActionsModal?.classList.remove("hidden");
    groupActionsLoading?.classList.add("hidden");
    groupActionsList?.classList.remove("hidden");

    // Load group metadata to set toggle states and determine if it's a community
    api.sendAction("getGroupMetadata", { sessionId, groupId }).then((result) => {
      if (result.success && result.data) {
        const metadata = result.data as any;
        currentGroupMetadata = metadata;
        const isCommunity = metadata.isCommunity || false;

        if (groupActionsTitle) {
          groupActionsTitle.textContent = `Actions: ${escapeHtml(metadata.subject || (isCommunity ? "Community" : "Group"))}`;
        }

        // Show/hide sections based on whether it's a community
        if (isCommunity) {
          // Hide mute/lock toggles for communities
          groupSettingsSection?.classList.add("hidden");
          // Show community actions
          communityActionsSection?.classList.remove("hidden");
          // Update title
          if (editSectionTitle) editSectionTitle.textContent = "Edit Community";
        } else {
          // Show mute/lock toggles for regular groups
          groupSettingsSection?.classList.remove("hidden");
          // Hide community actions
          communityActionsSection?.classList.add("hidden");
          // Update title
          if (editSectionTitle) editSectionTitle.textContent = "Edit Group";
          // Update toggle states
          updateToggle("toggle-mute", metadata.announce);
          updateToggle("toggle-lock", metadata.restrict);
        }

        // Load all groups for link/unlink functionality
        if (isCommunity) {
          api.sendAction("getGroups", { sessionId }).then((groupsResult) => {
            if (groupsResult.success && groupsResult.data) {
              allSessionGroups = groupsResult.data.groups || [];
            }
          });
        }
      }
    });
  }

  function updateToggle(toggleId: string, isEnabled: boolean) {
    const toggle = document.getElementById(toggleId);
    if (!toggle) return;

    toggle.setAttribute("aria-checked", String(isEnabled));

    if (isEnabled) {
      toggle.classList.remove("bg-gh-bg-tertiary");
      toggle.classList.add("bg-gh-success");
      const span = toggle.querySelector("span");
      if (span) {
        span.classList.remove("translate-x-0");
        span.classList.add("translate-x-5");
      }
    } else {
      toggle.classList.remove("bg-gh-success");
      toggle.classList.add("bg-gh-bg-tertiary");
      const span = toggle.querySelector("span");
      if (span) {
        span.classList.remove("translate-x-5");
        span.classList.add("translate-x-0");
      }
    }
  }

  closeGroupActionsModal?.addEventListener("click", () => {
    groupActionsModal?.classList.add("hidden");
  });

  groupActionsModalBackdrop?.addEventListener("click", () => {
    groupActionsModal?.classList.add("hidden");
  });

  // Handle toggle clicks
  document.getElementById("toggle-mute")?.addEventListener("click", async () => {
    if (!currentGroupId) return;
    const isCurrentlyMuted = currentGroupMetadata?.announce;
    const action = isCurrentlyMuted ? "unmute" : "mute";
    await executeGroupAction(action);
  });

  document.getElementById("toggle-lock")?.addEventListener("click", async () => {
    if (!currentGroupId) return;
    const isCurrentlyLocked = currentGroupMetadata?.restrict;
    const action = isCurrentlyLocked ? "unlock" : "lock";
    await executeGroupAction(action);
  });

  // Handle simple action clicks
  groupActionsList?.addEventListener("click", async (e) => {
    const target = e.target as HTMLElement;
    const actionBtn = target.closest("[data-action]") as HTMLElement | null;
    const paramActionBtn = target.closest("[data-param-action]") as HTMLElement | null;

    if (actionBtn) {
      const action = actionBtn.getAttribute("data-action");
      if (action) {
        if (action === "leave" || action === "kickAll") {
          const confirmed = confirm(
            action === "leave"
              ? "Are you sure you want to leave this group?"
              : "Are you sure you want to kick all non-admin members?"
          );
          if (!confirmed) return;
        }
        await executeGroupAction(action);
      }
    }

    if (paramActionBtn) {
      const action = paramActionBtn.getAttribute("data-param-action");
      if (action) {
        openParamInputModal(action);
      }
    }
  });

  // Execute group action
  async function executeGroupAction(action: string, params?: Record<string, any>) {
    if (!currentGroupId) return;

    groupActionsLoading?.classList.remove("hidden");
    groupActionsList?.classList.add("hidden");

    try {
      const result = await api.sendAction("executeGroupAction", {
        sessionId,
        groupId: currentGroupId,
        action,
        params,
      });

      groupActionsLoading?.classList.add("hidden");
      groupActionsList?.classList.remove("hidden");

      if (result.success && result.data) {
        const actionResult = result.data as any;
        showActionResult(
          actionResult.success ? "Success" : "Failed",
          actionResult.message || "Action completed",
          actionResult.data
        );

        // Refresh metadata after action
        if (actionResult.success) {
          const metaResult = await api.sendAction("getGroupMetadata", {
            sessionId,
            groupId: currentGroupId,
          });
          if (metaResult.success && metaResult.data) {
            currentGroupMetadata = metaResult.data;
            updateToggle("toggle-mute", currentGroupMetadata.announce);
            updateToggle("toggle-lock", currentGroupMetadata.restrict);
          }

          // Auto-refresh groups list after any successful action
          loadGroups();

          // Close modal if group was left
          if (action === "leave") {
            groupActionsModal?.classList.add("hidden");
          }
        }
      } else {
        showActionResult("Error", result.error || "Failed to execute action");
      }
    } catch (error) {
      groupActionsLoading?.classList.add("hidden");
      groupActionsList?.classList.remove("hidden");
      showActionResult("Error", error instanceof Error ? error.message : "Unknown error");
    }
  }

  // Parameter Input Modal
  const paramInputModal = document.getElementById("param-input-modal");
  const paramInputModalBackdrop = document.getElementById("param-input-modal-backdrop");
  const paramInputTitle = document.getElementById("param-input-title");
  const paramInputField = document.getElementById("param-input-field");
  const paramInputError = document.getElementById("param-input-error");
  const paramInputCancel = document.getElementById("param-input-cancel");
  const paramInputExecute = document.getElementById("param-input-execute");

  let currentParamAction: string | null = null;

  function openParamInputModal(action: string) {
    currentParamAction = action;
    paramInputError?.classList.add("hidden");

    const isCommunity = currentGroupMetadata?.isCommunity || false;
    const currentEphemeral = currentGroupMetadata?.ephemeralDuration || 0;

    const configs: Record<string, { title: string; label: string; placeholder: string; type: string; options?: { value: string; label: string }[] }> = {
      name: { title: isCommunity ? "Change Community Name" : "Change Group Name", label: "New Name", placeholder: isCommunity ? "Enter new community name" : "Enter new group name", type: "text" },
      description: { title: "Change Description", label: "New Description", placeholder: "Enter new description", type: "textarea" },
      add: { title: "Add Participant", label: "Phone Number", placeholder: "Search or enter phone number...", type: "participant-search" },
      remove: { title: "Remove Participant", label: "Select Participant", placeholder: "Search by phone number...", type: "participant-search" },
      promote: { title: "Promote to Admin", label: "Select Participant", placeholder: "Search by phone number...", type: "participant-search" },
      demote: { title: "Demote from Admin", label: "Select Admin", placeholder: "Search by phone number...", type: "participant-search" },
      ephemeral: {
        title: "Disappearing Messages",
        label: "Duration",
        placeholder: "",
        type: "select",
        options: [
          { value: "0", label: "Off" },
          { value: "86400", label: "24 hours" },
          { value: "604800", label: "7 days" },
          { value: "7776000", label: "90 days" },
        ],
      },
      linkGroup: { title: "Link Group to Community", label: "Select Group", placeholder: "Select a group to link...", type: "group-select" },
      unlinkGroup: { title: "Unlink Group from Community", label: "Select Group", placeholder: "Select a group to unlink...", type: "group-select" },
    };

    const config = configs[action];
    if (!config) return;

    if (paramInputTitle) paramInputTitle.textContent = config.title;

    if (paramInputField) {
      if (config.type === "participant-search") {
        // Get participants from current group metadata
        const participants = currentGroupMetadata?.participants || [];
        
        // For demote, only show admins; for others show all participants
        let filteredParticipants = participants;
        if (action === "demote") {
          filteredParticipants = participants.filter((p: any) => p.admin === "admin" || p.admin === "superadmin");
        } else if (action === "promote") {
          // For promote, only show non-admins
          filteredParticipants = participants.filter((p: any) => !p.admin || p.admin === null);
        }

        paramInputField.innerHTML = `
          <label class="block text-sm font-medium text-gh-text mb-1">${config.label}</label>
          <div class="relative">
            <div class="relative">
              <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gh-text-muted pointer-events-none" viewBox="0 0 16 16" fill="currentColor">
                <path d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215ZM11.5 7a4.499 4.499 0 1 0-8.997 0A4.499 4.499 0 0 0 11.5 7Z"></path>
              </svg>
              <input
                type="text"
                id="participant-search-input"
                placeholder="${config.placeholder}"
                autocomplete="off"
                class="w-full pl-9 pr-3 py-1.5 text-sm bg-gh-bg border border-gh-border rounded-gh text-gh-text placeholder-gh-text-muted focus:outline-none focus:border-gh-accent focus:ring-1 focus:ring-gh-accent"
              />
            </div>
            <input type="hidden" id="param-input-value" />
            <div id="participant-suggestions" class="absolute z-10 w-full mt-1 bg-gh-bg border border-gh-border rounded-gh shadow-lg max-h-48 overflow-y-auto hidden">
              ${action === "add" ? "" : filteredParticipants.map((p: any) => {
                // Use phoneNumber field if available, otherwise fall back to id
                const rawPhone = p.phoneNumber || p.id || "";
                const phoneNumber = rawPhone.split("@")[0];
                const isAdmin = p.admin === "admin" || p.admin === "superadmin";
                return `
                  <div class="participant-option px-3 py-2 hover:bg-gh-bg-secondary cursor-pointer flex items-center justify-between" data-phone="${escapeHtml(phoneNumber)}">
                    <span class="text-sm text-gh-text">${escapeHtml(phoneNumber)}</span>
                    ${isAdmin ? '<span class="text-xs text-gh-warning px-1.5 py-0.5 bg-gh-warning/10 rounded">Admin</span>' : ''}
                  </div>
                `;
              }).join("")}
            </div>
          </div>
          ${action === "add" ? '<p class="text-xs text-gh-text-muted mt-1">Enter the full phone number with country code</p>' : `<p class="text-xs text-gh-text-muted mt-1">${filteredParticipants.length} participant${filteredParticipants.length !== 1 ? 's' : ''} available</p>`}
        `;

        // Set up search functionality
        setTimeout(() => {
          const searchInput = document.getElementById("participant-search-input") as HTMLInputElement;
          const suggestions = document.getElementById("participant-suggestions");
          const hiddenInput = document.getElementById("param-input-value") as HTMLInputElement;

          if (searchInput && suggestions) {
            // Show suggestions on focus (except for 'add' action)
            searchInput.addEventListener("focus", () => {
              if (action !== "add" && suggestions.children.length > 0) {
                suggestions.classList.remove("hidden");
              }
            });

            // Filter suggestions on input
            searchInput.addEventListener("input", () => {
              const query = searchInput.value.trim().toLowerCase();
              
              if (action === "add") {
                // For add, just use the input value directly
                if (hiddenInput) hiddenInput.value = searchInput.value.trim();
                return;
              }

              const options = suggestions.querySelectorAll(".participant-option");
              let hasVisible = false;

              options.forEach((option) => {
                const phone = option.getAttribute("data-phone") || "";
                if (phone.toLowerCase().includes(query)) {
                  (option as HTMLElement).style.display = "flex";
                  hasVisible = true;
                } else {
                  (option as HTMLElement).style.display = "none";
                }
              });

              if (hasVisible && query.length > 0) {
                suggestions.classList.remove("hidden");
              } else if (query.length === 0) {
                // Show all when empty
                options.forEach((option) => {
                  (option as HTMLElement).style.display = "flex";
                });
                suggestions.classList.remove("hidden");
              }
            });

            // Handle suggestion click
            suggestions.addEventListener("click", (e) => {
              const option = (e.target as HTMLElement).closest(".participant-option");
              if (option) {
                const phone = option.getAttribute("data-phone") || "";
                searchInput.value = phone;
                if (hiddenInput) hiddenInput.value = phone;
                suggestions.classList.add("hidden");
              }
            });

            // Hide suggestions when clicking outside
            document.addEventListener("click", (e) => {
              if (!searchInput.contains(e.target as Node) && !suggestions.contains(e.target as Node)) {
                suggestions.classList.add("hidden");
              }
            });
          }
        }, 0);
      } else if (config.type === "group-select") {
        // For link/unlink group actions
        const communityId = currentGroupId;
        let availableGroups: any[] = [];

        if (action === "linkGroup") {
          // Show groups that are NOT linked to this community
          availableGroups = allSessionGroups.filter((g: any) => 
            !g.isCommunity && g.linkedParent !== communityId && g.id !== communityId
          );
        } else if (action === "unlinkGroup") {
          // Show groups that ARE linked to this community
          availableGroups = allSessionGroups.filter((g: any) => 
            !g.isCommunity && g.linkedParent === communityId
          );
        }

        paramInputField.innerHTML = `
          <label class="block text-sm font-medium text-gh-text mb-1">${config.label}</label>
          <select
            id="param-input-value"
            class="w-full px-3 py-1.5 text-sm bg-gh-bg border border-gh-border rounded-gh text-gh-text focus:outline-none focus:border-gh-accent focus:ring-1 focus:ring-gh-accent"
          >
            <option value="">-- Select a group --</option>
            ${availableGroups.map((g: any) => `<option value="${escapeHtml(g.id)}">${escapeHtml(g.subject)} (${g.participantCount} members)</option>`).join("")}
          </select>
          <p class="text-xs text-gh-text-muted mt-1">${availableGroups.length} group${availableGroups.length !== 1 ? 's' : ''} available</p>
        `;
      } else if (config.type === "select" && config.options) {
        // For ephemeral, default to current value
        const defaultValue = action === "ephemeral" ? String(currentEphemeral) : "";
        paramInputField.innerHTML = `
          <label class="block text-sm font-medium text-gh-text mb-1">${config.label}</label>
          <select
            id="param-input-value"
            class="w-full px-3 py-1.5 text-sm bg-gh-bg border border-gh-border rounded-gh text-gh-text focus:outline-none focus:border-gh-accent focus:ring-1 focus:ring-gh-accent"
          >
            ${config.options.map((opt) => `<option value="${opt.value}"${opt.value === defaultValue ? ' selected' : ''}>${opt.label}</option>`).join("")}
          </select>
        `;
      } else if (config.type === "textarea") {
        paramInputField.innerHTML = `
          <label class="block text-sm font-medium text-gh-text mb-1">${config.label}</label>
          <textarea
            id="param-input-value"
            rows="3"
            placeholder="${config.placeholder}"
            class="w-full px-3 py-1.5 text-sm bg-gh-bg border border-gh-border rounded-gh text-gh-text placeholder-gh-text-muted focus:outline-none focus:border-gh-accent focus:ring-1 focus:ring-gh-accent resize-none"
          ></textarea>
        `;
      } else {
        paramInputField.innerHTML = `
          <label class="block text-sm font-medium text-gh-text mb-1">${config.label}</label>
          <input
            type="${config.type}"
            id="param-input-value"
            placeholder="${config.placeholder}"
            class="w-full px-3 py-1.5 text-sm bg-gh-bg border border-gh-border rounded-gh text-gh-text placeholder-gh-text-muted focus:outline-none focus:border-gh-accent focus:ring-1 focus:ring-gh-accent"
          />
        `;
      }
    }

    paramInputModal?.classList.remove("hidden");
  }

  paramInputCancel?.addEventListener("click", () => {
    paramInputModal?.classList.add("hidden");
    currentParamAction = null;
  });

  paramInputModalBackdrop?.addEventListener("click", () => {
    paramInputModal?.classList.add("hidden");
    currentParamAction = null;
  });

  paramInputExecute?.addEventListener("click", async () => {
    if (!currentParamAction) return;

    // For participant search, check the search input first, then hidden input
    let value: string | undefined;
    const participantActions = ["add", "remove", "promote", "demote"];
    
    if (participantActions.includes(currentParamAction)) {
      const searchInput = document.getElementById("participant-search-input") as HTMLInputElement | null;
      const hiddenInput = document.getElementById("param-input-value") as HTMLInputElement | null;
      value = hiddenInput?.value?.trim() || searchInput?.value?.trim();
    } else {
      const inputEl = document.getElementById("param-input-value") as HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement | null;
      value = inputEl?.value?.trim();
    }

    if (!value && currentParamAction !== "description") {
      if (paramInputError) {
        paramInputError.textContent = "Please enter a value";
        paramInputError.classList.remove("hidden");
      }
      return;
    }

    paramInputModal?.classList.add("hidden");

    const paramMap: Record<string, Record<string, any>> = {
      name: { name: value },
      description: { description: value || "" },
      add: { participant: value },
      remove: { participant: value },
      promote: { participant: value },
      demote: { participant: value },
      ephemeral: { duration: parseInt(value || "0", 10) },
      linkGroup: { targetGroupId: value },
      unlinkGroup: { targetGroupId: value },
    };

    await executeGroupAction(currentParamAction, paramMap[currentParamAction]);
    currentParamAction = null;
  });

  // Action Result Modal
  const actionResultModal = document.getElementById("action-result-modal");
  const actionResultModalBackdrop = document.getElementById("action-result-modal-backdrop");
  const actionResultTitle = document.getElementById("action-result-title");
  const actionResultContent = document.getElementById("action-result-content");
  const actionResultClose = document.getElementById("action-result-close");

  function showActionResult(title: string, message: string, data?: any) {
    if (actionResultTitle) actionResultTitle.textContent = title;
    if (actionResultContent) {
      let content = `<p>${escapeHtml(message)}</p>`;
      if (data && typeof data === "string" && data.includes("chat.whatsapp.com")) {
        content += `<div class="mt-3 p-2 bg-gh-bg-secondary rounded-gh">
          <p class="text-xs text-gh-text-muted mb-1">Invite Link:</p>
          <div class="flex items-center gap-2">
            <a href="${escapeHtml(data)}" target="_blank" rel="noopener noreferrer" class="text-sm text-gh-link break-all flex-1">${escapeHtml(data)}</a>
            <button
              id="copy-invite-link-btn"
              class="p-1.5 text-gh-text-secondary hover:text-gh-text hover:bg-gh-bg-tertiary rounded-gh transition-colors flex-shrink-0"
              data-tooltip="Copy Link"
              data-link="${escapeHtml(data)}"
            >
              <svg id="copy-icon" class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
                <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path>
                <path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
              </svg>
              <svg id="check-icon" class="w-4 h-4 hidden" viewBox="0 0 16 16" fill="currentColor">
                <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
              </svg>
            </button>
          </div>
        </div>`;
      }
      actionResultContent.innerHTML = content;

      // Add click handler for copy button
      const copyBtn = document.getElementById("copy-invite-link-btn");
      const copyIcon = document.getElementById("copy-icon");
      const checkIcon = document.getElementById("check-icon");
      if (copyBtn && copyIcon && checkIcon) {
        copyBtn.addEventListener("click", async () => {
          const link = copyBtn.getAttribute("data-link");
          if (link) {
            try {
              // Use clipboard API with fallback
              if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
                await navigator.clipboard.writeText(link);
              } else {
                // Fallback for non-HTTPS or unsupported browsers
                const textArea = document.createElement("textarea");
                textArea.value = link;
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
              }
              // Show success feedback - swap icons
              copyIcon.classList.add("hidden");
              checkIcon.classList.remove("hidden");
              copyBtn.setAttribute("data-tooltip", "Copied!");
              copyBtn.classList.add("text-gh-success");
              setTimeout(() => {
                copyIcon.classList.remove("hidden");
                checkIcon.classList.add("hidden");
                copyBtn.setAttribute("data-tooltip", "Copy Link");
                copyBtn.classList.remove("text-gh-success");
              }, 3000);
            } catch (err) {
              console.error("Failed to copy:", err);
              // Try fallback on error
              try {
                const textArea = document.createElement("textarea");
                textArea.value = link;
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                // Show success feedback - swap icons
                copyIcon.classList.add("hidden");
                checkIcon.classList.remove("hidden");
                copyBtn.setAttribute("data-tooltip", "Copied!");
                copyBtn.classList.add("text-gh-success");
                setTimeout(() => {
                  copyIcon.classList.remove("hidden");
                  checkIcon.classList.add("hidden");
                  copyBtn.setAttribute("data-tooltip", "Copy Link");
                  copyBtn.classList.remove("text-gh-success");
                }, 3000);
              } catch (fallbackErr) {
                console.error("Fallback copy also failed:", fallbackErr);
              }
            }
          }
        });
      }
    }
    actionResultModal?.classList.remove("hidden");
  }

  actionResultClose?.addEventListener("click", () => {
    actionResultModal?.classList.add("hidden");
  });

  actionResultModalBackdrop?.addEventListener("click", () => {
    actionResultModal?.classList.add("hidden");
  });

  loadGroups();

  // Refresh groups button handler
  const refreshGroupsBtn = document.getElementById("refresh-groups-btn") as HTMLButtonElement | null;
  if (refreshGroupsBtn) {
    refreshGroupsBtn.addEventListener("click", () => {
      refreshGroupsBtn.disabled = true;
      refreshGroupsBtn.classList.add("animate-spin");
      loadGroups();
      setTimeout(() => {
        refreshGroupsBtn.disabled = false;
        refreshGroupsBtn.classList.remove("animate-spin");
      }, 1000);
    });
  }

  const refreshBtn = document.getElementById(
    "refresh-btn"
  ) as HTMLButtonElement | null;
  if (refreshBtn) {
    refreshBtn.addEventListener("click", async () => {
      refreshBtn.disabled = true;
      setTimeout(() => {
        refreshBtn.disabled = false;
      }, 1000);
    });
  }

  const disconnectBtn = document.getElementById("disconnect-btn");
  if (disconnectBtn) {
    disconnectBtn.addEventListener("click", async () => {
      if (!confirm("Disconnect this session?")) {
        return;
      }

      const result = await api.deleteSession(sessionId);
      if (result.success) {
        window.location.href = "/";
      } else {
        alert(result.error || "Failed to disconnect session");
      }
    });
  }

  // Custom Tooltip Handler
  const customTooltip = document.getElementById("custom-tooltip");
  const customTooltipText = document.getElementById("custom-tooltip-text");

  function showCustomTooltip(element: HTMLElement) {
    const tooltipContent = element.getAttribute("data-tooltip");
    if (!tooltipContent || !customTooltip || !customTooltipText) return;

    customTooltipText.textContent = tooltipContent;
    customTooltip.style.opacity = "1";

    // Position the tooltip
    const rect = element.getBoundingClientRect();
    const tooltipRect = customTooltip.getBoundingClientRect();
    
    // Position above the element by default
    let top = rect.top - tooltipRect.height - 8;
    let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);

    // If tooltip would go off the top, position below
    if (top < 8) {
      top = rect.bottom + 8;
    }

    // Keep tooltip within viewport horizontally
    if (left < 8) {
      left = 8;
    } else if (left + tooltipRect.width > window.innerWidth - 8) {
      left = window.innerWidth - tooltipRect.width - 8;
    }

    customTooltip.style.top = `${top}px`;
    customTooltip.style.left = `${left}px`;
  }

  function hideCustomTooltip() {
    if (customTooltip) {
      customTooltip.style.opacity = "0";
    }
  }

  // Add event listeners using event delegation for dynamic elements
  document.addEventListener("mouseenter", (e) => {
    const target = e.target as HTMLElement;
    const tooltipElement = target.closest("[data-tooltip]") as HTMLElement | null;
    if (tooltipElement) {
      showCustomTooltip(tooltipElement);
    }
  }, true);

  document.addEventListener("mouseleave", (e) => {
    const target = e.target as HTMLElement;
    const tooltipElement = target.closest("[data-tooltip]") as HTMLElement | null;
    if (tooltipElement) {
      hideCustomTooltip();
    }
  }, true);

  // Hide tooltip on scroll
  document.addEventListener("scroll", hideCustomTooltip, true);
</script>
