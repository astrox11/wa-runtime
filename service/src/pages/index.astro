---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Whatsaly">
  <!-- Desktop Sidebar (hidden on mobile) -->
  <aside
    id="desktop-sidebar"
    class="hidden lg:flex fixed left-4 top-1/2 -translate-y-1/2 z-50 flex-col gap-2 bg-gh-bg border border-gh-border rounded-gh p-2 shadow-lg"
  >
    <a
      href="https://github.com/astrox11/wa-runtime"
      target="_blank"
      rel="noopener noreferrer"
      class="p-2 text-gh-text-secondary hover:text-gh-text hover:bg-gh-bg-tertiary rounded-gh transition-colors"
      title="View on GitHub"
    >
      <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor">
        <path
          d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"
        ></path>
      </svg>
    </a>
    <button
      id="sidebar-create-session"
      class="p-2 text-gh-text-secondary hover:text-gh-success hover:bg-gh-bg-tertiary rounded-gh transition-colors"
      title="Create New Session"
    >
      <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor">
        <path
          d="m11.28 3.22 4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L13.94 8l-3.72-3.72a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215Zm-6.56 0a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L2.06 8l3.72 3.72a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L.47 8.53a.75.75 0 0 1 0-1.06Z"
        ></path>
      </svg>
    </button>
    <button
      id="sidebar-console"
      class="p-2 text-gh-text-secondary hover:text-gh-text hover:bg-gh-bg-tertiary rounded-gh transition-colors"
      title="View Logs"
    >
      <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor">
        <path
          d="M0 2.75C0 1.784.784 1 1.75 1h12.5c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0 1 14.25 15H1.75A1.75 1.75 0 0 1 0 13.25Zm1.75-.25a.25.25 0 0 0-.25.25v10.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V2.75a.25.25 0 0 0-.25-.25Zm7.25 2a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5h-3a.75.75 0 0 1-.75-.75Zm.75 2.25a.75.75 0 0 0 0 1.5h3a.75.75 0 0 0 0-1.5ZM4.78 6.72a.75.75 0 0 0-1.06 1.06l1.22 1.22-1.22 1.22a.75.75 0 1 0 1.06 1.06l1.75-1.75a.75.75 0 0 0 0-1.06Z"
        ></path>
      </svg>
    </button>
    <div class="h-px bg-gh-border my-1"></div>
    <a
      href="mailto:astrodevwork@gmail.com"
      class="p-2 text-gh-text-secondary hover:text-gh-accent hover:bg-gh-bg-tertiary rounded-gh transition-colors"
      title="Email Support"
    >
      <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor">
        <path
          d="M1.75 2h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 14H1.75A1.75 1.75 0 0 1 0 12.25v-8.5C0 2.784.784 2 1.75 2ZM1.5 12.251c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V5.809L8.38 9.397a.75.75 0 0 1-.76 0L1.5 5.809v6.442Zm13-8.181v-.32a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25v.32L8 7.88Z"
        ></path>
      </svg>
    </a>
    <a
      href="https://github.com/astrox11/wa-runtime/pulls"
      target="_blank"
      rel="noopener noreferrer"
      class="p-2 text-gh-text-secondary hover:text-gh-success hover:bg-gh-bg-tertiary rounded-gh transition-colors"
      title="Contribute"
    >
      <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor">
        <path
          d="M1.5 3.25a2.25 2.25 0 1 1 3 2.122v5.256a2.251 2.251 0 1 1-1.5 0V5.372A2.25 2.25 0 0 1 1.5 3.25Zm5.677-.177L9.573.677A.25.25 0 0 1 10 .854V2.5h1A2.5 2.5 0 0 1 13.5 5v5.628a2.251 2.251 0 1 1-1.5 0V5a1 1 0 0 0-1-1h-1v1.646a.25.25 0 0 1-.427.177L7.177 3.427a.25.25 0 0 1 0-.354ZM3.75 2.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm0 9.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm8.25.75a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Z"
        ></path>
      </svg>
    </a>
  </aside>

  <!-- Mobile Sidebar (fixed bottom bar) -->
  <nav
    id="mobile-sidebar"
    class="lg:hidden fixed bottom-0 left-0 right-0 z-50 bg-gh-bg border-t border-gh-border shadow-lg"
  >
    <div class="flex items-center justify-around py-2 px-4">
      <a
        href="https://github.com/astrox11/wa-runtime"
        target="_blank"
        rel="noopener noreferrer"
        class="flex flex-col items-center p-2 text-gh-text-secondary hover:text-gh-text transition-colors"
        title="GitHub"
      >
        <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"
          ></path>
        </svg>
        <span class="text-[10px] mt-0.5">GitHub</span>
      </a>
      <button
        id="mobile-create-session"
        class="flex flex-col items-center p-2 text-gh-text-secondary hover:text-gh-success transition-colors"
        title="Create Session"
      >
        <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M7.75 2a.75.75 0 0 1 .75.75V7h4.25a.75.75 0 0 1 0 1.5H8.5v4.25a.75.75 0 0 1-1.5 0V8.5H2.75a.75.75 0 0 1 0-1.5H7V2.75A.75.75 0 0 1 7.75 2Z"
          ></path>
        </svg>
        <span class="text-[10px] mt-0.5">Create</span>
      </button>
      <button
        id="mobile-console"
        class="flex flex-col items-center p-2 text-gh-text-secondary hover:text-gh-text transition-colors"
        title="Logs"
      >
        <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M0 2.75C0 1.784.784 1 1.75 1h12.5c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0 1 14.25 15H1.75A1.75 1.75 0 0 1 0 13.25Zm1.75-.25a.25.25 0 0 0-.25.25v10.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V2.75a.25.25 0 0 0-.25-.25Zm7.25 2a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5h-3a.75.75 0 0 1-.75-.75Zm.75 2.25a.75.75 0 0 0 0 1.5h3a.75.75 0 0 0 0-1.5ZM4.78 6.72a.75.75 0 0 0-1.06 1.06l1.22 1.22-1.22 1.22a.75.75 0 1 0 1.06 1.06l1.75-1.75a.75.75 0 0 0 0-1.06Z"
          ></path>
        </svg>
        <span class="text-[10px] mt-0.5">Logs</span>
      </button>
      <a
        href="mailto:astrodevwork@gmail.com"
        class="flex flex-col items-center p-2 text-gh-text-secondary hover:text-gh-accent transition-colors"
        title="Support"
      >
        <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M1.75 2h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 14H1.75A1.75 1.75 0 0 1 0 12.25v-8.5C0 2.784.784 2 1.75 2ZM1.5 12.251c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V5.809L8.38 9.397a.75.75 0 0 1-.76 0L1.5 5.809v6.442Zm13-8.181v-.32a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25v.32L8 7.88Z"
          ></path>
        </svg>
        <span class="text-[10px] mt-0.5">Support</span>
      </a>
      <a
        href="https://github.com/astrox11/wa-runtime/pulls"
        target="_blank"
        rel="noopener noreferrer"
        class="flex flex-col items-center p-2 text-gh-text-secondary hover:text-gh-success transition-colors"
        title="Contribute"
      >
        <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M1.5 3.25a2.25 2.25 0 1 1 3 2.122v5.256a2.251 2.251 0 1 1-1.5 0V5.372A2.25 2.25 0 0 1 1.5 3.25Zm5.677-.177L9.573.677A.25.25 0 0 1 10 .854V2.5h1A2.5 2.5 0 0 1 13.5 5v5.628a2.251 2.251 0 1 1-1.5 0V5a1 1 0 0 0-1-1h-1v1.646a.25.25 0 0 1-.427.177L7.177 3.427a.25.25 0 0 1 0-.354ZM3.75 2.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm0 9.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm8.25.75a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Z"
          ></path>
        </svg>
        <span class="text-[10px] mt-0.5">Contribute</span>
      </a>
    </div>
  </nav>

  <!-- Logs Modal -->
  <div id="logs-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" id="logs-modal-backdrop"></div>
    <div
      class="absolute inset-4 lg:inset-20 bg-gh-bg border border-gh-border rounded-gh shadow-xl flex flex-col"
    >
      <div
        class="p-4 border-b border-gh-border flex items-center justify-between"
      >
        <div class="flex items-center gap-2">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M0 2.75C0 1.784.784 1 1.75 1h12.5c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0 1 14.25 15H1.75A1.75 1.75 0 0 1 0 13.25Zm1.75-.25a.25.25 0 0 0-.25.25v10.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V2.75a.25.25 0 0 0-.25-.25Z"
            ></path>
          </svg>
          <h2 class="text-sm font-semibold text-gh-text">Application Logs</h2>
        </div>
        <button
          id="close-logs-modal"
          class="p-1 text-gh-text-secondary hover:text-gh-text transition-colors"
        >
          <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor">
            <path
              d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"
            ></path>
          </svg>
        </button>
      </div>
      <div
        id="logs-container"
        class="flex-1 p-4 overflow-auto font-mono text-xs text-gh-text-secondary bg-gh-bg-secondary"
      >
        <p class="text-gh-text-muted">Logs will appear here...</p>
      </div>
    </div>
  </div>

  <!-- Create Session Modal -->
  <div id="create-session-modal" class="fixed inset-0 z-50 hidden">
    <div
      class="absolute inset-0 bg-black/50"
      id="create-session-modal-backdrop"
    >
    </div>
    <div
      class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-gh-bg border border-gh-border rounded-gh shadow-xl"
    >
      <div
        class="p-4 border-b border-gh-border flex items-center justify-between"
      >
        <div class="flex items-center gap-2">
          <svg
            class="w-4 h-4 text-gh-success"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M7.75 2a.75.75 0 0 1 .75.75V7h4.25a.75.75 0 0 1 0 1.5H8.5v4.25a.75.75 0 0 1-1.5 0V8.5H2.75a.75.75 0 0 1 0-1.5H7V2.75A.75.75 0 0 1 7.75 2Z"
            ></path>
          </svg>
          <h2 class="text-sm font-semibold text-gh-text">Create New Session</h2>
        </div>
        <button
          id="close-create-modal"
          class="p-1 text-gh-text-secondary hover:text-gh-text transition-colors"
        >
          <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor">
            <path
              d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"
            ></path>
          </svg>
        </button>
      </div>
      <form id="modal-session-form" class="p-4 space-y-4">
        <div>
          <label
            for="modal-phone"
            class="block text-sm font-medium text-gh-text mb-1"
            >Phone Number</label
          >
          <input
            type="tel"
            id="modal-phone"
            name="phoneNumber"
            placeholder="14155551234"
            required
            pattern="[0-9]+"
            class="w-full px-3 py-1.5 text-sm bg-gh-bg border border-gh-border rounded-gh text-gh-text placeholder-gh-text-muted focus:outline-none focus:border-gh-accent focus:ring-1 focus:ring-gh-accent"
          />
          <p class="text-xs text-gh-text-muted mt-1">
            Include country code without + symbol
          </p>
        </div>
        <div>
          <label
            for="modal-botName"
            class="block text-sm font-medium text-gh-text mb-1"
            >Bot Name <span class="text-gh-text-muted font-normal"
              >(optional)</span
            ></label
          >
          <input
            type="text"
            id="modal-botName"
            name="botName"
            placeholder="My Bot"
            class="w-full px-3 py-1.5 text-sm bg-gh-bg border border-gh-border rounded-gh text-gh-text placeholder-gh-text-muted focus:outline-none focus:border-gh-accent focus:ring-1 focus:ring-gh-accent"
          />
        </div>
        <div
          id="modal-error-message"
          class="p-3 rounded-gh bg-gh-danger-subtle border border-gh-danger text-gh-danger text-sm hidden"
        >
        </div>
        <button
          type="submit"
          class="w-full py-2 px-4 text-sm font-medium rounded-gh bg-gh-success text-white hover:bg-green-700 transition-colors"
        >
          Create Session
        </button>
      </form>
    </div>
  </div>

  <main class="max-w-4xl mx-auto px-4 py-8 lg:ml-20 pb-24 lg:pb-8">
    <!-- Hero Section -->
    <div class="text-center mb-8">
      <div class="flex justify-center mb-4">
        <svg
          class="w-16 h-16 text-gh-success"
          viewBox="0 0 24 24"
          fill="currentColor"
        >
          <path
            d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"
          ></path>
        </svg>
      </div>
      <h1 class="text-2xl font-bold text-gh-text mb-2">WA Runtime</h1>
      <p class="text-gh-text-secondary">WhatsApp Multi-Session Runtime</p>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-3 gap-4 mb-8">
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4 text-center">
        <div class="flex justify-center mb-2">
          <svg
            class="w-5 h-5 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M2 5.5a3.5 3.5 0 1 1 5.898 2.549 5.508 5.508 0 0 1 3.034 4.084.75.75 0 1 1-1.482.235 4 4 0 0 0-7.9 0 .75.75 0 0 1-1.482-.236A5.507 5.507 0 0 1 3.102 8.05 3.493 3.493 0 0 1 2 5.5ZM11 4a3.001 3.001 0 0 1 2.22 5.018 5.01 5.01 0 0 1 2.56 3.012.749.749 0 0 1-.885.954.752.752 0 0 1-.549-.514 3.507 3.507 0 0 0-2.522-2.372.75.75 0 0 1-.574-.73v-.352a.75.75 0 0 1 .416-.672A1.5 1.5 0 0 0 11 5.5.75.75 0 0 1 11 4Zm-5.5-.5a2 2 0 1 0-.001 3.999A2 2 0 0 0 5.5 3.5Z"
            ></path>
          </svg>
        </div>
        <p id="stat-sessions" class="text-lg font-semibold text-gh-text">0</p>
        <p class="text-xs text-gh-text-muted">Sessions</p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4 text-center">
        <div class="flex justify-center mb-2">
          <svg
            class="w-5 h-5 text-gh-success"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"
            ></path>
          </svg>
        </div>
        <p id="stat-active" class="text-lg font-semibold text-gh-success">0</p>
        <p class="text-xs text-gh-text-muted">Active</p>
      </div>
      <div class="bg-gh-bg border border-gh-border rounded-gh p-4 text-center">
        <div class="flex justify-center mb-2">
          <svg
            class="w-5 h-5 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M1.75 1h8.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 10.25 10H7.061l-2.574 2.573A1.458 1.458 0 0 1 2 11.543V10h-.25A1.75 1.75 0 0 1 0 8.25v-5.5C0 1.784.784 1 1.75 1Z"
            ></path>
          </svg>
        </div>
        <p id="stat-messages" class="text-lg font-semibold text-gh-text">0</p>
        <p class="text-xs text-gh-text-muted">Messages</p>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Create Session Card -->
      <div class="bg-gh-bg border border-gh-border rounded-gh">
        <div
          class="p-4 border-b border-gh-border flex items-center justify-between cursor-pointer hover:bg-gh-bg-secondary transition-colors"
          id="new-session-header"
        >
          <div class="flex items-center gap-2">
            <svg
              class="w-4 h-4 text-gh-text-secondary"
              viewBox="0 0 16 16"
              fill="currentColor"
            >
              <path
                d="M7.75 2a.75.75 0 0 1 .75.75V7h4.25a.75.75 0 0 1 0 1.5H8.5v4.25a.75.75 0 0 1-1.5 0V8.5H2.75a.75.75 0 0 1 0-1.5H7V2.75A.75.75 0 0 1 7.75 2Z"
              ></path>
            </svg>
            <h2 class="text-sm font-semibold text-gh-text">New Session</h2>
          </div>
          <svg
            id="new-session-chevron"
            class="w-4 h-4 text-gh-text-secondary transition-transform"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"
            ></path>
          </svg>
        </div>

        <div id="new-session-content">
          <!-- Collapsed State -->
          <div id="form-collapsed" class="p-6 text-center">
            <p class="text-sm text-gh-text-secondary mb-4">
              Create a new WhatsApp session to get started
            </p>
            <button
              id="show-form-btn"
              class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-gh bg-gh-success text-white hover:bg-green-700 transition-colors"
            >
              <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
                <path
                  d="M7.75 2a.75.75 0 0 1 .75.75V7h4.25a.75.75 0 0 1 0 1.5H8.5v4.25a.75.75 0 0 1-1.5 0V8.5H2.75a.75.75 0 0 1 0-1.5H7V2.75A.75.75 0 0 1 7.75 2Z"
                ></path>
              </svg>
              Create Session
            </button>
          </div>

          <!-- Expanded Form -->
          <form id="session-form" class="p-4 space-y-4 hidden">
            <div>
              <label
                for="phone"
                class="block text-sm font-medium text-gh-text mb-1"
              >
                <span class="flex items-center gap-2">
                  <svg
                    class="w-4 h-4 text-gh-text-secondary"
                    viewBox="0 0 16 16"
                    fill="currentColor"
                  >
                    <path
                      d="M10.561 8.073a6.005 6.005 0 0 1 3.432 5.142.75.75 0 1 1-1.498.07 4.5 4.5 0 0 0-8.99 0 .75.75 0 0 1-1.498-.07 6.004 6.004 0 0 1 3.431-5.142 3.999 3.999 0 1 1 5.123 0ZM10.5 5a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"
                    ></path>
                  </svg>
                  Phone Number
                </span>
              </label>
              <input
                type="tel"
                id="phone"
                name="phoneNumber"
                placeholder="14155551234"
                required
                pattern="[0-9]+"
                class="w-full px-3 py-1.5 text-sm bg-gh-bg border border-gh-border rounded-gh text-gh-text placeholder-gh-text-muted focus:outline-none focus:border-gh-accent focus:ring-1 focus:ring-gh-accent"
              />
              <p class="text-xs text-gh-text-muted mt-1">
                Include country code without + symbol
              </p>
            </div>

            <div>
              <label
                for="botName"
                class="block text-sm font-medium text-gh-text mb-1"
              >
                <span class="flex items-center gap-2">
                  <svg
                    class="w-4 h-4 text-gh-text-secondary"
                    viewBox="0 0 16 16"
                    fill="currentColor"
                  >
                    <path
                      d="M11.93 8.5a4.002 4.002 0 0 1-7.86 0H.75a.75.75 0 0 1 0-1.5h3.32a4.002 4.002 0 0 1 7.86 0h3.32a.75.75 0 0 1 0 1.5Zm-1.43-.75a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"
                    ></path>
                  </svg>
                  Bot Name
                  <span class="text-gh-text-muted font-normal">(optional)</span>
                </span>
              </label>
              <div class="relative">
                <input
                  type="text"
                  id="botName"
                  name="botName"
                  placeholder="My Bot"
                  class="w-full px-3 py-1.5 pr-8 text-sm bg-gh-bg border border-gh-border rounded-gh text-gh-text placeholder-gh-text-muted focus:outline-none focus:border-gh-accent focus:ring-1 focus:ring-gh-accent"
                />
                <button
                  type="button"
                  id="clear-botname"
                  class="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-gh-text-muted hover:text-gh-danger transition-colors hidden"
                  title="Clear"
                >
                  <svg
                    class="w-3.5 h-3.5"
                    viewBox="0 0 16 16"
                    fill="currentColor"
                  >
                    <path
                      d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Custom Variables -->
            <div>
              <div class="flex items-center justify-between mb-1">
                <label class="block text-sm font-medium text-gh-text">
                  <span class="flex items-center gap-2">
                    <svg
                      class="w-4 h-4 text-gh-text-secondary"
                      viewBox="0 0 16 16"
                      fill="currentColor"
                    >
                      <path
                        d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Z"
                      ></path>
                    </svg>
                    Custom Variables
                    <span class="text-gh-text-muted font-normal"
                      >(optional)</span
                    >
                  </span>
                </label>
                <button
                  type="button"
                  id="add-var-btn"
                  class="text-xs text-gh-link hover:underline flex items-center gap-1"
                >
                  <svg class="w-3 h-3" viewBox="0 0 16 16" fill="currentColor">
                    <path
                      d="M7.75 2a.75.75 0 0 1 .75.75V7h4.25a.75.75 0 0 1 0 1.5H8.5v4.25a.75.75 0 0 1-1.5 0V8.5H2.75a.75.75 0 0 1 0-1.5H7V2.75A.75.75 0 0 1 7.75 2Z"
                    ></path>
                  </svg>
                  Add
                </button>
              </div>
              <div id="custom-vars" class="space-y-2">
                <!-- Custom variables will be added here -->
              </div>
            </div>

            <div class="flex gap-2">
              <button
                type="button"
                id="cancel-form-btn"
                class="flex-1 py-1.5 px-4 text-sm font-medium rounded-gh bg-gh-bg-secondary border border-gh-border text-gh-text hover:bg-gh-bg-tertiary transition-colors"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="flex-1 py-1.5 px-4 text-sm font-medium rounded-gh bg-gh-success text-white hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Create Session
              </button>
            </div>
          </form>

          <div
            id="error-message"
            class="mx-4 mb-4 p-3 rounded-gh bg-gh-danger-subtle border border-gh-danger text-gh-danger text-sm hidden"
          >
          </div>
        </div>
        <!-- End new-session-content -->
      </div>
    </div>

    <!-- Existing Sessions -->
    <div class="mt-6 bg-gh-bg border border-gh-border rounded-gh">
      <div
        class="p-4 border-b border-gh-border flex items-center justify-between cursor-pointer hover:bg-gh-bg-secondary transition-colors"
        id="sessions-header"
      >
        <div class="flex items-center gap-2">
          <svg
            class="w-4 h-4 text-gh-text-secondary"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Zm7.251 10.324.004-5.073-.002-2.253A2.25 2.25 0 0 0 5.003 2.5H1.5v9h3.757a3.75 3.75 0 0 1 1.994.574ZM8.755 4.75l-.004 7.322a3.752 3.752 0 0 1 1.992-.572H14.5v-9h-3.495a2.25 2.25 0 0 0-2.25 2.25Z"
            ></path>
          </svg>
          <h2 class="text-sm font-semibold text-gh-text">Sessions</h2>
          <span id="session-count" class="text-xs text-gh-text-muted"
            >Loading...</span
          >
        </div>
        <div class="flex items-center gap-2">
          <svg
            id="sessions-chevron"
            class="w-4 h-4 text-gh-text-secondary transition-transform"
            viewBox="0 0 16 16"
            fill="currentColor"
          >
            <path
              d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"
            ></path>
          </svg>
        </div>
      </div>
      <div id="sessions-list" class="divide-y divide-gh-border">
        <!-- Skeleton loaders -->
        <div class="flex items-center justify-between p-3">
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 bg-gh-bg-tertiary rounded animate-pulse"></div>
            <div class="w-32 h-4 bg-gh-bg-tertiary rounded animate-pulse"></div>
          </div>
          <div class="flex items-center gap-1">
            <div class="w-8 h-8 bg-gh-bg-tertiary rounded animate-pulse"></div>
            <div class="w-8 h-8 bg-gh-bg-tertiary rounded animate-pulse"></div>
          </div>
        </div>
        <div class="flex items-center justify-between p-3">
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 bg-gh-bg-tertiary rounded animate-pulse"></div>
            <div class="w-24 h-4 bg-gh-bg-tertiary rounded animate-pulse"></div>
          </div>
          <div class="flex items-center gap-1">
            <div class="w-8 h-8 bg-gh-bg-tertiary rounded animate-pulse"></div>
            <div class="w-8 h-8 bg-gh-bg-tertiary rounded animate-pulse"></div>
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  import { api } from "../lib/api";

  const form = document.getElementById("session-form") as HTMLFormElement;
  const formCollapsed = document.getElementById(
    "form-collapsed"
  ) as HTMLDivElement;
  const errorDiv = document.getElementById("error-message") as HTMLDivElement;
  const sessionsList = document.getElementById(
    "sessions-list"
  ) as HTMLDivElement;
  const sessionCount = document.getElementById(
    "session-count"
  ) as HTMLSpanElement;
  const showFormBtn = document.getElementById(
    "show-form-btn"
  ) as HTMLButtonElement;
  const cancelFormBtn = document.getElementById(
    "cancel-form-btn"
  ) as HTMLButtonElement;
  const botNameInput = document.getElementById("botName") as HTMLInputElement;
  const clearBotnameBtn = document.getElementById(
    "clear-botname"
  ) as HTMLButtonElement;
  const customVarsContainer = document.getElementById(
    "custom-vars"
  ) as HTMLDivElement;
  const addVarBtn = document.getElementById("add-var-btn") as HTMLButtonElement;

  let formExpanded = false;
  let sessionsLoaded = false;
  let varCounter = 0;

  function addCustomVar(name = "", value = "") {
    const varId = ++varCounter;
    const varHtml = `
      <div class="flex gap-2 items-center" data-var-id="${varId}">
        <input 
          type="text" 
          placeholder="Key" 
          value="${name}"
          class="flex-1 px-3 py-1.5 text-sm bg-gh-bg border border-gh-border rounded-gh text-gh-text placeholder-gh-text-muted focus:outline-none focus:border-gh-accent focus:ring-1 focus:ring-gh-accent"
          data-var-key="${varId}"
        />
        <input 
          type="text" 
          placeholder="Value" 
          value="${value}"
          class="flex-1 px-3 py-1.5 text-sm bg-gh-bg border border-gh-border rounded-gh text-gh-text placeholder-gh-text-muted focus:outline-none focus:border-gh-accent focus:ring-1 focus:ring-gh-accent"
          data-var-value="${varId}"
        />
        <button type="button" class="p-1.5 text-gh-text-muted hover:text-gh-danger transition-colors" data-remove-var="${varId}" title="Remove">
          <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
            <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"/>
          </svg>
        </button>
      </div>
    `;
    customVarsContainer.insertAdjacentHTML("beforeend", varHtml);

    // Add event listener for remove button
    const removeBtn = customVarsContainer.querySelector(
      `[data-remove-var="${varId}"]`
    );
    removeBtn?.addEventListener("click", () => removeCustomVar(varId));
  }

  function removeCustomVar(varId: number) {
    const varEl = customVarsContainer.querySelector(`[data-var-id="${varId}"]`);
    varEl?.remove();
  }

  function getCustomVars(): Record<string, string> {
    const vars: Record<string, string> = {};
    const varElements = customVarsContainer.querySelectorAll("[data-var-id]");
    varElements.forEach((el) => {
      const varId = el.getAttribute("data-var-id");
      const keyInput = el.querySelector(
        `[data-var-key="${varId}"]`
      ) as HTMLInputElement;
      const valueInput = el.querySelector(
        `[data-var-value="${varId}"]`
      ) as HTMLInputElement;
      if (keyInput?.value && valueInput?.value) {
        vars[keyInput.value] = valueInput.value;
      }
    });
    return vars;
  }

  addVarBtn.addEventListener("click", () => addCustomVar());

  function showForm() {
    formExpanded = true;
    form.classList.remove("hidden");
    formCollapsed.classList.add("hidden");
  }

  function hideForm() {
    formExpanded = false;
    form.classList.add("hidden");
    formCollapsed.classList.remove("hidden");
  }

  showFormBtn.addEventListener("click", showForm);
  cancelFormBtn.addEventListener("click", hideForm);

  // Clear button visibility
  botNameInput.addEventListener("input", () => {
    clearBotnameBtn.classList.toggle("hidden", !botNameInput.value);
  });

  clearBotnameBtn.addEventListener("click", () => {
    botNameInput.value = "";
    clearBotnameBtn.classList.add("hidden");
  });

  async function deleteSession(id: string) {
    if (!confirm("Delete this session?")) return;

    const result = await api.deleteSession(id);
    if (!result.success) {
      alert(result.error || "Failed to delete session");
    }
  }

  function renderSessions(
    sessions: Array<{
      id: string;
      phone_number: string;
      created_at: number;
      status: string;
      user_info: {
        id: string;
        lid: string;
        name: string;
      };
    }>
  ) {
    console.log(sessions.length, "sessions");
    console.log(JSON.stringify(sessions, null, 2));

    sessionsLoaded = true;

    if (!sessionsList) return;

    if (!sessionCount) return;

    sessionCount.textContent = `${sessions.length} session${sessions.length !== 1 ? "s" : ""}`;

    if (sessions.length === 0) {
      sessionsList.innerHTML = `
        <div class="p-6 text-center">
          <svg class="w-12 h-12 mx-auto mb-3 text-gh-text-muted" viewBox="0 0 16 16" fill="currentColor">
            <path d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Z"/>
          </svg>
          <p class="text-sm text-gh-text-secondary mb-1">No sessions yet</p>
          <p class="text-xs text-gh-text-muted">Create your first session to get started</p>
        </div>
      `;
      return;
    }

    sessionsList.innerHTML = sessions
      .map((session) => {
        const displayName =
          session?.user_info?.name || `+${session.phone_number}`;

        let statusIcon = "";

        if (session.status === "active") {
          statusIcon = `<svg class="w-4 h-4 text-gh-success" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"/>
          </svg>`;
        } else if (session.status === "pairing" || session.status === "connecting") {
          statusIcon = `<svg class="w-4 h-4 text-amber-600 animate-spin" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="8" cy="8" r="6" stroke-dasharray="28" stroke-dashoffset="7"/>
          </svg>`;
        } else if (session.status === "paused_user") {
          statusIcon = `<svg class="w-4 h-4 text-amber-500" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM5.5 4.5A1.5 1.5 0 0 0 4 6v4a1.5 1.5 0 0 0 3 0V6a1.5 1.5 0 0 0-1.5-1.5Zm5 0A1.5 1.5 0 0 0 9 6v4a1.5 1.5 0 0 0 3 0V6a1.5 1.5 0 0 0-1.5-1.5Z"/>
          </svg>`;
        } else {
          statusIcon = `<svg class="w-4 h-4 text-gh-danger" viewBox="0 0 16 16" fill="currentColor">
            <path d="M2.343 13.657A8 8 0 1 1 13.658 2.343 8 8 0 0 1 2.343 13.657ZM6.03 4.97a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042L6.94 8 4.97 9.97a.749.749 0 0 0 .326 1.275.749.749 0 0 0 .734-.215L8 9.06l1.97 1.97a.749.749 0 0 0 1.275-.326.749.749 0 0 0-.215-.734L9.06 8l1.97-1.97a.749.749 0 0 0-.326-1.275.749.749 0 0 0-.734.215L8 6.94Z"/>
          </svg>`;
        }

        return `
        <div class="flex items-center justify-between p-3 hover:bg-gh-bg-secondary transition-colors" data-id="${session.id}">
          <div class="flex items-center gap-3">
            ${statusIcon}
            <span class="text-sm font-medium text-gh-text">${displayName}</span>
          </div>
          <div class="flex items-center gap-1">
            ${
              session.status === "active"
                ? `
              <a href="/dashboard/${session.id}" class="p-1.5 text-gh-text-secondary hover:text-gh-success hover:bg-gh-bg-tertiary rounded-gh transition-colors" title="View Dashboard">
                <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"/>
                </svg>
              </a>
              <button class="p-1.5 text-gh-text-secondary hover:text-amber-600 hover:bg-gh-bg-tertiary rounded-gh transition-colors" data-pause-session="${session.id}" title="Pause Session">
                <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5Zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5Z"/>
                </svg>
              </button>
            `
                : session.status === "pairing"
                  ? `
              <a href="/pairing/${session.id}" class="p-1.5 text-gh-text-secondary hover:text-gh-success hover:bg-gh-bg-tertiary rounded-gh transition-colors" title="Continue Pairing">
                <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm4.879-2.773 4.264 2.559a.25.25 0 0 1 0 .428l-4.264 2.559A.25.25 0 0 1 6 10.559V5.442a.25.25 0 0 1 .379-.215Z"/>
                </svg>
              </a>
            `
                  : session.status === "connecting"
                    ? `
              <span class="p-1.5 text-gh-text-muted" title="Connecting...">
                <svg class="w-4 h-4 animate-spin" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="8" cy="8" r="6" stroke-dasharray="28" stroke-dashoffset="7"/>
                </svg>
              </span>
            `
                    : `
              <button class="p-1.5 text-gh-text-secondary hover:text-gh-success hover:bg-gh-bg-tertiary rounded-gh transition-colors" data-resume-session="${session.id}" title="Resume Session">
                <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm4.879-2.773 4.264 2.559a.25.25 0 0 1 0 .428l-4.264 2.559A.25.25 0 0 1 6 10.559V5.442a.25.25 0 0 1 .379-.215Z"/>
                </svg>
              </button>
            `
            }
            <button class="p-1.5 text-gh-text-secondary hover:text-gh-danger hover:bg-gh-danger-subtle rounded-gh transition-colors" data-delete-session="${session.id}" title="Delete">
              <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
                <path d="M11 1.75V3h2.25a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1 0-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75ZM4.496 6.675l.66 6.6a.25.25 0 0 0 .249.225h5.19a.25.25 0 0 0 .249-.225l.66-6.6a.75.75 0 0 1 1.492.149l-.66 6.6A1.748 1.748 0 0 1 10.595 15h-5.19a1.75 1.75 0 0 1-1.741-1.575l-.66-6.6a.75.75 0 1 1 1.492-.15ZM6.5 1.75V3h3V1.75a.25.25 0 0 0-.25-.25h-2.5a.25.25 0 0 0-.25.25Z"/>
              </svg>
            </button>
          </div>
        </div>
      `;
      })
      .join("");
  }

  const pendingActions = new Set<string>();

  sessionsList?.addEventListener("click", async (e) => {
    const target = e.target as HTMLElement;
    const button = target.closest(
      "[data-delete-session], [data-pause-session], [data-resume-session]"
    ) as HTMLElement | null;
    if (!button) return;

    const deleteId = button.getAttribute("data-delete-session");
    const pauseId = button.getAttribute("data-pause-session");
    const resumeId = button.getAttribute("data-resume-session");

    if (deleteId) {
      deleteSession(deleteId);
      return;
    }

    if (pauseId) {
      if (pendingActions.has(`pause-${pauseId}`)) return;
      pendingActions.add(`pause-${pauseId}`);
      console.log("Pausing session:", pauseId);

      try {
        const result = await api.sendAction("pauseSession", { id: pauseId });
        if (result.success) {
          console.log("Session paused successfully");
        } else {
          console.error("Failed to pause session:", result.error);
          alert(`Failed to pause session: ${result.error}`);
        }
      } catch (error) {
        console.error("Error pausing session:", error);
        alert("Failed to pause session");
      } finally {
        pendingActions.delete(`pause-${pauseId}`);
      }
      return;
    }

    if (resumeId) {
      if (pendingActions.has(`resume-${resumeId}`)) return;
      pendingActions.add(`resume-${resumeId}`);
      console.log("Resuming session:", resumeId);

      try {
        const result = await api.sendAction("resumeSession", { id: resumeId });
        if (result.success) {
          console.log("Session resumed successfully");
        } else {
          console.error("Failed to resume session:", result.error);
          alert(`Failed to resume session: ${result.error}`);
        }
      } catch (error) {
        console.error("Error resuming session:", error);
        alert("Failed to resume session");
      } finally {
        pendingActions.delete(`resume-${resumeId}`);
      }
      return;
    }
  });

  function updateStats(overall: {
    totalSessions: number;
    activeSessions: number;
    totalMessages: number;
  }) {
    const statSessions = document.getElementById("stat-sessions");
    const statActive = document.getElementById("stat-active");
    const statMessages = document.getElementById("stat-messages");

    if (statSessions)
      statSessions.textContent = overall.totalSessions.toString();
    if (statActive) statActive.textContent = overall.activeSessions.toString();
    if (statMessages)
      statMessages.textContent = overall.totalMessages.toLocaleString();
  }

  // Subscribe to real-time updates via WebSocket
  api.onStats((data) => {
    console.log(JSON.stringify(data, null, 2));

    if (data && data.type === "stats" && data.data) {
      if (data.data.overall) {
        updateStats(data.data.overall);
      }
      const sessionsData = data.data.sessions;
      if (sessionsData && Array.isArray(sessionsData)) {
        console.log("Rendering", sessionsData.length, "sessions");
        renderSessions(
          sessionsData.map((s: any) => ({
            id: s.id,
            phone_number: s.phone_number,
            created_at: s.created_at,
            status: s.status,
            user_info: s.user_info,
          }))
        );
      }
    }
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const phoneInput = document.getElementById("phone") as HTMLInputElement;
    const phoneNumber = phoneInput.value.replace(/\D/g, "");

    if (!phoneNumber) {
      showError("Please enter a valid phone number");
      return;
    }

    const submitBtn = form.querySelector(
      'button[type="submit"]'
    ) as HTMLButtonElement;
    submitBtn.disabled = true;
    submitBtn.textContent = "Creating...";
    hideError();

    const result = await api.createSession(phoneNumber);

    if (result.success && result.data) {
      window.location.href = `/pairing/${result.data.id}?code=${result.data.code}`;
    } else {
      showError(result.error || "Failed to create session");
      submitBtn.disabled = false;
      submitBtn.textContent = "Create Session";
    }
  });

  function showError(message: string) {
    errorDiv.textContent = message;
    errorDiv.classList.remove("hidden");
  }

  function hideError() {
    errorDiv.classList.add("hidden");
  }

  // Sessions section collapse functionality
  const sessionsHeader = document.getElementById("sessions-header");
  const sessionsChevron = document.getElementById("sessions-chevron");
  let sessionsCollapsed = false;

  sessionsHeader?.addEventListener("click", () => {
    sessionsCollapsed = !sessionsCollapsed;
    if (sessionsCollapsed) {
      sessionsList?.classList.add("hidden");
      sessionsChevron?.classList.add("-rotate-90");
    } else {
      sessionsList?.classList.remove("hidden");
      sessionsChevron?.classList.remove("-rotate-90");
    }
  });

  // New Session section collapse functionality
  const newSessionHeader = document.getElementById("new-session-header");
  const newSessionContent = document.getElementById("new-session-content");
  const newSessionChevron = document.getElementById("new-session-chevron");
  let newSessionCollapsed = false;

  newSessionHeader?.addEventListener("click", () => {
    newSessionCollapsed = !newSessionCollapsed;
    if (newSessionCollapsed) {
      newSessionContent?.classList.add("hidden");
      newSessionChevron?.classList.add("-rotate-90");
    } else {
      newSessionContent?.classList.remove("hidden");
      newSessionChevron?.classList.remove("-rotate-90");
    }
  });

  const mobileCreateSession = document.getElementById("mobile-create-session");
  const mobileConsole = document.getElementById("mobile-console");

  mobileCreateSession?.addEventListener("click", () => {
    createModal?.classList.remove("hidden");
  });

  mobileConsole?.addEventListener("click", () => {
    logsModal?.classList.remove("hidden");
    updateLogsDisplay();
  });

  const logsModal = document.getElementById("logs-modal");
  const logsModalBackdrop = document.getElementById("logs-modal-backdrop");
  const closeLogsModal = document.getElementById("close-logs-modal");
  const sidebarConsole = document.getElementById("sidebar-console");
  const logsContainer = document.getElementById("logs-container");

  const appLogs: string[] = [];
  const MAX_LOGS = 100;

  function addLog(message: string) {
    const timestamp = new Date().toISOString().slice(11, 23);
    appLogs.push(`[${timestamp}] ${message}`);
    if (appLogs.length > MAX_LOGS) appLogs.shift();
    updateLogsDisplay();
  }

  function updateLogsDisplay() {
    if (logsContainer) {
      logsContainer.innerHTML =
        appLogs.length > 0
          ? appLogs.map((log) => `<div class="py-0.5">${log}</div>`).join("")
          : '<p class="text-gh-text-muted">No logs yet...</p>';
      logsContainer.scrollTop = logsContainer.scrollHeight;
    }
  }

  // Override console.log to capture logs
  const originalConsoleLog = console.log;
  console.log = (...args: unknown[]) => {
    originalConsoleLog(...args);
    const message = args
      .map((arg) =>
        typeof arg === "object" ? JSON.stringify(arg) : String(arg)
      )
      .join(" ");
    if (message.includes("[Whatsaly]")) {
      addLog(message);
    }
  };

  sidebarConsole?.addEventListener("click", () => {
    logsModal?.classList.remove("hidden");
    updateLogsDisplay();
  });

  closeLogsModal?.addEventListener("click", () => {
    logsModal?.classList.add("hidden");
  });

  logsModalBackdrop?.addEventListener("click", () => {
    logsModal?.classList.add("hidden");
  });

  // Create session modal functionality
  const createModal = document.getElementById("create-session-modal");
  const createModalBackdrop = document.getElementById(
    "create-session-modal-backdrop"
  );
  const closeCreateModal = document.getElementById("close-create-modal");
  const sidebarCreateSession = document.getElementById(
    "sidebar-create-session"
  );
  const modalForm = document.getElementById(
    "modal-session-form"
  ) as HTMLFormElement;
  const modalErrorDiv = document.getElementById("modal-error-message");

  sidebarCreateSession?.addEventListener("click", () => {
    createModal?.classList.remove("hidden");
  });

  closeCreateModal?.addEventListener("click", () => {
    createModal?.classList.add("hidden");
  });

  createModalBackdrop?.addEventListener("click", () => {
    createModal?.classList.add("hidden");
  });

  modalForm?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const phoneInput = document.getElementById(
      "modal-phone"
    ) as HTMLInputElement | null;
    if (!phoneInput) return;

    const phoneNumber = phoneInput.value.replace(/\D/g, "");

    if (!phoneNumber) {
      if (modalErrorDiv) {
        modalErrorDiv.textContent = "Please enter a valid phone number";
        modalErrorDiv.classList.remove("hidden");
      }
      return;
    }

    const submitBtn = modalForm.querySelector(
      'button[type="submit"]'
    ) as HTMLButtonElement | null;
    if (!submitBtn) return;

    submitBtn.disabled = true;
    submitBtn.textContent = "Creating...";
    modalErrorDiv?.classList.add("hidden");

    const result = await api.createSession(phoneNumber);

    if (result.success && result.data) {
      window.location.href = `/pairing/${result.data.id}?code=${result.data.code}`;
    } else {
      if (modalErrorDiv) {
        modalErrorDiv.textContent = result.error || "Failed to create session";
        modalErrorDiv.classList.remove("hidden");
      }
      submitBtn.disabled = false;
      submitBtn.textContent = "Create Session";
    }
  });

  // Add initial log
  addLog("Application initialized");
</script>
